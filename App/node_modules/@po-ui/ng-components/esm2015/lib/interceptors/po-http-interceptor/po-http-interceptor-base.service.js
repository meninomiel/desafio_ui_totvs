import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
// DEPRECATED 4.x.x
const NO_ERROR_HEADER_PARAM = 'X-PO-No-Error';
const NO_MESSAGE_HEADER_PARAM = 'X-PO-No-Message';
/**
 * @description
 *
 * O *interceptor* tem a finalidade de exibir notificações com mensagens na tela, baseado nas respostas das requisições HTTP.
 *
 * Pode ser utilizado para dar feedback das ações do usuário como, por exemplo: erro de autorização, mensagens de regras de negócio,
 * atualizações de registros, erro quando o servidor estiver indisponível e entre outros.
 *
 * ## Configuração
 *
 * Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o `BrowserAnimationsModule` no
 * módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@po-ui/ng-components';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * ## Como usar
 *
 * Para exibir as noticações é necessário informar a mensagem no retorno da requisição. A estrutura da mensagem
 * é feita com base no status da resposta, conforme será apresentado nos próximos tópicos.
 *
 * ### Estrutura das mensagens
 *
 * #### Mensagens de sucesso `2xx`
 *
 * Para exibir mensagens ao retornar uma lista ou um item, deve-se incluir a propriedade `_messages` no objeto de retorno.
 * Por exemplo:
 * ```
 * {
 *   "_messages": [
 *     {
 *       "type": "success" || "warning" || "error" || "information" (será exibido a `tag` apenas se esta propriedade possuir valor),
 *       "code": "título ou código da mensagem",
 *       "message": "texto da mensagem",
 *       "detailedMessage": "detalhamento da mensagem"
 *     }
 *   ]
 * }
 * ```
 *
 * #### Mensagens de erro `4xx` ou `5xx`
 *
 * Ao retornar erro, o objeto não necessita ter `_messages`, deve-se retornar o objeto diretamente:
 *
 * ```
 * {
 *    "code": "título ou código da mensagem",
 *    "message": "texto da mensagem",
 *    "detailedMessage": "detalhamento da mensagem"
 * }
 * ```
 *
 * Também é possível informar as seguintes propriedades:
 *
 * - `helpUrl`: link para a documentação do erro;
 *    - Caso for informado, será exibido uma ação de "Ajuda" na notificação, para isso não deverá ter a propriedade `detailedMessage`.
 * - `details`: Uma lista de objetos de mensagem (recursiva) com mais detalhes sobre a mensagem principal.
 *
 * > Veja o [Guia de implementação de APIs](guides/api) para mais detalhes sobre a estrutura das mensagens.
 *
 * ### Cabeçalho
 *
 * É possível dispensar a notificação para o usuário utilizando no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-PO-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - **Depreciado** `X-PO-No-Error`: não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * > Após a validação no *interceptor*, os parâmetros serão removidos do cabeçalho da requisição.
 *
 */
export class PoHttpInterceptorBaseService {
    constructor(componentInjector, notification) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
        this.httpInterceptorDetailComponent = undefined;
    }
    intercept(request, next) {
        const cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap((response) => {
            if (response instanceof HttpResponse) {
                this.processResponse(response, cloneRequest);
            }
        }, (error) => {
            this.processErrorResponse(error, cloneRequest);
        }));
    }
    processResponse(response, request) {
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            const messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach((message) => {
                    this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    }
    processErrorResponse(response, request) {
        const errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: 'Servidor não está respondendo.', detailedMessage: response.message };
        const hasNoErrorParam = this.hasNoErrorParam(request);
        const hasNoMessageParam = this.hasNoMessageParam(request);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification(Object.assign(Object.assign({}, errorResponse), { type: 'error' }));
        }
    }
    cloneRequestWithoutParameters(request) {
        const headers = request.headers.delete(NO_ERROR_HEADER_PARAM).delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers });
    }
    createModal(responseMessage) {
        const details = responseMessage.details ? [responseMessage, ...responseMessage.details] : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(() => this.destroyModal());
        this.httpInterceptorDetailComponent.instance.open();
    }
    destroyModal() {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    }
    hasMessage(responseMessage) {
        const hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    }
    hasNoErrorParam(request) {
        const noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    }
    hasNoMessageParam(request) {
        const noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    }
    hasParameters(request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    }
    showNotification(response) {
        if (!this.hasMessage(response)) {
            return;
        }
        const typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        const notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    }
    generateDetailModal(responseMessage) {
        return () => {
            if (!this.httpInterceptorDetailComponent) {
                this.createModal(responseMessage);
            }
        };
    }
    generateNotificationAction(responseMessage) {
        let notificationAction;
        let notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = 'Ajuda';
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = 'Detalhes';
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    }
    generateUrlHelpFunction(helpUrl) {
        return () => {
            window.open(helpUrl, '_blank');
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1pbnRlcmNlcHRvci9wby1odHRwLWludGVyY2VwdG9yLWJhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBSUwsWUFBWSxFQUdiLE1BQU0sc0JBQXNCLENBQUM7QUFHOUIsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXJDLE9BQU8sRUFBRSxnQ0FBZ0MsRUFBRSxNQUFNLG1FQUFtRSxDQUFDO0FBRXJILG1CQUFtQjtBQUNuQixNQUFNLHFCQUFxQixHQUFHLGVBQWUsQ0FBQztBQUM5QyxNQUFNLHVCQUF1QixHQUFHLGlCQUFpQixDQUFDO0FBRWxEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBNEhHO0FBQ0gsTUFBTSxPQUFnQiw0QkFBNEI7SUFLaEQsWUFBb0IsaUJBQTZDLEVBQVUsWUFBaUI7UUFBeEUsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUE0QjtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUFLO1FBSjVGLHNCQUFpQixHQUFHLENBQUMsU0FBUyxFQUFFLFNBQVMsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLENBQUM7UUFFM0QsbUNBQThCLEdBQW1ELFNBQVMsQ0FBQztJQUVKLENBQUM7SUFFaEcsU0FBUyxDQUFDLE9BQXlCLEVBQUUsSUFBaUI7UUFDcEQsTUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXJDLE9BQU8sR0FBRyxPQUFPLElBQUksSUFBSSxDQUFDLGFBQWEsQ0FBQyxP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QUFlLENBQUMsT0FBTyxFQUFFO1lBQ3JFLGlCQUFpQixHQUFHLFVBQVUsQ0FBQztZQUMvQixrQkFBa0IsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsZUFBZSxDQUFDLENBQUM7U0FDaEU7UUFDRCxPQUFPLEVBQUUsS0FBSyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sRUFBRSxrQkFBa0IsRUFBRSxDQUFDO0lBQ2xFLENBQUM7SUFFTyx1QkFBdUIsQ0FBQyxPQUFlO1FBQzdDLE9BQU8sR0FBRyxFQUFFO1lBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsUUFBUSxDQUFDLENBQUM7UUFDakMsQ0FBQyxDQUFDO0lBQ0osQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBIdHRwSW50ZXJjZXB0b3IsXG4gIEh0dHBIYW5kbGVyLFxuICBIdHRwUmVxdWVzdCxcbiAgSHR0cFJlc3BvbnNlLFxuICBIdHRwRXZlbnQsXG4gIEh0dHBFcnJvclJlc3BvbnNlXG59IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbXBvbmVudC1pbmplY3Rvci9wby1jb21wb25lbnQtaW5qZWN0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCB9IGZyb20gJy4vcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwvcG8taHR0cC1pbnRlcmNlcHRvci1kZXRhaWwuaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50IH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC5jb21wb25lbnQnO1xuXG4vLyBERVBSRUNBVEVEIDQueC54XG5jb25zdCBOT19FUlJPUl9IRUFERVJfUEFSQU0gPSAnWC1QTy1Oby1FcnJvcic7XG5jb25zdCBOT19NRVNTQUdFX0hFQURFUl9QQVJBTSA9ICdYLVBPLU5vLU1lc3NhZ2UnO1xuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIE8gKmludGVyY2VwdG9yKiB0ZW0gYSBmaW5hbGlkYWRlIGRlIGV4aWJpciBub3RpZmljYcOnw7VlcyBjb20gbWVuc2FnZW5zIG5hIHRlbGEsIGJhc2VhZG8gbmFzIHJlc3Bvc3RhcyBkYXMgcmVxdWlzacOnw7VlcyBIVFRQLlxuICpcbiAqIFBvZGUgc2VyIHV0aWxpemFkbyBwYXJhIGRhciBmZWVkYmFjayBkYXMgYcOnw7VlcyBkbyB1c3XDoXJpbyBjb21vLCBwb3IgZXhlbXBsbzogZXJybyBkZSBhdXRvcml6YcOnw6NvLCBtZW5zYWdlbnMgZGUgcmVncmFzIGRlIG5lZ8OzY2lvLFxuICogYXR1YWxpemHDp8O1ZXMgZGUgcmVnaXN0cm9zLCBlcnJvIHF1YW5kbyBvIHNlcnZpZG9yIGVzdGl2ZXIgaW5kaXNwb27DrXZlbCBlIGVudHJlIG91dHJvcy5cbiAqXG4gKiAjIyBDb25maWd1cmHDp8Ojb1xuICpcbiAqIFBhcmEgbyBjb3JyZXRvIGZ1bmNpb25hbWVudG8gZG8gaW50ZXJjZXB0b3IgYHBvLWh0dHAtaW50ZXJjZXB0b3JgLCBkZXZlIHNlciBpbXBvcnRhZG8gbyBgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGVgIG5vXG4gKiBtw7NkdWxvIHByaW5jaXBhbCBkYSBzdWEgYXBsaWNhw6fDo28uXG4gKlxuICogTcOzZHVsbyBkYSBhcGxpY2HDp8OjbzpcbiAqIGBgYFxuICogaW1wb3J0IHsgQnJvd3NlckFuaW1hdGlvbnNNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyL2FuaW1hdGlvbnMnO1xuICogaW1wb3J0IHsgUG9Nb2R1bGUgfSBmcm9tICdAcG8tdWkvbmctY29tcG9uZW50cyc7XG4gKiAuLi5cbiAqXG4gKiBATmdNb2R1bGUoe1xuICogICBpbXBvcnRzOiBbXG4gKiAgICAgQnJvd3Nlck1vZHVsZSxcbiAqICAgICBCcm93c2VyQW5pbWF0aW9uc01vZHVsZSxcbiAqICAgICAuLi5cbiAqICAgICBQb01vZHVsZVxuICogICBdLFxuICogICBkZWNsYXJhdGlvbnM6IFtcbiAqICAgICBBcHBDb21wb25lbnQsXG4gKiAgICAgLi4uXG4gKiAgIF0sXG4gKiAgIHByb3ZpZGVyczogW10sXG4gKiAgIGJvb3RzdHJhcDogW0FwcENvbXBvbmVudF1cbiAqIH0pXG4gKiBleHBvcnQgY2xhc3MgQXBwTW9kdWxlIHsgfVxuICogYGBgXG4gKlxuICogQW8gaW1wb3J0YXIgbyBtw7NkdWxvIGBQb01vZHVsZWAgbmEgYXBsaWNhw6fDo28sIG8gYHBvLWh0dHAtaW50ZXJjZXB0b3JgIMOpIGF1dG9tYXRpY2FtZW50ZSBjb25maWd1cmFkbyBzZW0gYSBuZWNlc3NpZGFkZVxuICogZGUgcXVhbHF1ZXIgY29uZmlndXJhw6fDo28gZXh0cmEuXG4gKlxuICogQW8gcmVhbGl6YXIgcmVxdWlzacOnw7VlcyB1dGlsaXplIG8gYEh0dHBDbGllbnRgLCBjb25mb3JtZSBleGVtcGxvIGFiYWl4bzpcbiAqXG4gKiBgYGBcbiAqIGltcG9ydCB7IEh0dHBDbGllbnQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG4gKlxuICogLi4uXG4gKlxuICogQEluamVjdGFibGUoKVxuICogZXhwb3J0IGNsYXNzIFVzZXJTZXJ2aWNlIHtcbiAqXG4gKiAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaHR0cDogSHR0cENsaWVudCkgeyB9XG4gKlxuICogICBnZXRVc2VycygpIHtcbiAqICAgICByZXR1cm4gdGhpcy5odHRwLmdldCgnL2FwaS91c2VycycpO1xuICogICB9XG4gKlxuICogICAuLi5cbiAqXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiAjIyBDb21vIHVzYXJcbiAqXG4gKiBQYXJhIGV4aWJpciBhcyBub3RpY2HDp8O1ZXMgw6kgbmVjZXNzw6FyaW8gaW5mb3JtYXIgYSBtZW5zYWdlbSBubyByZXRvcm5vIGRhIHJlcXVpc2nDp8Ojby4gQSBlc3RydXR1cmEgZGEgbWVuc2FnZW1cbiAqIMOpIGZlaXRhIGNvbSBiYXNlIG5vIHN0YXR1cyBkYSByZXNwb3N0YSwgY29uZm9ybWUgc2Vyw6EgYXByZXNlbnRhZG8gbm9zIHByw7N4aW1vcyB0w7NwaWNvcy5cbiAqXG4gKiAjIyMgRXN0cnV0dXJhIGRhcyBtZW5zYWdlbnNcbiAqXG4gKiAjIyMjIE1lbnNhZ2VucyBkZSBzdWNlc3NvIGAyeHhgXG4gKlxuICogUGFyYSBleGliaXIgbWVuc2FnZW5zIGFvIHJldG9ybmFyIHVtYSBsaXN0YSBvdSB1bSBpdGVtLCBkZXZlLXNlIGluY2x1aXIgYSBwcm9wcmllZGFkZSBgX21lc3NhZ2VzYCBubyBvYmpldG8gZGUgcmV0b3Juby5cbiAqIFBvciBleGVtcGxvOlxuICogYGBgXG4gKiB7XG4gKiAgIFwiX21lc3NhZ2VzXCI6IFtcbiAqICAgICB7XG4gKiAgICAgICBcInR5cGVcIjogXCJzdWNjZXNzXCIgfHwgXCJ3YXJuaW5nXCIgfHwgXCJlcnJvclwiIHx8IFwiaW5mb3JtYXRpb25cIiAoc2Vyw6EgZXhpYmlkbyBhIGB0YWdgIGFwZW5hcyBzZSBlc3RhIHByb3ByaWVkYWRlIHBvc3N1aXIgdmFsb3IpLFxuICogICAgICAgXCJjb2RlXCI6IFwidMOtdHVsbyBvdSBjw7NkaWdvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICAgICBcIm1lc3NhZ2VcIjogXCJ0ZXh0byBkYSBtZW5zYWdlbVwiLFxuICogICAgICAgXCJkZXRhaWxlZE1lc3NhZ2VcIjogXCJkZXRhbGhhbWVudG8gZGEgbWVuc2FnZW1cIlxuICogICAgIH1cbiAqICAgXVxuICogfVxuICogYGBgXG4gKlxuICogIyMjIyBNZW5zYWdlbnMgZGUgZXJybyBgNHh4YCBvdSBgNXh4YFxuICpcbiAqIEFvIHJldG9ybmFyIGVycm8sIG8gb2JqZXRvIG7Do28gbmVjZXNzaXRhIHRlciBgX21lc3NhZ2VzYCwgZGV2ZS1zZSByZXRvcm5hciBvIG9iamV0byBkaXJldGFtZW50ZTpcbiAqXG4gKiBgYGBcbiAqIHtcbiAqICAgIFwiY29kZVwiOiBcInTDrXR1bG8gb3UgY8OzZGlnbyBkYSBtZW5zYWdlbVwiLFxuICogICAgXCJtZXNzYWdlXCI6IFwidGV4dG8gZGEgbWVuc2FnZW1cIixcbiAqICAgIFwiZGV0YWlsZWRNZXNzYWdlXCI6IFwiZGV0YWxoYW1lbnRvIGRhIG1lbnNhZ2VtXCJcbiAqIH1cbiAqIGBgYFxuICpcbiAqIFRhbWLDqW0gw6kgcG9zc8OtdmVsIGluZm9ybWFyIGFzIHNlZ3VpbnRlcyBwcm9wcmllZGFkZXM6XG4gKlxuICogLSBgaGVscFVybGA6IGxpbmsgcGFyYSBhIGRvY3VtZW50YcOnw6NvIGRvIGVycm87XG4gKiAgICAtIENhc28gZm9yIGluZm9ybWFkbywgc2Vyw6EgZXhpYmlkbyB1bWEgYcOnw6NvIGRlIFwiQWp1ZGFcIiBuYSBub3RpZmljYcOnw6NvLCBwYXJhIGlzc28gbsOjbyBkZXZlcsOhIHRlciBhIHByb3ByaWVkYWRlIGBkZXRhaWxlZE1lc3NhZ2VgLlxuICogLSBgZGV0YWlsc2A6IFVtYSBsaXN0YSBkZSBvYmpldG9zIGRlIG1lbnNhZ2VtIChyZWN1cnNpdmEpIGNvbSBtYWlzIGRldGFsaGVzIHNvYnJlIGEgbWVuc2FnZW0gcHJpbmNpcGFsLlxuICpcbiAqID4gVmVqYSBvIFtHdWlhIGRlIGltcGxlbWVudGHDp8OjbyBkZSBBUElzXShndWlkZXMvYXBpKSBwYXJhIG1haXMgZGV0YWxoZXMgc29icmUgYSBlc3RydXR1cmEgZGFzIG1lbnNhZ2Vucy5cbiAqXG4gKiAjIyMgQ2FiZcOnYWxob1xuICpcbiAqIMOJIHBvc3PDrXZlbCBkaXNwZW5zYXIgYSBub3RpZmljYcOnw6NvIHBhcmEgbyB1c3XDoXJpbyB1dGlsaXphbmRvIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIG9zIHBhcsOibWV0cm9zIGxpc3RhZG9zIGFiYWl4byBjb20gbyB2YWxvclxuICogaWd1YWwgYSBgdHJ1ZWA6XG4gKlxuICogLSBgWC1QTy1Oby1NZXNzYWdlYDogTsOjbyBleGliZSBub3RpZmljYcOnw7VlcyBkZSBlcnJvIGUvb3Ugc3VjZXNzby5cbiAqXG4gKiAtICoqRGVwcmVjaWFkbyoqIGBYLVBPLU5vLUVycm9yYDogbsOjbyBtb3N0cmEgbm90aWZpY2HDp8O1ZXMgZGUgZXJybyBjb20gY8OzZGlnb3MgYDR4eGAgZSBgNXh4YC5cbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBPLU5vLU1lc3NhZ2UnOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKlxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vICppbnRlcmNlcHRvciosIG9zIHBhcsOibWV0cm9zIHNlcsOjbyByZW1vdmlkb3MgZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gKlxuICovXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUG9IdHRwSW50ZXJjZXB0b3JCYXNlU2VydmljZSBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gIG5vdGlmaWNhdGlvblR5cGVzID0gWydzdWNjZXNzJywgJ3dhcm5pbmcnLCAnZXJyb3InLCAnaW5mb3JtYXRpb24nXTtcblxuICBwcml2YXRlIGh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudDogQ29tcG9uZW50UmVmPFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50PiA9IHVuZGVmaW5lZDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbXBvbmVudEluamVjdG9yOiBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSwgcHJpdmF0ZSBub3RpZmljYXRpb246IGFueSkge31cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpOiBPYnNlcnZhYmxlPEh0dHBFdmVudDxhbnk+PiB7XG4gICAgY29uc3QgY2xvbmVSZXF1ZXN0ID0gcmVxdWVzdC5jbG9uZSgpO1xuXG4gICAgcmVxdWVzdCA9IHJlcXVlc3QgJiYgdGhpcy5oYXNQYXJhbWV0ZXJzKHJlcXVlc3QpID8gdGhpcy5jbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0KSA6IHJlcXVlc3Q7XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCkucGlwZShcbiAgICAgIHRhcChcbiAgICAgICAgKHJlc3BvbnNlOiBIdHRwRXZlbnQ8YW55PikgPT4ge1xuICAgICAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgICAgdGhpcy5wcm9jZXNzUmVzcG9uc2UocmVzcG9uc2UsIGNsb25lUmVxdWVzdCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICAoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgdGhpcy5wcm9jZXNzRXJyb3JSZXNwb25zZShlcnJvciwgY2xvbmVSZXF1ZXN0KTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgICk7XG4gIH1cblxuICBwcm9jZXNzUmVzcG9uc2UocmVzcG9uc2U6IEh0dHBSZXNwb25zZTxhbnk+LCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzTm9NZXNzYWdlUGFyYW0gPSB0aGlzLmhhc05vTWVzc2FnZVBhcmFtKHJlcXVlc3QpO1xuXG4gICAgaWYgKCFoYXNOb01lc3NhZ2VQYXJhbSAmJiByZXNwb25zZS5ib2R5ICYmIHJlc3BvbnNlLmJvZHkuX21lc3NhZ2VzKSB7XG4gICAgICBjb25zdCBtZXNzYWdlcyA9IHJlc3BvbnNlLmJvZHkuX21lc3NhZ2VzO1xuXG4gICAgICBpZiAobWVzc2FnZXMgaW5zdGFuY2VvZiBBcnJheSkge1xuICAgICAgICBtZXNzYWdlcy5mb3JFYWNoKChtZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkgPT4ge1xuICAgICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbihtZXNzYWdlKTtcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24obWVzc2FnZXMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHByb2Nlc3NFcnJvclJlc3BvbnNlKHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIGNvbnN0IGVycm9yUmVzcG9uc2UgPVxuICAgICAgcmVzcG9uc2Uuc3RhdHVzICE9PSAwXG4gICAgICAgID8gcmVzcG9uc2UuZXJyb3JcbiAgICAgICAgOiB7IGNvZGU6IDAsIG1lc3NhZ2U6ICdTZXJ2aWRvciBuw6NvIGVzdMOhIHJlc3BvbmRlbmRvLicsIGRldGFpbGVkTWVzc2FnZTogcmVzcG9uc2UubWVzc2FnZSB9O1xuXG4gICAgY29uc3QgaGFzTm9FcnJvclBhcmFtID0gdGhpcy5oYXNOb0Vycm9yUGFyYW0ocmVxdWVzdCk7XG4gICAgY29uc3QgaGFzTm9NZXNzYWdlUGFyYW0gPSB0aGlzLmhhc05vTWVzc2FnZVBhcmFtKHJlcXVlc3QpO1xuXG4gICAgaWYgKGVycm9yUmVzcG9uc2UgJiYgZXJyb3JSZXNwb25zZS5tZXNzYWdlICYmICFoYXNOb0Vycm9yUGFyYW0gJiYgIWhhc05vTWVzc2FnZVBhcmFtKSB7XG4gICAgICB0aGlzLnNob3dOb3RpZmljYXRpb24oeyAuLi5lcnJvclJlc3BvbnNlLCB0eXBlOiAnZXJyb3InIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgY2xvbmVSZXF1ZXN0V2l0aG91dFBhcmFtZXRlcnMocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IEh0dHBSZXF1ZXN0PGFueT4ge1xuICAgIGNvbnN0IGhlYWRlcnMgPSByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKE5PX0VSUk9SX0hFQURFUl9QQVJBTSkuZGVsZXRlKE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiByZXF1ZXN0LmNsb25lKHsgaGVhZGVycyB9KTtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTW9kYWwocmVzcG9uc2VNZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkge1xuICAgIGNvbnN0IGRldGFpbHMgPSByZXNwb25zZU1lc3NhZ2UuZGV0YWlscyA/IFtyZXNwb25zZU1lc3NhZ2UsIC4uLnJlc3BvbnNlTWVzc2FnZS5kZXRhaWxzXSA6IFtyZXNwb25zZU1lc3NhZ2VdO1xuXG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQgPSB0aGlzLmNvbXBvbmVudEluamVjdG9yLmNyZWF0ZUNvbXBvbmVudEluQXBwbGljYXRpb24oXG4gICAgICBQb0h0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudFxuICAgICk7XG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2UuZGV0YWlsID0gZGV0YWlscztcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5jbG9zZWQuc3Vic2NyaWJlKCgpID0+IHRoaXMuZGVzdHJveU1vZGFsKCkpO1xuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLm9wZW4oKTtcbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveU1vZGFsKCkge1xuICAgIGlmICh0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCkge1xuICAgICAgdGhpcy5jb21wb25lbnRJbmplY3Rvci5kZXN0cm95Q29tcG9uZW50SW5BcHBsaWNhdGlvbih0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCk7XG4gICAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCA9IHVuZGVmaW5lZDtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGhhc01lc3NhZ2UocmVzcG9uc2VNZXNzYWdlOiBQb0h0dHBJbnRlcmNlcHRvckRldGFpbCkge1xuICAgIGNvbnN0IGhhc01lc3NhZ2VQcm9wZXJ0aWVzID0gcmVzcG9uc2VNZXNzYWdlLm1lc3NhZ2U7XG5cbiAgICByZXR1cm4gcmVzcG9uc2VNZXNzYWdlICYmIGhhc01lc3NhZ2VQcm9wZXJ0aWVzO1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNOb0Vycm9yUGFyYW0ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vRXJyb3JQYXJhbSA9IHJlcXVlc3QgJiYgcmVxdWVzdC5oZWFkZXJzLmdldChOT19FUlJPUl9IRUFERVJfUEFSQU0pO1xuXG4gICAgcmV0dXJuIG5vRXJyb3JQYXJhbSAmJiBub0Vycm9yUGFyYW0udG9TdHJpbmcoKS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gIH1cblxuICBwcml2YXRlIGhhc05vTWVzc2FnZVBhcmFtKHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pOiBib29sZWFuIHtcbiAgICBjb25zdCBub01lc3NhZ2VQYXJhbSA9IHJlcXVlc3QgJiYgcmVxdWVzdC5oZWFkZXJzLmdldChOT19NRVNTQUdFX0hFQURFUl9QQVJBTSk7XG5cbiAgICByZXR1cm4gbm9NZXNzYWdlUGFyYW0gJiYgbm9NZXNzYWdlUGFyYW0udG9TdHJpbmcoKS50b0xvY2FsZUxvd2VyQ2FzZSgpID09PSAndHJ1ZSc7XG4gIH1cblxuICBwcml2YXRlIGhhc1BhcmFtZXRlcnMocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pikge1xuICAgIHJldHVybiByZXF1ZXN0LmhlYWRlcnMuaGFzKE5PX0VSUk9SX0hFQURFUl9QQVJBTSkgfHwgcmVxdWVzdC5oZWFkZXJzLmhhcyhOT19NRVNTQUdFX0hFQURFUl9QQVJBTSk7XG4gIH1cblxuICBwcml2YXRlIHNob3dOb3RpZmljYXRpb24ocmVzcG9uc2U6IGFueSkge1xuICAgIGlmICghdGhpcy5oYXNNZXNzYWdlKHJlc3BvbnNlKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHR5cGVOb3RpZmljYXRpb24gPSB0aGlzLm5vdGlmaWNhdGlvblR5cGVzLmluY2x1ZGVzKHJlc3BvbnNlLnR5cGUpID8gcmVzcG9uc2UudHlwZSA6ICdpbmZvcm1hdGlvbic7XG5cbiAgICBjb25zdCBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlTm90aWZpY2F0aW9uQWN0aW9uKHJlc3BvbnNlKTtcblxuICAgIHRoaXMubm90aWZpY2F0aW9uW3R5cGVOb3RpZmljYXRpb25dKHtcbiAgICAgIG1lc3NhZ2U6IHJlc3BvbnNlLm1lc3NhZ2UsXG4gICAgICBhY3Rpb25MYWJlbDogbm90aWZpY2F0aW9uQWN0aW9uLmxhYmVsLFxuICAgICAgYWN0aW9uOiBub3RpZmljYXRpb25BY3Rpb24uYWN0aW9uXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlRGV0YWlsTW9kYWwocmVzcG9uc2VNZXNzYWdlOiBhbnkpIHtcbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaWYgKCF0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCkge1xuICAgICAgICB0aGlzLmNyZWF0ZU1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVOb3RpZmljYXRpb25BY3Rpb24ocmVzcG9uc2VNZXNzYWdlOiBhbnkpIHtcbiAgICBsZXQgbm90aWZpY2F0aW9uQWN0aW9uO1xuICAgIGxldCBub3RpZmljYXRpb25MYWJlbDtcblxuICAgIGlmIChyZXNwb25zZU1lc3NhZ2UuaGVscFVybCAmJiAhKHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxlZE1lc3NhZ2UgfHwgcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMpKSB7XG4gICAgICBub3RpZmljYXRpb25MYWJlbCA9ICdBanVkYSc7XG4gICAgICBub3RpZmljYXRpb25BY3Rpb24gPSB0aGlzLmdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKHJlc3BvbnNlTWVzc2FnZS5oZWxwVXJsKTtcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxlZE1lc3NhZ2UgfHwgcmVzcG9uc2VNZXNzYWdlLmRldGFpbHMpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gJ0RldGFsaGVzJztcbiAgICAgIG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVEZXRhaWxNb2RhbChyZXNwb25zZU1lc3NhZ2UpO1xuICAgIH1cbiAgICByZXR1cm4geyBsYWJlbDogbm90aWZpY2F0aW9uTGFiZWwsIGFjdGlvbjogbm90aWZpY2F0aW9uQWN0aW9uIH07XG4gIH1cblxuICBwcml2YXRlIGdlbmVyYXRlVXJsSGVscEZ1bmN0aW9uKGhlbHBVcmw6IHN0cmluZykge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICB3aW5kb3cub3BlbihoZWxwVXJsLCAnX2JsYW5rJyk7XG4gICAgfTtcbiAgfVxufVxuIl19