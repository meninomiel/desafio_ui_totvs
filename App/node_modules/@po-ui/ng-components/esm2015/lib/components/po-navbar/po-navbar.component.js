import { __decorate, __metadata } from "tslib";
import { AfterViewInit, ChangeDetectorRef, Component, ElementRef, OnDestroy, Renderer2, ViewChild } from '@angular/core';
import { animate, AnimationBuilder, AnimationFactory, AnimationPlayer, keyframes, style } from '@angular/animations';
import { PoNavbarBaseComponent } from './po-navbar-base.component';
import { PoNavbarItemsComponent } from './po-navbar-items/po-navbar-items.component';
const poNavbarNavigationWidth = 88;
const poNavbarMenuMedia = 768;
const poNavbarMatchMedia = `(max-width: ${poNavbarMenuMedia}px)`;
const poNavbarTiming = '250ms ease';
/**
 * @docsExtends PoNavbarBaseComponent
 */
let PoNavbarComponent = class PoNavbarComponent extends PoNavbarBaseComponent {
    constructor(renderer, builder, changeDetector) {
        super();
        this.renderer = renderer;
        this.builder = builder;
        this.changeDetector = changeDetector;
        this.showItemsNavigation = false;
        this.offset = 0;
        this.onMediaQueryChange = changed => {
            this.changeNavbarMenuItems(changed.matches, this.menuItems, this.items, this.literals.navbarLinks);
        };
        this.windowResizeListener = this.renderer.listen(window, 'resize', this.displayItemsNavigation.bind(this));
    }
    get navbarItemNavigationDisableLeft() {
        return this.offset === 0;
    }
    get navbarItemNavigationDisableRight() {
        return this.disableRight && this.offset !== 0;
    }
    ngAfterViewInit() {
        this.displayItemsNavigation();
        if (this.menu) {
            this.initNavbarMenu();
        }
    }
    ngOnDestroy() {
        if (this.mediaQuery) {
            this.mediaQuery.removeListener(this.onMediaQueryChange);
        }
    }
    navigateItems(orientation) {
        orientation === 'left' ? this.navigateLeft() : this.navigateRight();
        this.animate(this.offset);
    }
    allNavbarItemsWidth() {
        return this.navbarItems.allNavbarItems.reduce((previous, current) => previous + current.nativeElement.offsetWidth, 0);
    }
    animate(offset) {
        const animation = this.buildTransitionAnimation(offset);
        this.player = animation.create(this.navbarItems.navbarItemsContainer.nativeElement);
        this.player.play();
    }
    buildTransitionAnimation(offset) {
        return this.builder.build([animate(poNavbarTiming, keyframes([style({ transform: `translateX(${-offset}px)` })]))]);
    }
    changeNavbarMenuItems(isCollapsedMedia, menuItems, navbarItems, label) {
        if (isCollapsedMedia) {
            const subItems = [{ label, subItems: navbarItems }];
            this.menu.menus = [...subItems, ...menuItems];
        }
        else {
            this.menu.menus = menuItems;
        }
    }
    calculateLeftNavigation() {
        let calculatedOffset;
        this.navbarItems.allNavbarItems.some(navbarItem => {
            const navbarItemOffset = navbarItem.nativeElement.offsetLeft;
            const navbarItemWidth = navbarItem.nativeElement.offsetWidth;
            if (navbarItemOffset >= this.offset) {
                calculatedOffset = navbarItemOffset - (this.navbarItemsWidth() - navbarItemWidth);
                return true;
            }
        });
        return calculatedOffset;
    }
    calculateRightNavigation(itemBreakPoint) {
        let calculatedOffset;
        this.navbarItems.allNavbarItems.some(navbarItem => {
            const offsetLeft = navbarItem.nativeElement.offsetLeft;
            const finalPosition = navbarItem.nativeElement.offsetWidth + offsetLeft;
            if (itemBreakPoint < finalPosition) {
                calculatedOffset = offsetLeft;
                return true;
            }
        });
        return calculatedOffset;
    }
    displayItemsNavigation() {
        this.showItemsNavigation = this.navbarItemsWidth() < this.allNavbarItemsWidth() + poNavbarNavigationWidth;
        this.changeDetector.detectChanges();
        if (this.offset !== 0) {
            this.setOffsetToZero();
            this.animate(this.offset);
        }
    }
    initNavbarMenu() {
        this.mediaQuery = window.matchMedia(poNavbarMatchMedia);
        this.menuItems = this.menu.menus;
        if (window.innerWidth < poNavbarMenuMedia) {
            this.changeNavbarMenuItems(true, this.menuItems, this.items, this.literals.navbarLinks);
        }
        this.validateMenuLogo();
        this.mediaQuery.addListener(this.onMediaQueryChange);
    }
    navbarItemsWidth() {
        return this.navbarItemsElement.nativeElement.offsetWidth;
    }
    navigateLeft() {
        this.disableRight = false;
        this.offset = this.calculateLeftNavigation();
        if (this.offset < 0) {
            this.setOffsetToZero();
        }
    }
    navigateRight() {
        const maxAllowedOffset = this.allNavbarItemsWidth() - this.navbarItemsWidth();
        const itemBreakPoint = this.offset + this.navbarItemsWidth();
        this.offset = this.calculateRightNavigation(itemBreakPoint);
        this.validateMaxOffset(maxAllowedOffset);
    }
    setOffsetToZero() {
        this.offset = 0;
    }
    validateMaxOffset(maxAllowedOffset) {
        if (this.offset >= maxAllowedOffset) {
            this.offset = maxAllowedOffset;
            this.disableRight = true;
        }
    }
    validateMenuLogo() {
        if (this.menu.logo && this.logo) {
            this.menu.logo = undefined;
            this.menu.changeDetector.detectChanges();
        }
    }
};
PoNavbarComponent.ctorParameters = () => [
    { type: Renderer2 },
    { type: AnimationBuilder },
    { type: ChangeDetectorRef }
];
__decorate([
    ViewChild(PoNavbarItemsComponent, { read: ElementRef, static: true }),
    __metadata("design:type", ElementRef)
], PoNavbarComponent.prototype, "navbarItemsElement", void 0);
__decorate([
    ViewChild(PoNavbarItemsComponent, { static: true }),
    __metadata("design:type", PoNavbarItemsComponent)
], PoNavbarComponent.prototype, "navbarItems", void 0);
PoNavbarComponent = __decorate([
    Component({
        selector: 'po-navbar',
        template: "<header class=\"po-navbar\" [ngClass]=\"{ 'po-navbar-shadow': shadow }\">\n  <po-navbar-logo\n    class=\"po-navbar-logo\"\n    [ngClass]=\"{ 'po-navbar-logo-menu': !!menu, 'po-navbar-no-logo': !logo }\"\n    [p-logo]=\"logo\"\n  >\n  </po-navbar-logo>\n\n  <po-navbar-items class=\"po-navbar-items\" [p-items]=\"items\"> </po-navbar-items>\n\n  <po-navbar-item-navigation\n    *ngIf=\"showItemsNavigation\"\n    class=\"po-navbar-item-navigation\"\n    [p-disable-left]=\"navbarItemNavigationDisableLeft\"\n    [p-disable-right]=\"navbarItemNavigationDisableRight\"\n    (p-click)=\"navigateItems($event)\"\n  >\n  </po-navbar-item-navigation>\n\n  <po-navbar-actions class=\"po-navbar-actions\" [p-icon-actions]=\"iconActions\"> </po-navbar-actions>\n</header>\n\n<po-menu *ngIf=\"!menu\" [p-menus]=\"items\"> </po-menu>\n"
    }),
    __metadata("design:paramtypes", [Renderer2,
        AnimationBuilder,
        ChangeDetectorRef])
], PoNavbarComponent);
export { PoNavbarComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbmF2YmFyLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwby11aS9uZy1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tbmF2YmFyL3BvLW5hdmJhci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxhQUFhLEVBQ2IsaUJBQWlCLEVBQ2pCLFNBQVMsRUFDVCxVQUFVLEVBQ1YsU0FBUyxFQUNULFNBQVMsRUFDVCxTQUFTLEVBQ1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsU0FBUyxFQUFFLEtBQUssRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3JILE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBRW5FLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDZDQUE2QyxDQUFDO0FBRXJGLE1BQU0sdUJBQXVCLEdBQUcsRUFBRSxDQUFDO0FBQ25DLE1BQU0saUJBQWlCLEdBQUcsR0FBRyxDQUFDO0FBQzlCLE1BQU0sa0JBQWtCLEdBQUcsZUFBZSxpQkFBaUIsS0FBSyxDQUFDO0FBQ2pFLE1BQU0sY0FBYyxHQUFHLFlBQVksQ0FBQztBQUVwQzs7R0FFRztBQUtILElBQWEsaUJBQWlCLEdBQTlCLE1BQWEsaUJBQWtCLFNBQVEscUJBQXFCO0lBdUIxRCxZQUNVLFFBQW1CLEVBQ25CLE9BQXlCLEVBQ3pCLGNBQWlDO1FBRXpDLEtBQUssRUFBRSxDQUFDO1FBSkEsYUFBUSxHQUFSLFFBQVEsQ0FBVztRQUNuQixZQUFPLEdBQVAsT0FBTyxDQUFrQjtRQUN6QixtQkFBYyxHQUFkLGNBQWMsQ0FBbUI7UUF4QjNDLHdCQUFtQixHQUFZLEtBQUssQ0FBQztRQUc3QixXQUFNLEdBQVcsQ0FBQyxDQUFDO1FBNEpuQix1QkFBa0IsR0FBRyxPQUFPLENBQUMsRUFBRTtZQUNy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LCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICBBZnRlclZpZXdJbml0LFxuICBDaGFuZ2VEZXRlY3RvclJlZixcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBPbkRlc3Ryb3ksXG4gIFJlbmRlcmVyMixcbiAgVmlld0NoaWxkXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgYW5pbWF0ZSwgQW5pbWF0aW9uQnVpbGRlciwgQW5pbWF0aW9uRmFjdG9yeSwgQW5pbWF0aW9uUGxheWVyLCBrZXlmcmFtZXMsIHN0eWxlIH0gZnJvbSAnQGFuZ3VsYXIvYW5pbWF0aW9ucyc7XG5cbmltcG9ydCB7IFBvTWVudUl0ZW0gfSBmcm9tICcuLi9wby1tZW51JztcbmltcG9ydCB7IFBvTmF2YmFyQmFzZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tbmF2YmFyLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IFBvTmF2YmFySXRlbSB9IGZyb20gJy4vaW50ZXJmYWNlcy9wby1uYXZiYXItaXRlbS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9OYXZiYXJJdGVtc0NvbXBvbmVudCB9IGZyb20gJy4vcG8tbmF2YmFyLWl0ZW1zL3BvLW5hdmJhci1pdGVtcy5jb21wb25lbnQnO1xuXG5jb25zdCBwb05hdmJhck5hdmlnYXRpb25XaWR0aCA9IDg4O1xuY29uc3QgcG9OYXZiYXJNZW51TWVkaWEgPSA3Njg7XG5jb25zdCBwb05hdmJhck1hdGNoTWVkaWEgPSBgKG1heC13aWR0aDogJHtwb05hdmJhck1lbnVNZWRpYX1weClgO1xuY29uc3QgcG9OYXZiYXJUaW1pbmcgPSAnMjUwbXMgZWFzZSc7XG5cbi8qKlxuICogQGRvY3NFeHRlbmRzIFBvTmF2YmFyQmFzZUNvbXBvbmVudFxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdwby1uYXZiYXInLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tbmF2YmFyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb05hdmJhckNvbXBvbmVudCBleHRlbmRzIFBvTmF2YmFyQmFzZUNvbXBvbmVudCBpbXBsZW1lbnRzIEFmdGVyVmlld0luaXQsIE9uRGVzdHJveSB7XG4gIGRpc2FibGVSaWdodDogYm9vbGVhbjtcbiAgc2hvd0l0ZW1zTmF2aWdhdGlvbjogYm9vbGVhbiA9IGZhbHNlO1xuXG4gIHByaXZhdGUgbWVkaWFRdWVyeTogYW55O1xuICBwcml2YXRlIG9mZnNldDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBwbGF5ZXI6IEFuaW1hdGlvblBsYXllcjtcbiAgcHJpdmF0ZSBtZW51SXRlbXM6IEFycmF5PFBvTWVudUl0ZW0+O1xuXG4gIHByb3RlY3RlZCB3aW5kb3dSZXNpemVMaXN0ZW5lcjogKCkgPT4gdm9pZDtcblxuICBnZXQgbmF2YmFySXRlbU5hdmlnYXRpb25EaXNhYmxlTGVmdCgpIHtcbiAgICByZXR1cm4gdGhpcy5vZmZzZXQgPT09IDA7XG4gIH1cblxuICBnZXQgbmF2YmFySXRlbU5hdmlnYXRpb25EaXNhYmxlUmlnaHQoKSB7XG4gICAgcmV0dXJuIHRoaXMuZGlzYWJsZVJpZ2h0ICYmIHRoaXMub2Zmc2V0ICE9PSAwO1xuICB9XG5cbiAgQFZpZXdDaGlsZChQb05hdmJhckl0ZW1zQ29tcG9uZW50LCB7IHJlYWQ6IEVsZW1lbnRSZWYsIHN0YXRpYzogdHJ1ZSB9KSBuYXZiYXJJdGVtc0VsZW1lbnQ6IEVsZW1lbnRSZWY7XG5cbiAgQFZpZXdDaGlsZChQb05hdmJhckl0ZW1zQ29tcG9uZW50LCB7IHN0YXRpYzogdHJ1ZSB9KSBuYXZiYXJJdGVtczogUG9OYXZiYXJJdGVtc0NvbXBvbmVudDtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlbmRlcmVyOiBSZW5kZXJlcjIsXG4gICAgcHJpdmF0ZSBidWlsZGVyOiBBbmltYXRpb25CdWlsZGVyLFxuICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3I6IENoYW5nZURldGVjdG9yUmVmXG4gICkge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy53aW5kb3dSZXNpemVMaXN0ZW5lciA9IHRoaXMucmVuZGVyZXIubGlzdGVuKHdpbmRvdywgJ3Jlc2l6ZScsIHRoaXMuZGlzcGxheUl0ZW1zTmF2aWdhdGlvbi5iaW5kKHRoaXMpKTtcbiAgfVxuXG4gIG5nQWZ0ZXJWaWV3SW5pdCgpIHtcbiAgICB0aGlzLmRpc3BsYXlJdGVtc05hdmlnYXRpb24oKTtcblxuICAgIGlmICh0aGlzLm1lbnUpIHtcbiAgICAgIHRoaXMuaW5pdE5hdmJhck1lbnUoKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICBpZiAodGhpcy5tZWRpYVF1ZXJ5KSB7XG4gICAgICB0aGlzLm1lZGlhUXVlcnkucmVtb3ZlTGlzdGVuZXIodGhpcy5vbk1lZGlhUXVlcnlDaGFuZ2UpO1xuICAgIH1cbiAgfVxuXG4gIG5hdmlnYXRlSXRlbXMob3JpZW50YXRpb246IHN0cmluZykge1xuICAgIG9yaWVudGF0aW9uID09PSAnbGVmdCcgPyB0aGlzLm5hdmlnYXRlTGVmdCgpIDogdGhpcy5uYXZpZ2F0ZVJpZ2h0KCk7XG5cbiAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBhbGxOYXZiYXJJdGVtc1dpZHRoKCkge1xuICAgIHJldHVybiB0aGlzLm5hdmJhckl0ZW1zLmFsbE5hdmJhckl0ZW1zLnJlZHVjZShcbiAgICAgIChwcmV2aW91czogYW55LCBjdXJyZW50OiBhbnkpID0+IHByZXZpb3VzICsgY3VycmVudC5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoLFxuICAgICAgMFxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGFuaW1hdGUob2Zmc2V0OiBudW1iZXIpIHtcbiAgICBjb25zdCBhbmltYXRpb246IEFuaW1hdGlvbkZhY3RvcnkgPSB0aGlzLmJ1aWxkVHJhbnNpdGlvbkFuaW1hdGlvbihvZmZzZXQpO1xuXG4gICAgdGhpcy5wbGF5ZXIgPSBhbmltYXRpb24uY3JlYXRlKHRoaXMubmF2YmFySXRlbXMubmF2YmFySXRlbXNDb250YWluZXIubmF0aXZlRWxlbWVudCk7XG4gICAgdGhpcy5wbGF5ZXIucGxheSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBidWlsZFRyYW5zaXRpb25BbmltYXRpb24ob2Zmc2V0OiBudW1iZXIpIHtcbiAgICByZXR1cm4gdGhpcy5idWlsZGVyLmJ1aWxkKFthbmltYXRlKHBvTmF2YmFyVGltaW5nLCBrZXlmcmFtZXMoW3N0eWxlKHsgdHJhbnNmb3JtOiBgdHJhbnNsYXRlWCgkey1vZmZzZXR9cHgpYCB9KV0pKV0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjaGFuZ2VOYXZiYXJNZW51SXRlbXMoXG4gICAgaXNDb2xsYXBzZWRNZWRpYTogYW55LFxuICAgIG1lbnVJdGVtczogQXJyYXk8UG9NZW51SXRlbT4sXG4gICAgbmF2YmFySXRlbXM6IEFycmF5PFBvTmF2YmFySXRlbT4sXG4gICAgbGFiZWw6IHN0cmluZ1xuICApIHtcbiAgICBpZiAoaXNDb2xsYXBzZWRNZWRpYSkge1xuICAgICAgY29uc3Qgc3ViSXRlbXMgPSBbeyBsYWJlbCwgc3ViSXRlbXM6IG5hdmJhckl0ZW1zIH1dO1xuICAgICAgdGhpcy5tZW51Lm1lbnVzID0gWy4uLnN1Ykl0ZW1zLCAuLi5tZW51SXRlbXNdO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLm1lbnUubWVudXMgPSBtZW51SXRlbXM7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVMZWZ0TmF2aWdhdGlvbigpIHtcbiAgICBsZXQgY2FsY3VsYXRlZE9mZnNldDogbnVtYmVyO1xuXG4gICAgdGhpcy5uYXZiYXJJdGVtcy5hbGxOYXZiYXJJdGVtcy5zb21lKG5hdmJhckl0ZW0gPT4ge1xuICAgICAgY29uc3QgbmF2YmFySXRlbU9mZnNldCA9IG5hdmJhckl0ZW0ubmF0aXZlRWxlbWVudC5vZmZzZXRMZWZ0O1xuICAgICAgY29uc3QgbmF2YmFySXRlbVdpZHRoID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuXG4gICAgICBpZiAobmF2YmFySXRlbU9mZnNldCA+PSB0aGlzLm9mZnNldCkge1xuICAgICAgICBjYWxjdWxhdGVkT2Zmc2V0ID0gbmF2YmFySXRlbU9mZnNldCAtICh0aGlzLm5hdmJhckl0ZW1zV2lkdGgoKSAtIG5hdmJhckl0ZW1XaWR0aCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuICAgIHJldHVybiBjYWxjdWxhdGVkT2Zmc2V0O1xuICB9XG5cbiAgcHJpdmF0ZSBjYWxjdWxhdGVSaWdodE5hdmlnYXRpb24oaXRlbUJyZWFrUG9pbnQ6IG51bWJlcikge1xuICAgIGxldCBjYWxjdWxhdGVkT2Zmc2V0OiBudW1iZXI7XG5cbiAgICB0aGlzLm5hdmJhckl0ZW1zLmFsbE5hdmJhckl0ZW1zLnNvbWUobmF2YmFySXRlbSA9PiB7XG4gICAgICBjb25zdCBvZmZzZXRMZWZ0ID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldExlZnQ7XG4gICAgICBjb25zdCBmaW5hbFBvc2l0aW9uID0gbmF2YmFySXRlbS5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoICsgb2Zmc2V0TGVmdDtcblxuICAgICAgaWYgKGl0ZW1CcmVha1BvaW50IDwgZmluYWxQb3NpdGlvbikge1xuICAgICAgICBjYWxjdWxhdGVkT2Zmc2V0ID0gb2Zmc2V0TGVmdDtcbiAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIGNhbGN1bGF0ZWRPZmZzZXQ7XG4gIH1cblxuICBwcml2YXRlIGRpc3BsYXlJdGVtc05hdmlnYXRpb24oKSB7XG4gICAgdGhpcy5zaG93SXRlbXNOYXZpZ2F0aW9uID0gdGhpcy5uYXZiYXJJdGVtc1dpZHRoKCkgPCB0aGlzLmFsbE5hdmJhckl0ZW1zV2lkdGgoKSArIHBvTmF2YmFyTmF2aWdhdGlvbldpZHRoO1xuXG4gICAgdGhpcy5jaGFuZ2VEZXRlY3Rvci5kZXRlY3RDaGFuZ2VzKCk7XG5cbiAgICBpZiAodGhpcy5vZmZzZXQgIT09IDApIHtcbiAgICAgIHRoaXMuc2V0T2Zmc2V0VG9aZXJvKCk7XG4gICAgICB0aGlzLmFuaW1hdGUodGhpcy5vZmZzZXQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaW5pdE5hdmJhck1lbnUoKSB7XG4gICAgdGhpcy5tZWRpYVF1ZXJ5ID0gd2luZG93Lm1hdGNoTWVkaWEocG9OYXZiYXJNYXRjaE1lZGlhKTtcbiAgICB0aGlzLm1lbnVJdGVtcyA9IHRoaXMubWVudS5tZW51cztcblxuICAgIGlmICh3aW5kb3cuaW5uZXJXaWR0aCA8IHBvTmF2YmFyTWVudU1lZGlhKSB7XG4gICAgICB0aGlzLmNoYW5nZU5hdmJhck1lbnVJdGVtcyh0cnVlLCB0aGlzLm1lbnVJdGVtcywgdGhpcy5pdGVtcywgdGhpcy5saXRlcmFscy5uYXZiYXJMaW5rcyk7XG4gICAgfVxuXG4gICAgdGhpcy52YWxpZGF0ZU1lbnVMb2dvKCk7XG5cbiAgICB0aGlzLm1lZGlhUXVlcnkuYWRkTGlzdGVuZXIodGhpcy5vbk1lZGlhUXVlcnlDaGFuZ2UpO1xuICB9XG5cbiAgcHJpdmF0ZSBuYXZiYXJJdGVtc1dpZHRoKCkge1xuICAgIHJldHVybiB0aGlzLm5hdmJhckl0ZW1zRWxlbWVudC5uYXRpdmVFbGVtZW50Lm9mZnNldFdpZHRoO1xuICB9XG5cbiAgcHJpdmF0ZSBuYXZpZ2F0ZUxlZnQoKSB7XG4gICAgdGhpcy5kaXNhYmxlUmlnaHQgPSBmYWxzZTtcblxuICAgIHRoaXMub2Zmc2V0ID0gdGhpcy5jYWxjdWxhdGVMZWZ0TmF2aWdhdGlvbigpO1xuXG4gICAgaWYgKHRoaXMub2Zmc2V0IDwgMCkge1xuICAgICAgdGhpcy5zZXRPZmZzZXRUb1plcm8oKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5hdmlnYXRlUmlnaHQoKSB7XG4gICAgY29uc3QgbWF4QWxsb3dlZE9mZnNldCA9IHRoaXMuYWxsTmF2YmFySXRlbXNXaWR0aCgpIC0gdGhpcy5uYXZiYXJJdGVtc1dpZHRoKCk7XG4gICAgY29uc3QgaXRlbUJyZWFrUG9pbnQgPSB0aGlzLm9mZnNldCArIHRoaXMubmF2YmFySXRlbXNXaWR0aCgpO1xuXG4gICAgdGhpcy5vZmZzZXQgPSB0aGlzLmNhbGN1bGF0ZVJpZ2h0TmF2aWdhdGlvbihpdGVtQnJlYWtQb2ludCk7XG5cbiAgICB0aGlzLnZhbGlkYXRlTWF4T2Zmc2V0KG1heEFsbG93ZWRPZmZzZXQpO1xuICB9XG5cbiAgcHJpdmF0ZSBvbk1lZGlhUXVlcnlDaGFuZ2UgPSBjaGFuZ2VkID0+IHtcbiAgICB0aGlzLmNoYW5nZU5hdmJhck1lbnVJdGVtcyhjaGFuZ2VkLm1hdGNoZXMsIHRoaXMubWVudUl0ZW1zLCB0aGlzLml0ZW1zLCB0aGlzLmxpdGVyYWxzLm5hdmJhckxpbmtzKTtcbiAgfTtcblxuICBwcml2YXRlIHNldE9mZnNldFRvWmVybygpIHtcbiAgICB0aGlzLm9mZnNldCA9IDA7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlTWF4T2Zmc2V0KG1heEFsbG93ZWRPZmZzZXQ6IG51bWJlcikge1xuICAgIGlmICh0aGlzLm9mZnNldCA+PSBtYXhBbGxvd2VkT2Zmc2V0KSB7XG4gICAgICB0aGlzLm9mZnNldCA9IG1heEFsbG93ZWRPZmZzZXQ7XG4gICAgICB0aGlzLmRpc2FibGVSaWdodCA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgcHJvdGVjdGVkIHZhbGlkYXRlTWVudUxvZ28oKSB7XG4gICAgaWYgKHRoaXMubWVudS5sb2dvICYmIHRoaXMubG9nbykge1xuICAgICAgdGhpcy5tZW51LmxvZ28gPSB1bmRlZmluZWQ7XG4gICAgICB0aGlzLm1lbnUuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxufVxuIl19