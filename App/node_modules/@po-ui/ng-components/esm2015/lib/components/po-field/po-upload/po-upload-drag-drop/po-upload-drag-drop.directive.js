import { __awaiter, __decorate, __metadata } from "tslib";
import { Directive, EventEmitter, HostListener, Input, Output } from '@angular/core';
import { PoI18nPipe } from '../../../../services/po-i18n/po-i18n.pipe';
import { PoNotificationService } from '../../../../services/po-notification/po-notification.service';
let PoUploadDragDropDirective = class PoUploadDragDropDirective {
    constructor(i18nPipe, notification) {
        this.i18nPipe = i18nPipe;
        this.notification = notification;
        this.dragLeave = new EventEmitter();
        this.dragOver = new EventEmitter();
        this.fileChange = new EventEmitter();
    }
    onDragLeave(event) {
        event.preventDefault();
        event.stopPropagation();
        this.timeout = setTimeout(() => this.dragLeave.emit(), 30);
    }
    onDragOver(event) {
        event.preventDefault();
        event.stopPropagation();
        clearTimeout(this.timeout);
        if (!this.disabled) {
            this.dragOver.emit();
        }
    }
    onDrop(event) {
        event.preventDefault();
        event.stopPropagation();
        this.getFilesFromDataTransferItems(event);
        this.dragLeave.emit();
    }
    getFilesFromDataTransferItems(event) {
        if (!this.disabled) {
            this.invalidFileType = 0;
            if (this.directoryCompatible) {
                this.getOnlyDirectories(event.dataTransfer.items).then(() => {
                    this.sendFiles(event, this.files);
                });
            }
            else {
                const files = this.getOnlyFiles(event.dataTransfer.files);
                this.sendFiles(event, files);
            }
        }
    }
    // analisa as entradas recursivamente
    getFilesFromEntry(entry) {
        return __awaiter(this, void 0, void 0, function* () {
            if (entry.isFile) {
                const file = yield this.readFile(entry);
                return [file];
            }
            else if (entry.isDirectory) {
                return yield this.readDirectory(entry);
            }
        });
    }
    getOnlyDirectories(dataTransferItems) {
        return __awaiter(this, void 0, void 0, function* () {
            const entries = [];
            // lista todas as entradas antes de analisá-las
            for (const item of dataTransferItems) {
                entries.push(item.webkitGetAsEntry());
            }
            this.files = [];
            for (const entry of entries) {
                if (entry.isFile) {
                    this.invalidFileType++;
                }
                else {
                    const newFiles = yield this.getFilesFromEntry(entry);
                    this.files = this.files.concat(newFiles);
                }
            }
        });
    }
    // return only files. If it is a directory, invalidFileType counts.
    getOnlyFiles(fileList) {
        return Array.from(fileList).reduce((newFiles, file) => {
            if (file.type) {
                return newFiles.concat(file);
            }
            else {
                this.invalidFileType++;
            }
            return newFiles;
        }, []);
    }
    readFile(entry) {
        return new Promise(resolve => {
            entry.file(file => {
                resolve(file);
            });
        });
    }
    readDirectory(entry) {
        return __awaiter(this, void 0, void 0, function* () {
            const dirReader = entry.createReader();
            let files = [];
            let newFiles;
            newFiles = yield this.readDirectoryEntries(dirReader);
            files = files.concat(newFiles);
            return files;
        });
    }
    readDirectoryEntries(dirReader) {
        return new Promise(resolve => {
            dirReader.readEntries((entries) => __awaiter(this, void 0, void 0, function* () {
                let files = [];
                for (const entry of entries) {
                    const itemFiles = yield this.getFilesFromEntry(entry);
                    files = files.concat(itemFiles);
                }
                resolve(files);
            }));
        });
    }
    sendFeedback(invalidFiles) {
        if (invalidFiles) {
            this.setPipeArguments('invalidFileType', invalidFiles);
        }
    }
    sendFiles(event, files) {
        if (this.areaElement.contains(event.target)) {
            if (files.length > 0) {
                this.fileChange.emit(files);
            }
            this.sendFeedback(this.invalidFileType);
        }
        else {
            const invalidDropAreaArg = this.directoryCompatible ? this.literals.folders : this.literals.files;
            this.setPipeArguments('invalidDropArea', invalidDropAreaArg);
        }
    }
    // método responsável por setar os argumentos do i18nPipe.
    setPipeArguments(literalAttributes, args) {
        const pipeArguments = this.i18nPipe.transform(this.literals[literalAttributes], args);
        this.notification.information(pipeArguments);
    }
};
PoUploadDragDropDirective.ctorParameters = () => [
    { type: PoI18nPipe },
    { type: PoNotificationService }
];
__decorate([
    Input('p-area-element'),
    __metadata("design:type", HTMLElement)
], PoUploadDragDropDirective.prototype, "areaElement", void 0);
__decorate([
    Input('p-directory-compatible'),
    __metadata("design:type", Boolean)
], PoUploadDragDropDirective.prototype, "directoryCompatible", void 0);
__decorate([
    Input('p-disabled'),
    __metadata("design:type", Boolean)
], PoUploadDragDropDirective.prototype, "disabled", void 0);
__decorate([
    Input('p-literals'),
    __metadata("design:type", Object)
], PoUploadDragDropDirective.prototype, "literals", void 0);
__decorate([
    Output('p-drag-leave'),
    __metadata("design:type", EventEmitter)
], PoUploadDragDropDirective.prototype, "dragLeave", void 0);
__decorate([
    Output('p-drag-over'),
    __metadata("design:type", EventEmitter)
], PoUploadDragDropDirective.prototype, "dragOver", void 0);
__decorate([
    Output('p-file-change'),
    __metadata("design:type", EventEmitter)
], PoUploadDragDropDirective.prototype, "fileChange", void 0);
__decorate([
    HostListener('document:dragleave', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], PoUploadDragDropDirective.prototype, "onDragLeave", null);
__decorate([
    HostListener('document:dragover', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], PoUploadDragDropDirective.prototype, "onDragOver", null);
__decorate([
    HostListener('document:drop', ['$event']),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Object]),
    __metadata("design:returntype", void 0)
], PoUploadDragDropDirective.prototype, "onDrop", null);
PoUploadDragDropDirective = __decorate([
    Directive({
        selector: '[p-upload-drag-drop]',
        providers: [PoI18nPipe]
    }),
    __metadata("design:paramtypes", [PoI18nPipe, PoNotificationService])
], PoUploadDragDropDirective);
export { PoUploadDragDropDirective };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdXBsb2FkLWRyYWctZHJvcC5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3BvLWZpZWxkL3BvLXVwbG9hZC9wby11cGxvYWQtZHJhZy1kcm9wL3BvLXVwbG9hZC1kcmFnLWRyb3AuZGlyZWN0aXZlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFlBQVksRUFBRSxZQUFZLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUVyRixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sMkNBQTJDLENBQUM7QUFDdkUsT0FBTyxFQUFFLHFCQUFxQixFQUFFLE1BQU0sOERBQThELENBQUM7QUFPckcsSUFBYSx5QkFBeUIsR0FBdEMsTUFBYSx5QkFBeUI7SUFvQnBDLFlBQW9CLFFBQW9CLEVBQVUsWUFBbUM7UUFBakUsYUFBUSxHQUFSLFFBQVEsQ0FBWTtRQUFVLGlCQUFZLEdBQVosWUFBWSxDQUF1QjtRQU43RCxjQUFTLEdBQXNCLElBQUksWUFBWSxFQUFPLENBQUM7UUFFeEQsYUFBUSxHQUFzQixJQUFJLFlBQVksRUFBTyxDQUFDO1FBRXBELGVBQVUsR0FBc0IsSUFBSSxZQUFZLEVBQU8sQ0FBQztJQUVPLENBQUM7SUFFekMsV0FBVyxDQUFDLEtBQUs7UUFDL0QsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3ZCLEtBQUssQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUV4QixJQUFJLENBQUMsT0FBTyxHQUFHLFVBQVUsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQzdELENBQUM7SUFFOEMsVUFBVSxDQUFDLEtBQUs7UUFDN0QsS0FBSyxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3ZCLEtBQUssQ0FBQyxlQUFlLEVB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QUFZLENBQUM7OzJEQUFtQjtBQUVsQjtJQUFwQixLQUFLLENBQUMsWUFBWSxDQUFDOzsyREFBNEI7QUFFeEI7SUFBdkIsTUFBTSxDQUFDLGNBQWMsQ0FBQzs4QkFBWSxZQUFZOzREQUFnQztBQUV4RDtJQUF0QixNQUFNLENBQUMsYUFBYSxDQUFDOzhCQUFXLFlBQVk7MkRBQWdDO0FBRXBEO0lBQXhCLE1BQU0sQ0FBQyxlQUFlLENBQUM7OEJBQWEsWUFBWTs2REFBZ0M7QUFJakM7SUFBL0MsWUFBWSxDQUFDLG9CQUFvQixFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7NERBSzlDO0FBRThDO0lBQTlDLFlBQVksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLFFBQVEsQ0FBQyxDQUFDOzs7OzJEQVM3QztBQUUwQztJQUExQyxZQUFZLENBQUMsZUFBZSxFQUFFLENBQUMsUUFBUSxDQUFDLENBQUM7Ozs7dURBTXpDO0FBOUNVLHlCQUF5QjtJQUpyQyxTQUFTLENBQUM7UUFDVCxRQUFRLEVBQUUsc0JBQXNCO1FBQ2hDLFNBQVMsRUFBRSxDQUFDLFVBQVUsQ0FBQztLQUN4QixDQUFDO3FDQXFCOEIsVUFBVSxFQUF3QixxQkFBcUI7R0FwQjFFLHlCQUF5QixDQThKckM7U0E5SlkseUJBQXlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRGlyZWN0aXZlLCBFdmVudEVtaXR0ZXIsIEhvc3RMaXN0ZW5lciwgSW5wdXQsIE91dHB1dCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuXG5pbXBvcnQgeyBQb0kxOG5QaXBlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvcG8taTE4bi9wby1pMThuLnBpcGUnO1xuaW1wb3J0IHsgUG9Ob3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vc2VydmljZXMvcG8tbm90aWZpY2F0aW9uL3BvLW5vdGlmaWNhdGlvbi5zZXJ2aWNlJztcbmltcG9ydCB7IFBvVXBsb2FkTGl0ZXJhbHMgfSBmcm9tICcuLi9pbnRlcmZhY2VzL3BvLXVwbG9hZC1saXRlcmFscy5pbnRlcmZhY2UnO1xuXG5ARGlyZWN0aXZlKHtcbiAgc2VsZWN0b3I6ICdbcC11cGxvYWQtZHJhZy1kcm9wXScsXG4gIHByb3ZpZGVyczogW1BvSTE4blBpcGVdXG59KVxuZXhwb3J0IGNsYXNzIFBvVXBsb2FkRHJhZ0Ryb3BEaXJlY3RpdmUge1xuICB0aW1lb3V0OiBhbnk7XG5cbiAgcHJpdmF0ZSBmaWxlczogQXJyYXk8RmlsZT47XG4gIHByaXZhdGUgaW52YWxpZEZpbGVUeXBlOiBudW1iZXI7XG5cbiAgQElucHV0KCdwLWFyZWEtZWxlbWVudCcpIGFyZWFFbGVtZW50OiBIVE1MRWxlbWVudDtcblxuICBASW5wdXQoJ3AtZGlyZWN0b3J5LWNvbXBhdGlibGUnKSBkaXJlY3RvcnlDb21wYXRpYmxlOiBib29sZWFuO1xuXG4gIEBJbnB1dCgncC1kaXNhYmxlZCcpIGRpc2FibGVkOiBib29sZWFuO1xuXG4gIEBJbnB1dCgncC1saXRlcmFscycpIGxpdGVyYWxzOiBQb1VwbG9hZExpdGVyYWxzO1xuXG4gIEBPdXRwdXQoJ3AtZHJhZy1sZWF2ZScpIGRyYWdMZWF2ZTogRXZlbnRFbWl0dGVyPGFueT4gPSBuZXcgRXZlbnRFbWl0dGVyPGFueT4oKTtcblxuICBAT3V0cHV0KCdwLWRyYWctb3ZlcicpIGRyYWdPdmVyOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIEBPdXRwdXQoJ3AtZmlsZS1jaGFuZ2UnKSBmaWxlQ2hhbmdlOiBFdmVudEVtaXR0ZXI8YW55PiA9IG5ldyBFdmVudEVtaXR0ZXI8YW55PigpO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgaTE4blBpcGU6IFBvSTE4blBpcGUsIHByaXZhdGUgbm90aWZpY2F0aW9uOiBQb05vdGlmaWNhdGlvblNlcnZpY2UpIHt9XG5cbiAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6ZHJhZ2xlYXZlJywgWyckZXZlbnQnXSkgb25EcmFnTGVhdmUoZXZlbnQpIHtcbiAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuICAgIGV2ZW50LnN0b3BQcm9wYWdhdGlvbigpO1xuXG4gICAgdGhpcy50aW1lb3V0ID0gc2V0VGltZW91dCgoKSA9PiB0aGlzLmRyYWdMZWF2ZS5lbWl0KCksIDMwKTtcbiAgfVxuXG4gIEBIb3N0TGlzdGVuZXIoJ2RvY3VtZW50OmRyYWdvdmVyJywgWyckZXZlbnQnXSkgb25EcmFnT3ZlcihldmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICBjbGVhclRpbWVvdXQodGhpcy50aW1lb3V0KTtcblxuICAgIGlmICghdGhpcy5kaXNhYmxlZCkge1xuICAgICAgdGhpcy5kcmFnT3Zlci5lbWl0KCk7XG4gICAgfVxuICB9XG5cbiAgQEhvc3RMaXN0ZW5lcignZG9jdW1lbnQ6ZHJvcCcsIFsnJGV2ZW50J10pIG9uRHJvcChldmVudCkge1xuICAgIGV2ZW50LnByZXZlbnREZWZhdWx0KCk7XG4gICAgZXZlbnQuc3RvcFByb3BhZ2F0aW9uKCk7XG5cbiAgICB0aGlzLmdldEZpbGVzRnJvbURhdGFUcmFuc2Zlckl0ZW1zKGV2ZW50KTtcbiAgICB0aGlzLmRyYWdMZWF2ZS5lbWl0KCk7XG4gIH1cblxuICBwcml2YXRlIGdldEZpbGVzRnJvbURhdGFUcmFuc2Zlckl0ZW1zKGV2ZW50OiBEcmFnRXZlbnQpIHtcbiAgICBpZiAoIXRoaXMuZGlzYWJsZWQpIHtcbiAgICAgIHRoaXMuaW52YWxpZEZpbGVUeXBlID0gMDtcbiAgICAgIGlmICh0aGlzLmRpcmVjdG9yeUNvbXBhdGlibGUpIHtcbiAgICAgICAgdGhpcy5nZXRPbmx5RGlyZWN0b3JpZXMoZXZlbnQuZGF0YVRyYW5zZmVyLml0ZW1zKS50aGVuKCgpID0+IHtcbiAgICAgICAgICB0aGlzLnNlbmRGaWxlcyhldmVudCwgdGhpcy5maWxlcyk7XG4gICAgICAgIH0pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgZmlsZXMgPSB0aGlzLmdldE9ubHlGaWxlcyhldmVudC5kYXRhVHJhbnNmZXIuZmlsZXMpO1xuICAgICAgICB0aGlzLnNlbmRGaWxlcyhldmVudCwgZmlsZXMpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8vIGFuYWxpc2EgYXMgZW50cmFkYXMgcmVjdXJzaXZhbWVudGVcbiAgcHJpdmF0ZSBhc3luYyBnZXRGaWxlc0Zyb21FbnRyeShlbnRyeSkge1xuICAgIGlmIChlbnRyeS5pc0ZpbGUpIHtcbiAgICAgIGNvbnN0IGZpbGUgPSBhd2FpdCB0aGlzLnJlYWRGaWxlKGVudHJ5KTtcbiAgICAgIHJldHVybiBbZmlsZV07XG4gICAgfSBlbHNlIGlmIChlbnRyeS5pc0RpcmVjdG9yeSkge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucmVhZERpcmVjdG9yeShlbnRyeSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRPbmx5RGlyZWN0b3JpZXMoZGF0YVRyYW5zZmVySXRlbXMpIHtcbiAgICBjb25zdCBlbnRyaWVzID0gW107XG5cbiAgICAvLyBsaXN0YSB0b2RhcyBhcyBlbnRyYWRhcyBhbnRlcyBkZSBhbmFsaXPDoS1sYXNcbiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgZGF0YVRyYW5zZmVySXRlbXMpIHtcbiAgICAgIGVudHJpZXMucHVzaChpdGVtLndlYmtpdEdldEFzRW50cnkoKSk7XG4gICAgfVxuXG4gICAgdGhpcy5maWxlcyA9IFtdO1xuICAgIGZvciAoY29uc3QgZW50cnkgb2YgZW50cmllcykge1xuICAgICAgaWYgKGVudHJ5LmlzRmlsZSkge1xuICAgICAgICB0aGlzLmludmFsaWRGaWxlVHlwZSsrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc3QgbmV3RmlsZXMgPSBhd2FpdCB0aGlzLmdldEZpbGVzRnJvbUVudHJ5KGVudHJ5KTtcbiAgICAgICAgdGhpcy5maWxlcyA9IHRoaXMuZmlsZXMuY29uY2F0KG5ld0ZpbGVzKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvLyByZXR1cm4gb25seSBmaWxlcy4gSWYgaXQgaXMgYSBkaXJlY3RvcnksIGludmFsaWRGaWxlVHlwZSBjb3VudHMuXG4gIHByaXZhdGUgZ2V0T25seUZpbGVzKGZpbGVMaXN0OiBGaWxlTGlzdCk6IEFycmF5PEZpbGU+IHtcbiAgICByZXR1cm4gQXJyYXkuZnJvbShmaWxlTGlzdCkucmVkdWNlKChuZXdGaWxlcywgZmlsZSkgPT4ge1xuICAgICAgaWYgKGZpbGUudHlwZSkge1xuICAgICAgICByZXR1cm4gbmV3RmlsZXMuY29uY2F0KGZpbGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhpcy5pbnZhbGlkRmlsZVR5cGUrKztcbiAgICAgIH1cbiAgICAgIHJldHVybiBuZXdGaWxlcztcbiAgICB9LCBbXSk7XG4gIH1cblxuICBwcml2YXRlIHJlYWRGaWxlKGVudHJ5KSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgZW50cnkuZmlsZShmaWxlID0+IHtcbiAgICAgICAgcmVzb2x2ZShmaWxlKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZWFkRGlyZWN0b3J5KGVudHJ5KSB7XG4gICAgY29uc3QgZGlyUmVhZGVyID0gZW50cnkuY3JlYXRlUmVhZGVyKCk7XG4gICAgbGV0IGZpbGVzID0gW107XG4gICAgbGV0IG5ld0ZpbGVzO1xuXG4gICAgbmV3RmlsZXMgPSBhd2FpdCB0aGlzLnJlYWREaXJlY3RvcnlFbnRyaWVzKGRpclJlYWRlcik7XG4gICAgZmlsZXMgPSBmaWxlcy5jb25jYXQobmV3RmlsZXMpO1xuICAgIHJldHVybiBmaWxlcztcbiAgfVxuXG4gIHByaXZhdGUgcmVhZERpcmVjdG9yeUVudHJpZXMoZGlyUmVhZGVyKSB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKHJlc29sdmUgPT4ge1xuICAgICAgZGlyUmVhZGVyLnJlYWRFbnRyaWVzKGFzeW5jIGVudHJpZXMgPT4ge1xuICAgICAgICBsZXQgZmlsZXMgPSBbXTtcbiAgICAgICAgZm9yIChjb25zdCBlbnRyeSBvZiBlbnRyaWVzKSB7XG4gICAgICAgICAgY29uc3QgaXRlbUZpbGVzID0gYXdhaXQgdGhpcy5nZXRGaWxlc0Zyb21FbnRyeShlbnRyeSk7XG4gICAgICAgICAgZmlsZXMgPSBmaWxlcy5jb25jYXQoaXRlbUZpbGVzKTtcbiAgICAgICAgfVxuICAgICAgICByZXNvbHZlKGZpbGVzKTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBzZW5kRmVlZGJhY2soaW52YWxpZEZpbGVzOiBudW1iZXIpIHtcbiAgICBpZiAoaW52YWxpZEZpbGVzKSB7XG4gICAgICB0aGlzLnNldFBpcGVBcmd1bWVudHMoJ2ludmFsaWRGaWxlVHlwZScsIGludmFsaWRGaWxlcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZW5kRmlsZXMoZXZlbnQsIGZpbGVzKSB7XG4gICAgaWYgKHRoaXMuYXJlYUVsZW1lbnQuY29udGFpbnMoZXZlbnQudGFyZ2V0KSkge1xuICAgICAgaWYgKGZpbGVzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgdGhpcy5maWxlQ2hhbmdlLmVtaXQoZmlsZXMpO1xuICAgICAgfVxuXG4gICAgICB0aGlzLnNlbmRGZWVkYmFjayh0aGlzLmludmFsaWRGaWxlVHlwZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IGludmFsaWREcm9wQXJlYUFyZyA9IHRoaXMuZGlyZWN0b3J5Q29tcGF0aWJsZSA/IHRoaXMubGl0ZXJhbHMuZm9sZGVycyA6IHRoaXMubGl0ZXJhbHMuZmlsZXM7XG4gICAgICB0aGlzLnNldFBpcGVBcmd1bWVudHMoJ2ludmFsaWREcm9wQXJlYScsIGludmFsaWREcm9wQXJlYUFyZyk7XG4gICAgfVxuICB9XG5cbiAgLy8gbcOpdG9kbyByZXNwb25zw6F2ZWwgcG9yIHNldGFyIG9zIGFyZ3VtZW50b3MgZG8gaTE4blBpcGUuXG4gIHByaXZhdGUgc2V0UGlwZUFyZ3VtZW50cyhsaXRlcmFsQXR0cmlidXRlczogc3RyaW5nLCBhcmdzPykge1xuICAgIGNvbnN0IHBpcGVBcmd1bWVudHMgPSB0aGlzLmkxOG5QaXBlLnRyYW5zZm9ybSh0aGlzLmxpdGVyYWxzW2xpdGVyYWxBdHRyaWJ1dGVzXSwgYXJncyk7XG4gICAgdGhpcy5ub3RpZmljYXRpb24uaW5mb3JtYXRpb24ocGlwZUFyZ3VtZW50cyk7XG4gIH1cbn1cbiJdfQ==