import { __decorate, __metadata } from "tslib";
import { Component, ElementRef, Input, ViewChild } from '@angular/core';
import { convertToInt, convertToBoolean } from '../../../utils/util';
import { PoMenuItemsService } from '../services/po-menu-items.service';
// valor para que caibam 3 linhas de `label`
var poMenuItemSubItemSize = 98;
/**
 * @docsPrivate
 *
 * @description
 *
 * Componente que implementa cada item do po-menu.
 */
var PoMenuItemComponent = /** @class */ (function () {
    function PoMenuItemComponent(menuItemsService) {
        this.menuItemsService = menuItemsService;
        this._isSelected = false;
        this._isSubItem = false;
        this.maxHeight = 0;
    }
    Object.defineProperty(PoMenuItemComponent.prototype, "badgeValue", {
        get: function () {
            return this._badgeValue;
        },
        // Valor do badge.
        set: function (badgeValue) {
            this._badgeValue = convertToInt(badgeValue);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "isSelected", {
        get: function () {
            return this._isSelected;
        },
        // Indica se o item está selecionado.
        set: function (value) {
            this._isSelected = convertToBoolean(value);
            this.isSelectedSubItem = this.isSelected && this.isSubItem;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "isSubItem", {
        get: function () {
            return this._isSubItem;
        },
        // Indica se o item é um sub item
        set: function (value) {
            this._isSubItem = convertToBoolean(value);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "subItems", {
        get: function () {
            return this._subItems;
        },
        // Lista de sub-items.
        set: function (subitems) {
            this._subItems = subitems;
            if (this.isOpened) {
                this.calcMenuSubItemsMaxHeight();
            }
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoMenuItemComponent.prototype, "canShowBadge", {
        get: function () {
            return this.type !== 'subItems' && (this.badgeValue || this.badgeValue === 0) && this.badgeValue >= 0;
        },
        enumerable: true,
        configurable: true
    });
    PoMenuItemComponent.prototype.ngOnDestroy = function () {
        this.itemSubscription.unsubscribe();
    };
    PoMenuItemComponent.prototype.ngOnInit = function () {
        var _this = this;
        // subscribe to menu component messages
        this.itemSubscription = this.menuItemsService.receiveFromParentMenuClicked().subscribe(function (menu) {
            _this.processMenuItem(menu);
        });
    };
    PoMenuItemComponent.prototype.clickMenuItem = function (event) {
        if (!(event.ctrlKey || event.metaKey)) {
            event.preventDefault();
            // Emmit to parent
            this.menuItemsService.sendToParentMenuClicked({
                link: this.link,
                action: this.action,
                id: this.id,
                icon: this.icon,
                label: this.label,
                level: this.level,
                subItems: this.subItems,
                isSelected: this.isSelected,
                isOpened: this.isOpened,
                shortLabel: this.shortLabel,
                type: this.type
            });
        }
    };
    PoMenuItemComponent.prototype.accordionAnimation = function (menuActive, menuOpened, hasSubItemOpened, activatedByRoute) {
        if (this.id === menuOpened['id']) {
            this.maxHeight = this.subItems.length * poMenuItemSubItemSize;
        }
        if (hasSubItemOpened) {
            this.maxHeight = menuOpened['isOpened']
                ? this.maxHeight + menuOpened.subItems.length * poMenuItemSubItemSize
                : this.maxHeight - menuOpened.subItems.length * poMenuItemSubItemSize;
            if (activatedByRoute) {
                this.maxHeight = this.getMinimumHeight(0, this, menuActive);
            }
        }
    };
    PoMenuItemComponent.prototype.activateMenu = function (menu) {
        this.isSelected = menu && this.id === menu.id;
    };
    PoMenuItemComponent.prototype.calcMenuSubItemsMaxHeight = function () {
        var _this = this;
        setTimeout(function () {
            var subItems = Array.from(_this.menuSubItems.nativeElement.querySelectorAll('.po-menu-item'));
            subItems.forEach(function (menuItem) { return (_this.maxHeight += menuItem.offsetHeight); });
        });
    };
    PoMenuItemComponent.prototype.getMinimumHeight = function (minimumHeight, menuItem, menuActive) {
        minimumHeight += poMenuItemSubItemSize;
        if (menuItem.subItems && this.hasSubItem(menuItem.subItems, menuActive['id'])) {
            for (var index = 0; index < menuItem.subItems.length; index++) {
                minimumHeight = this.getMinimumHeight(minimumHeight, menuItem.subItems[index], menuActive);
            }
        }
        return minimumHeight;
    };
    PoMenuItemComponent.prototype.groupedMenu = function (menuActive, menuOpened, activatedByRoute) {
        if (activatedByRoute === void 0) { activatedByRoute = false; }
        var hasSubItemOpened = menuOpened && this.id !== menuOpened['id'] ? this.hasSubItem(this.subItems, menuOpened['id']) : false;
        this.isOpened = this.isMenuOpened(menuOpened, hasSubItemOpened);
        this.isSelected = menuActive && !this.isOpened ? this.hasSubItem(this.subItems, menuActive['id']) : false;
        if (!this.isOpened) {
            this.maxHeight = 0;
            return;
        }
        this.accordionAnimation(menuActive, menuOpened, hasSubItemOpened, activatedByRoute);
    };
    PoMenuItemComponent.prototype.hasSubItem = function (subItems, id) {
        var _this = this;
        if (subItems) {
            return subItems.some(function (item) {
                return item['id'] === id ? true : _this.hasSubItem(item.subItems, id);
            });
        }
    };
    PoMenuItemComponent.prototype.isMenuOpened = function (menuOpened, hasSubItemOpened) {
        if (menuOpened) {
            return this.id === menuOpened['id'] ? menuOpened['isOpened'] : hasSubItemOpened;
        }
        return false;
    };
    PoMenuItemComponent.prototype.processMenuItem = function (menu) {
        if (this.type === 'internalLink') {
            this.activateMenu(menu.active);
            return;
        }
        if (this.type === 'subItems') {
            this.groupedMenu(menu.active, menu.grouped, menu.activatedByRoute);
            return;
        }
    };
    PoMenuItemComponent.ctorParameters = function () { return [
        { type: PoMenuItemsService }
    ]; };
    __decorate([
        Input('p-action'),
        __metadata("design:type", Object)
    ], PoMenuItemComponent.prototype, "action", void 0);
    __decorate([
        Input('p-badge-alert'),
        __metadata("design:type", Boolean)
    ], PoMenuItemComponent.prototype, "badgeAlert", void 0);
    __decorate([
        Input('p-badge-color'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "badgeColor", void 0);
    __decorate([
        Input('p-badge-value'),
        __metadata("design:type", Number),
        __metadata("design:paramtypes", [Number])
    ], PoMenuItemComponent.prototype, "badgeValue", null);
    __decorate([
        Input('p-collapsed-menu'),
        __metadata("design:type", Boolean)
    ], PoMenuItemComponent.prototype, "collapsedMenu", void 0);
    __decorate([
        Input('p-icon'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "icon", void 0);
    __decorate([
        Input('p-id'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "id", void 0);
    __decorate([
        Input('p-is-opened'),
        __metadata("design:type", Boolean)
    ], PoMenuItemComponent.prototype, "isOpened", void 0);
    __decorate([
        Input('p-is-selected'),
        __metadata("design:type", Boolean),
        __metadata("design:paramtypes", [Boolean])
    ], PoMenuItemComponent.prototype, "isSelected", null);
    __decorate([
        Input('p-is-sub-item'),
        __metadata("design:type", Boolean),
        __metadata("design:paramtypes", [Boolean])
    ], PoMenuItemComponent.prototype, "isSubItem", null);
    __decorate([
        Input('p-label'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "label", void 0);
    __decorate([
        Input('p-level'),
        __metadata("design:type", Number)
    ], PoMenuItemComponent.prototype, "level", void 0);
    __decorate([
        Input('p-link'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "link", void 0);
    __decorate([
        Input('p-short-label'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "shortLabel", void 0);
    __decorate([
        Input('p-sub-items'),
        __metadata("design:type", Array),
        __metadata("design:paramtypes", [Array])
    ], PoMenuItemComponent.prototype, "subItems", null);
    __decorate([
        Input('p-type'),
        __metadata("design:type", String)
    ], PoMenuItemComponent.prototype, "type", void 0);
    __decorate([
        ViewChild('menuSubItems'),
        __metadata("design:type", ElementRef)
    ], PoMenuItemComponent.prototype, "menuSubItems", void 0);
    PoMenuItemComponent = __decorate([
        Component({
            selector: 'po-menu-item',
            template: "<!-- menu com link interno -->\n<a *ngIf=\"type === 'internalLink'\" class=\"po-menu-item-link\" [routerLink]=\"link\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu com link externo -->\n<a *ngIf=\"type === 'externalLink'\" class=\"po-menu-item-link\" [href]=\"link\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu sem link -->\n<a *ngIf=\"type === 'noLink'\" class=\"po-menu-item-link\" href=\"javascript:;\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n</a>\n<!-- menu com sub itens -->\n<div *ngIf=\"type === 'subItems'\" class=\"po-menu-item-link po-clickable\">\n  <ng-container *ngTemplateOutlet=\"menuItemTemplate\"></ng-container>\n  <div #menuSubItems class=\"po-menu-sub-items\" [hidden]=\"collapsedMenu\" [style.maxHeight.px]=\"maxHeight\">\n    <div *ngFor=\"let subItem of subItems\">\n      <po-menu-item\n        p-is-sub-item\n        [p-action]=\"subItem.action\"\n        [p-badge-alert]=\"subItem.badgeAlert\"\n        [p-badge-color]=\"subItem.badge ? subItem.badge.color : undefined\"\n        [p-badge-value]=\"subItem.badge ? subItem.badge.value : undefined\"\n        [p-id]=\"subItem.id\"\n        [p-label]=\"subItem.label\"\n        [p-level]=\"subItem.level\"\n        [p-link]=\"subItem.link\"\n        [p-sub-items]=\"subItem.subItems\"\n        [p-type]=\"subItem.type\"\n      >\n      </po-menu-item>\n    </div>\n  </div>\n</div>\n\n<ng-template #menuItemTemplate>\n  <div\n    class=\"po-menu-item\"\n    [class.po-menu-icon-container]=\"level === 1 && icon\"\n    [class.po-menu-item-selected]=\"isSelected\"\n    [class.po-menu-item-level-two]=\"level === 2\"\n    [class.po-menu-item-level-three]=\"level === 3\"\n    [class.po-menu-item-level-four]=\"level === 4\"\n    [class.po-menu-item-grouper-up]=\"type === 'subItems' && isOpened\"\n    [class.po-menu-item-grouper-down]=\"type === 'subItems' && !isOpened\"\n    [class.po-menu-sub-item-selected]=\"isSelectedSubItem\"\n    (click)=\"clickMenuItem($event)\"\n  >\n    <po-badge\n      *ngIf=\"canShowBadge\"\n      [ngClass]=\"!collapsedMenu ? 'po-menu-badge-align' : 'po-menu-badge-align-collapsed'\"\n      [p-color]=\"badgeColor\"\n      [p-value]=\"badgeValue\"\n    >\n    </po-badge>\n    <span *ngIf=\"level === 1 && icon\" class=\"po-icon {{ icon }} po-menu-icon-item\"></span>\n    <div\n      *ngIf=\"badgeAlert\"\n      class=\"po-color-07\"\n      [ngClass]=\"!collapsedMenu ? 'po-menu-badge-alert' : 'po-menu-badge-alert-collapsed'\"\n    ></div>\n    <span\n      *ngIf=\"type === 'subItems' && !collapsedMenu\"\n      class=\"po-icon po-menu-group-icon\"\n      [class.po-icon-arrow-up]=\"isOpened\"\n      [class.po-icon-arrow-down]=\"!isOpened\"\n    >\n    </span>\n    <div [class.po-menu-icon-label]=\"level === 1 && icon\">\n      {{ label }}\n    </div>\n    <div *ngIf=\"collapsedMenu\" class=\"po-menu-short-label\">{{ shortLabel }}</div>\n  </div>\n</ng-template>\n"
        }),
        __metadata("design:paramtypes", [PoMenuItemsService])
    ], PoMenuItemComponent);
    return PoMenuItemComponent;
}());
export { PoMenuItemComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tbWVudS1pdGVtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwby11aS9uZy1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tbWVudS9wby1tZW51LWl0ZW0vcG8tbWVudS1pdGVtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxVQUFVLEVBQUUsS0FBSyxFQUFxQixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0YsT0FBTyxFQUFFLFlBQVksRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBR3JFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBRXZFLDRDQUE0QztBQUM1QyxJQUFNLHFCQUFxQixHQUFHLEVBQUUsQ0FBQztBQUVqQzs7Ozs7O0dBTUc7QUFLSDtJQTZGRSw2QkFBb0IsZ0JBQW9DO1FBQXBDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBb0I7UUEzRmhELGdCQUFXLEdBQVksS0FBSyxDQUFDO1FBQzdCLGVBQVUsR0FBWSxLQUFLLENBQUM7UUFJcEMsY0FBUyxHQUFXLENBQUMsQ0FBQztJQXNGcUMsQ0FBQztJQXhFcEMsc0JBQUksMkNBQVU7YUFJdEM7WUFDRSxPQUFPLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDMUIsQ0FBQztRQVBELGtCQUFrQjthQUNNLFVBQWUsVUFBa0I7WUFDdkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxZQUFZLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDOUMsQ0FBQzs7O09BQUE7SUFtQnVCLHNCQUFJLDJDQUFVO2FBS3RDO1lBQ0UsT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO1FBQzFCLENBQUM7UUFSRCxxQ0FBcUM7YUFDYixVQUFlLEtBQWM7WUFDbkQsSUFBSSxDQUFDLFdBQVcsR0FBRyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUUzQyxJQUFJLENBQUMsaUJB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USxDQUFDOztxREFBYztJQUdmO1FBQWQsS0FBSyxDQUFDLE1BQU0sQ0FBQzs7bURBQVk7SUFHSjtRQUFyQixLQUFLLENBQUMsYUFBYSxDQUFDOzt5REFBbUI7SUFHaEI7UUFBdkIsS0FBSyxDQUFDLGVBQWUsQ0FBQzs7O3lEQUl0QjtJQU11QjtRQUF2QixLQUFLLENBQUMsZUFBZSxDQUFDOzs7d0RBRXRCO0lBT2lCO1FBQWpCLEtBQUssQ0FBQyxTQUFTLENBQUM7O3NEQUFlO0lBR2Q7UUFBakIsS0FBSyxDQUFDLFNBQVMsQ0FBQzs7c0RBQWU7SUFHZjtRQUFoQixLQUFLLENBQUMsUUFBUSxDQUFDOztxREFBZTtJQUdQO1FBQXZCLEtBQUssQ0FBQyxlQUFlLENBQUM7OzJEQUFvQjtJQUdyQjtRQUFyQixLQUFLLENBQUMsYUFBYSxDQUFDO2tDQUF3QixLQUFLO3lDQUFMLEtBQUs7dURBS2pEO0lBT2dCO1FBQWhCLEtBQUssQ0FBQyxRQUFRLENBQUM7O3FEQUFjO0lBRUg7UUFBMUIsU0FBUyxDQUFDLGNBQWMsQ0FBQztrQ0FBZSxVQUFVOzZEQUFDO0lBdkZ6QyxtQkFBbUI7UUFKL0IsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLGNBQWM7WUFDeEIscThGQUE0QztTQUM3QyxDQUFDO3lDQThGc0Msa0JBQWtCO09BN0Y3QyxtQkFBbUIsQ0FxTi9CO0lBQUQsMEJBQUM7Q0FBQSxBQXJORCxJQXFOQztTQXJOWSxtQkFBbUIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnQsIEVsZW1lbnRSZWYsIElucHV0LCBPbkRlc3Ryb3ksIE9uSW5pdCwgVmlld0NoaWxkIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuXG5pbXBvcnQgeyBjb252ZXJ0VG9JbnQsIGNvbnZlcnRUb0Jvb2xlYW4gfSBmcm9tICcuLi8uLi8uLi91dGlscy91dGlsJztcblxuaW1wb3J0IHsgUG9NZW51SXRlbSB9IGZyb20gJy4uL3BvLW1lbnUtaXRlbS5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9NZW51SXRlbXNTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmljZXMvcG8tbWVudS1pdGVtcy5zZXJ2aWNlJztcblxuLy8gdmFsb3IgcGFyYSBxdWUgY2FpYmFtIDMgbGluaGFzIGRlIGBsYWJlbGBcbmNvbnN0IHBvTWVudUl0ZW1TdWJJdGVtU2l6ZSA9IDk4O1xuXG4vKipcbiAqIEBkb2NzUHJpdmF0ZVxuICpcbiAqIEBkZXNjcmlwdGlvblxuICpcbiAqIENvbXBvbmVudGUgcXVlIGltcGxlbWVudGEgY2FkYSBpdGVtIGRvIHBvLW1lbnUuXG4gKi9cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLW1lbnUtaXRlbScsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1tZW51LWl0ZW0uY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvTWVudUl0ZW1Db21wb25lbnQgaW1wbGVtZW50cyBPbkRlc3Ryb3ksIE9uSW5pdCB7XG4gIHByaXZhdGUgX2JhZGdlVmFsdWU6IG51bWJlcjtcbiAgcHJpdmF0ZSBfaXNTZWxlY3RlZDogYm9vbGVhbiA9IGZhbHNlO1xuICBwcml2YXRlIF9pc1N1Ykl0ZW06IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBfc3ViSXRlbXM6IEFycmF5PFBvTWVudUl0ZW0+O1xuXG4gIGlzU2VsZWN0ZWRTdWJJdGVtO1xuICBtYXhIZWlnaHQ6IG51bWJlciA9IDA7XG5cbiAgcHJpdmF0ZSBpdGVtU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG5cbiAgLy8gQcOnw6NvIHF1ZSBzZXLDoSBjaGFtYWRhIGFvIGNsaWNhciBubyBpdGVtLlxuICBASW5wdXQoJ3AtYWN0aW9uJykgYWN0aW9uOiBzdHJpbmcgfCBGdW5jdGlvbjtcblxuICAvLyBJbmRpY2Egc2UgY29udMOpbSBhbGd1bSBpdGVtIGZpbGhvIGNvbSBvIGJhZGdlLlxuICBASW5wdXQoJ3AtYmFkZ2UtYWxlcnQnKSBiYWRnZUFsZXJ0OiBib29sZWFuO1xuXG4gIC8vIENvciBkbyBiYWRnZS5cbiAgQElucHV0KCdwLWJhZGdlLWNvbG9yJykgYmFkZ2VDb2xvcjogc3RyaW5nO1xuXG4gIC8vIFZhbG9yIGRvIGJhZGdlLlxuICBASW5wdXQoJ3AtYmFkZ2UtdmFsdWUnKSBzZXQgYmFkZ2VWYWx1ZShiYWRnZVZhbHVlOiBudW1iZXIpIHtcbiAgICB0aGlzLl9iYWRnZVZhbHVlID0gY29udmVydFRvSW50KGJhZGdlVmFsdWUpO1xuICB9XG5cbiAgZ2V0IGJhZGdlVmFsdWUoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2JhZGdlVmFsdWU7XG4gIH1cblxuICAvLyBJbmRpY2Egc2UgbyBtZW51IGVzdMOhIGNvbGFwc2Fkb1xuICBASW5wdXQoJ3AtY29sbGFwc2VkLW1lbnUnKSBjb2xsYXBzZWRNZW51OiBib29sZWFuO1xuXG4gIC8vIMONY29uZSBkZSBtZW51XG4gIEBJbnB1dCgncC1pY29uJykgaWNvbjogc3RyaW5nO1xuXG4gIC8vIElkZW50aWZpY2Fkb3IgZG8gaXRlbS5cbiAgQElucHV0KCdwLWlkJykgaWQ6IHN0cmluZztcblxuICAvLyBJbmRpY2Egc2UgbyBpdGVtIGVzdMOhIGFiZXJ0byAobWVudSBhZ3J1cGFkbylcbiAgQElucHV0KCdwLWlzLW9wZW5lZCcpIGlzT3BlbmVkOiBib29sZWFuO1xuXG4gIC8vIEluZGljYSBzZSBvIGl0ZW0gZXN0w6Egc2VsZWNpb25hZG8uXG4gIEBJbnB1dCgncC1pcy1zZWxlY3RlZCcpIHNldCBpc1NlbGVjdGVkKHZhbHVlOiBib29sZWFuKSB7XG4gICAgdGhpcy5faXNTZWxlY3RlZCA9IGNvbnZlcnRUb0Jvb2xlYW4odmFsdWUpO1xuXG4gICAgdGhpcy5pc1NlbGVjdGVkU3ViSXRlbSA9IHRoaXMuaXNTZWxlY3RlZCAmJiB0aGlzLmlzU3ViSXRlbTtcbiAgfVxuICBnZXQgaXNTZWxlY3RlZCgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNTZWxlY3RlZDtcbiAgfVxuXG4gIC8vIEluZGljYSBzZSBvIGl0ZW0gw6kgdW0gc3ViIGl0ZW1cbiAgQElucHV0KCdwLWlzLXN1Yi1pdGVtJykgc2V0IGlzU3ViSXRlbSh2YWx1ZTogYm9vbGVhbikge1xuICAgIHRoaXMuX2lzU3ViSXRlbSA9IGNvbnZlcnRUb0Jvb2xlYW4odmFsdWUpO1xuICB9XG5cbiAgZ2V0IGlzU3ViSXRlbSgpIHtcbiAgICByZXR1cm4gdGhpcy5faXNTdWJJdGVtO1xuICB9XG5cbiAgLy8gVGV4dG8gcXVlIGFwYXJlY2Vyw6EgcmVwcmVzZW50YW5kbyBvIGl0ZW0uXG4gIEBJbnB1dCgncC1sYWJlbCcpIGxhYmVsOiBzdHJpbmc7XG5cbiAgLy8gSW5kaWNhIHF1YWwgZW0gbsOtdmVsIGRvIHBvLW1lbnUgZW5jb250cmEtc2UuXG4gIEBJbnB1dCgncC1sZXZlbCcpIGxldmVsOiBudW1iZXI7XG5cbiAgLy8gTGluayBkbyBpdGVtLlxuICBASW5wdXQoJ3AtbGluaycpIGxpbms/OiBzdHJpbmc7XG5cbiAgLy8gVGV4dG8gcXVlIGFwYXJlY2Vyw6EgcmVwcmVzZW50YW5kbyBvIGl0ZW0uXG4gIEBJbnB1dCgncC1zaG9ydC1sYWJlbCcpIHNob3J0TGFiZWw6IHN0cmluZztcblxuICAvLyBMaXN0YSBkZSBzdWItaXRlbXMuXG4gIEBJbnB1dCgncC1zdWItaXRlbXMnKSBzZXQgc3ViSXRlbXMoc3ViaXRlbXM6IEFycmF5PFBvTWVudUl0ZW0+KSB7XG4gICAgdGhpcy5fc3ViSXRlbXMgPSBzdWJpdGVtcztcbiAgICBpZiAodGhpcy5pc09wZW5lZCkge1xuICAgICAgdGhpcy5jYWxjTWVudVN1Ykl0ZW1zTWF4SGVpZ2h0KCk7XG4gICAgfVxuICB9XG5cbiAgZ2V0IHN1Ykl0ZW1zKCkge1xuICAgIHJldHVybiB0aGlzLl9zdWJJdGVtcztcbiAgfVxuXG4gIC8vIEluZGljYSBvIHRpcG8gZGUgaXRlbSwgY29tbyAnaW50ZXJuYWxMaW5rJyBvdSAnc3ViSXRlbXMnLlxuICBASW5wdXQoJ3AtdHlwZScpIHR5cGU6IHN0cmluZztcblxuICBAVmlld0NoaWxkKCdtZW51U3ViSXRlbXMnKSBtZW51U3ViSXRlbXM6IEVsZW1lbnRSZWY7XG5cbiAgZ2V0IGNhblNob3dCYWRnZSgpIHtcbiAgICByZXR1cm4gdGhpcy50eXBlICE9PSAnc3ViSXRlbXMnICYmICh0aGlzLmJhZGdlVmFsdWUgfHwgdGhpcy5iYWRnZVZhbHVlID09PSAwKSAmJiB0aGlzLmJhZGdlVmFsdWUgPj0gMDtcbiAgfVxuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgbWVudUl0ZW1zU2VydmljZTogUG9NZW51SXRlbXNTZXJ2aWNlKSB7fVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuaXRlbVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgLy8gc3Vic2NyaWJlIHRvIG1lbnUgY29tcG9uZW50IG1lc3NhZ2VzXG4gICAgdGhpcy5pdGVtU3Vic2NyaXB0aW9uID0gdGhpcy5tZW51SXRlbXNTZXJ2aWNlLnJlY2VpdmVGcm9tUGFyZW50TWVudUNsaWNrZWQoKS5zdWJzY3JpYmUobWVudSA9PiB7XG4gICAgICB0aGlzLnByb2Nlc3NNZW51SXRlbShtZW51KTtcbiAgICB9KTtcbiAgfVxuXG4gIGNsaWNrTWVudUl0ZW0oZXZlbnQpOiB2b2lkIHtcbiAgICBpZiAoIShldmVudC5jdHJsS2V5IHx8IGV2ZW50Lm1ldGFLZXkpKSB7XG4gICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xuXG4gICAgICAvLyBFbW1pdCB0byBwYXJlbnRcbiAgICAgIHRoaXMubWVudUl0ZW1zU2VydmljZS5zZW5kVG9QYXJlbnRNZW51Q2xpY2tlZCh7XG4gICAgICAgIGxpbms6IHRoaXMubGluayxcbiAgICAgICAgYWN0aW9uOiB0aGlzLmFjdGlvbixcbiAgICAgICAgaWQ6IHRoaXMuaWQsXG4gICAgICAgIGljb246IHRoaXMuaWNvbixcbiAgICAgICAgbGFiZWw6IHRoaXMubGFiZWwsXG4gICAgICAgIGxldmVsOiB0aGlzLmxldmVsLFxuICAgICAgICBzdWJJdGVtczogdGhpcy5zdWJJdGVtcyxcbiAgICAgICAgaXNTZWxlY3RlZDogdGhpcy5pc1NlbGVjdGVkLFxuICAgICAgICBpc09wZW5lZDogdGhpcy5pc09wZW5lZCxcbiAgICAgICAgc2hvcnRMYWJlbDogdGhpcy5zaG9ydExhYmVsLFxuICAgICAgICB0eXBlOiB0aGlzLnR5cGVcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYWNjb3JkaW9uQW5pbWF0aW9uKFxuICAgIG1lbnVBY3RpdmU6IFBvTWVudUl0ZW0sXG4gICAgbWVudU9wZW5lZDogUG9NZW51SXRlbSxcbiAgICBoYXNTdWJJdGVtT3BlbmVkOiBib29sZWFuLFxuICAgIGFjdGl2YXRlZEJ5Um91dGU6IGJvb2xlYW5cbiAgKSB7XG4gICAgaWYgKHRoaXMuaWQgPT09IG1lbnVPcGVuZWRbJ2lkJ10pIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gdGhpcy5zdWJJdGVtcy5sZW5ndGggKiBwb01lbnVJdGVtU3ViSXRlbVNpemU7XG4gICAgfVxuXG4gICAgaWYgKGhhc1N1Ykl0ZW1PcGVuZWQpIHtcbiAgICAgIHRoaXMubWF4SGVpZ2h0ID0gbWVudU9wZW5lZFsnaXNPcGVuZWQnXVxuICAgICAgICA/IHRoaXMubWF4SGVpZ2h0ICsgbWVudU9wZW5lZC5zdWJJdGVtcy5sZW5ndGggKiBwb01lbnVJdGVtU3ViSXRlbVNpemVcbiAgICAgICAgOiB0aGlzLm1heEhlaWdodCAtIG1lbnVPcGVuZWQuc3ViSXRlbXMubGVuZ3RoICogcG9NZW51SXRlbVN1Ykl0ZW1TaXplO1xuXG4gICAgICBpZiAoYWN0aXZhdGVkQnlSb3V0ZSkge1xuICAgICAgICB0aGlzLm1heEhlaWdodCA9IHRoaXMuZ2V0TWluaW11bUhlaWdodCgwLCB0aGlzLCBtZW51QWN0aXZlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFjdGl2YXRlTWVudShtZW51OiBhbnkpOiB2b2lkIHtcbiAgICB0aGlzLmlzU2VsZWN0ZWQgPSBtZW51ICYmIHRoaXMuaWQgPT09IG1lbnUuaWQ7XG4gIH1cblxuICBwcml2YXRlIGNhbGNNZW51U3ViSXRlbXNNYXhIZWlnaHQoKSB7XG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICBjb25zdCBzdWJJdGVtcyA9IEFycmF5LmZyb20odGhpcy5tZW51U3ViSXRlbXMubmF0aXZlRWxlbWVudC5xdWVyeVNlbGVjdG9yQWxsKCcucG8tbWVudS1pdGVtJykpO1xuICAgICAgc3ViSXRlbXMuZm9yRWFjaCgobWVudUl0ZW06IGFueSkgPT4gKHRoaXMubWF4SGVpZ2h0ICs9IG1lbnVJdGVtLm9mZnNldEhlaWdodCkpO1xuICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRNaW5pbXVtSGVpZ2h0KG1pbmltdW1IZWlnaHQ6IG51bWJlciwgbWVudUl0ZW06IFBvTWVudUl0ZW0sIG1lbnVBY3RpdmU6IFBvTWVudUl0ZW0pIHtcbiAgICBtaW5pbXVtSGVpZ2h0ICs9IHBvTWVudUl0ZW1TdWJJdGVtU2l6ZTtcblxuICAgIGlmIChtZW51SXRlbS5zdWJJdGVtcyAmJiB0aGlzLmhhc1N1Ykl0ZW0obWVudUl0ZW0uc3ViSXRlbXMsIG1lbnVBY3RpdmVbJ2lkJ10pKSB7XG4gICAgICBmb3IgKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbWVudUl0ZW0uc3ViSXRlbXMubGVuZ3RoOyBpbmRleCsrKSB7XG4gICAgICAgIG1pbmltdW1IZWlnaHQgPSB0aGlzLmdldE1pbmltdW1IZWlnaHQobWluaW11bUhlaWdodCwgbWVudUl0ZW0uc3ViSXRlbXNbaW5kZXhdLCBtZW51QWN0aXZlKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWluaW11bUhlaWdodDtcbiAgfVxuXG4gIHByaXZhdGUgZ3JvdXBlZE1lbnUobWVudUFjdGl2ZTogUG9NZW51SXRlbSwgbWVudU9wZW5lZDogUG9NZW51SXRlbSwgYWN0aXZhdGVkQnlSb3V0ZTogYm9vbGVhbiA9IGZhbHNlKTogdm9pZCB7XG4gICAgY29uc3QgaGFzU3ViSXRlbU9wZW5lZCA9XG4gICAgICBtZW51T3BlbmVkICYmIHRoaXMuaWQgIT09IG1lbnVPcGVuZWRbJ2lkJ10gPyB0aGlzLmhhc1N1Ykl0ZW0odGhpcy5zdWJJdGVtcywgbWVudU9wZW5lZFsnaWQnXSkgOiBmYWxzZTtcblxuICAgIHRoaXMuaXNPcGVuZWQgPSB0aGlzLmlzTWVudU9wZW5lZChtZW51T3BlbmVkLCBoYXNTdWJJdGVtT3BlbmVkKTtcblxuICAgIHRoaXMuaXNTZWxlY3RlZCA9IG1lbnVBY3RpdmUgJiYgIXRoaXMuaXNPcGVuZWQgPyB0aGlzLmhhc1N1Ykl0ZW0odGhpcy5zdWJJdGVtcywgbWVudUFjdGl2ZVsnaWQnXSkgOiBmYWxzZTtcblxuICAgIGlmICghdGhpcy5pc09wZW5lZCkge1xuICAgICAgdGhpcy5tYXhIZWlnaHQgPSAwO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0aGlzLmFjY29yZGlvbkFuaW1hdGlvbihtZW51QWN0aXZlLCBtZW51T3BlbmVkLCBoYXNTdWJJdGVtT3BlbmVkLCBhY3RpdmF0ZWRCeVJvdXRlKTtcbiAgfVxuXG4gIHByaXZhdGUgaGFzU3ViSXRlbShzdWJJdGVtczogQXJyYXk8UG9NZW51SXRlbT4sIGlkOiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBpZiAoc3ViSXRlbXMpIHtcbiAgICAgIHJldHVybiBzdWJJdGVtcy5zb21lKGl0ZW0gPT4ge1xuICAgICAgICByZXR1cm4gaXRlbVsnaWQnXSA9PT0gaWQgPyB0cnVlIDogdGhpcy5oYXNTdWJJdGVtKGl0ZW0uc3ViSXRlbXMsIGlkKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaXNNZW51T3BlbmVkKG1lbnVPcGVuZWQ6IFBvTWVudUl0ZW0sIGhhc1N1Ykl0ZW1PcGVuZWQ6IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICBpZiAobWVudU9wZW5lZCkge1xuICAgICAgcmV0dXJuIHRoaXMuaWQgPT09IG1lbnVPcGVuZWRbJ2lkJ10gPyBtZW51T3BlbmVkWydpc09wZW5lZCddIDogaGFzU3ViSXRlbU9wZW5lZDtcbiAgICB9XG5cbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cblxuICBwcml2YXRlIHByb2Nlc3NNZW51SXRlbShtZW51KSB7XG4gICAgaWYgKHRoaXMudHlwZSA9PT0gJ2ludGVybmFsTGluaycpIHtcbiAgICAgIHRoaXMuYWN0aXZhdGVNZW51KG1lbnUuYWN0aXZlKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZiAodGhpcy50eXBlID09PSAnc3ViSXRlbXMnKSB7XG4gICAgICB0aGlzLmdyb3VwZWRNZW51KG1lbnUuYWN0aXZlLCBtZW51Lmdyb3VwZWQsIG1lbnUuYWN0aXZhdGVkQnlSb3V0ZSk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICB9XG59XG4iXX0=