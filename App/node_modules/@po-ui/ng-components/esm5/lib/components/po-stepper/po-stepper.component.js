import { __decorate, __extends, __metadata } from "tslib";
import { AfterContentInit, ChangeDetectorRef, Component, ContentChildren, QueryList } from '@angular/core';
import { Observable, of, throwError } from 'rxjs';
import { take, tap, catchError } from 'rxjs/operators';
import { PoStepperStatus } from './enums/po-stepper-status.enum';
import { PoStepComponent } from './po-step/po-step.component';
import { PoStepperBaseComponent } from './po-stepper-base.component';
/**
 * @docsExtends PoStepperBaseComponent
 *
 * @example
 *
 * <example name="po-stepper-basic" title="PO Stepper Basic">
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.html"> </file>
 *  <file name="sample-po-stepper-basic/sample-po-stepper-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-labs" title="PO Stepper Labs">
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.html"> </file>
 *  <file name="sample-po-stepper-labs/sample-po-stepper-labs.component.ts"> </file>
 * </example>
 *
 * <example name="po-stepper-sales" title="PO Stepper - Sales">
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.html"> </file>
 *  <file name="sample-po-stepper-sales/sample-po-stepper-sales.component.ts"> </file>
 * </example>
 */
var PoStepperComponent = /** @class */ (function (_super) {
    __extends(PoStepperComponent, _super);
    function PoStepperComponent(changeDetector) {
        var _this = _super.call(this) || this;
        _this.changeDetector = changeDetector;
        return _this;
    }
    Object.defineProperty(PoStepperComponent.prototype, "currentStepIndex", {
        get: function () {
            return this.step - 1;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoStepperComponent.prototype, "stepList", {
        get: function () {
            return (this.usePoSteps && this.poSteps) || this.steps;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoStepperComponent.prototype, "usePoSteps", {
        get: function () {
            return !!this.poSteps.length;
        },
        enumerable: true,
        configurable: true
    });
    PoStepperComponent.prototype.ngAfterContentInit = function () {
        var _this = this;
        this.activeFirstStep();
        this.poSteps.changes.subscribe(function () {
            _this.controlStepsStatus(0, _this.poSteps.first);
        });
    };
    /**
     * Altera o status do *step* para ativo.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     *
     * @param {number} index Índice do `po-step` que se deseja ativar.
     */
    PoStepperComponent.prototype.active = function (index) {
        if (!this.usePoSteps) {
            return;
        }
        var stepsArray = this.getPoSteps();
        var step = stepsArray[index];
        var isDisabledStep = step.status === PoStepperStatus.Disabled;
        var isErrorStep = step.status === PoStepperStatus.Error;
        if (!isDisabledStep || isErrorStep) {
            this.changeStep(index, step);
        }
    };
    /**
     * Ativa o primeiro *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    PoStepperComponent.prototype.first = function () {
        if (!this.usePoSteps) {
            return;
        }
        var firstStep = this.poSteps.first;
        var firstStepIndex = 0;
        this.changeStep(firstStepIndex, firstStep);
    };
    /**
     * Ativa o próximo *step*.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    PoStepperComponent.prototype.next = function () {
        if (!this.usePoSteps) {
            return;
        }
        var _a = this.getStepsAndIndex(this.currentActiveStep), steps = _a.steps, stepIndex = _a.stepIndex;
        var nextIndex = stepIndex + 1;
        var nextStep = steps[nextIndex];
        this.changeStep(nextIndex, nextStep);
    };
    /**
     * Ativa o *step* anterior.
     *
     * > Este método é valido apenas para as implementações que utilizam o componente [**po-step**](/documentation/po-step).
     */
    PoStepperComponent.prototype.previous = function () {
        if (!this.usePoSteps) {
            return;
        }
        var _a = this.getStepsAndIndex(this.currentActiveStep), steps = _a.steps, stepIndex = _a.stepIndex;
        var previousIndex = stepIndex - 1;
        var previousStep = steps[previousIndex];
        this.changeStep(previousIndex, previousStep);
    };
    PoStepperComponent.prototype.changeStep = function (stepIndex, step) {
        var _this = this;
        this.allowNextStep(stepIndex)
            .pipe(take(1))
            .subscribe(function (nextStepAllowed) {
            if (nextStepAllowed) {
                var isDifferentStep = !_this.currentActiveStep || step.id !== _this.currentActiveStep.id;
                if (_this.usePoSteps && isDifferentStep) {
                    _this.controlStepsStatus(stepIndex, step);
                    _this.onChangeStep.emit(step);
                }
                else if (!_this.usePoSteps && stepIndex !== _this.currentStepIndex) {
                    // if para tratamento do modelo antigo do po-stepper
                    _this.onChangeStep.emit(stepIndex + 1);
                }
            }
        });
    };
    PoStepperComponent.prototype.onStepActive = function (step) {
        this.currentActiveStep = step;
        this.previousActiveStep = this.poSteps.find(function (stepChild) { return stepChild.status === PoStepperStatus.Active && stepChild.id !== step.id; });
        this.setPreviousStepAsDone();
    };
    PoStepperComponent.prototype.trackByFn = function (step) {
        return step.id;
    };
    PoStepperComponent.prototype.activeFirstStep = function () {
        var hasStepActive = this.poSteps.some(function (poStep) { return poStep.status === PoStepperStatus.Active; });
        if (this.usePoSteps && !hasStepActive) {
            this.changeStep(0, this.poSteps.first);
        }
    };
    PoStepperComponent.prototype.allowNextStep = function (nextStepIndex) {
        if (!this.sequential) {
            return of(true);
        }
        var isAllowNextStep$ = this.usePoSteps
            ? this.isBeforeStep(nextStepIndex) || this.canActiveNextStep(this.currentActiveStep)
            : this.steps.slice(this.step, nextStepIndex).every(function (step) { return step.status === PoStepperStatus.Done; });
        return typeof isAllowNextStep$ === 'boolean' ? of(isAllowNextStep$) : isAllowNextStep$;
    };
    PoStepperComponent.prototype.canActiveNextStep = function (currentActiveStep) {
        var _this = this;
        if (currentActiveStep === void 0) { currentActiveStep = {}; }
        if (!currentActiveStep.canActiveNextStep) {
            return of(true);
        }
        var canActiveNextStep = currentActiveStep.canActiveNextStep(currentActiveStep);
        var canActiveNextStep$ = canActiveNextStep instanceof Observable ? canActiveNextStep : of(canActiveNextStep);
        return canActiveNextStep$.pipe(tap(function (isCanActiveNextStep) {
            currentActiveStep.status = _this.getStepperStatusByCanActive(isCanActiveNextStep);
        }), catchError(function (err) {
            currentActiveStep.status = PoStepperStatus.Error;
            return throwError(err);
        }));
    };
    PoStepperComponent.prototype.controlStepsStatus = function (stepIndex, step) {
        if (this.usePoSteps) {
            this.setStepAsActive(step);
            this.setNextStepAsDefault(step);
            if (this.isBeforeStep(stepIndex)) {
                this.setFinalSteppersAsDisabled(stepIndex);
            }
            this.changeDetector.detectChanges();
        }
    };
    PoStepperComponent.prototype.getStepperStatusByCanActive = function (canActiveNextStep) {
        return canActiveNextStep ? PoStepperStatus.Done : PoStepperStatus.Error;
    };
    PoStepperComponent.prototype.getStepsAndIndex = function (step) {
        if (step === void 0) { step = {}; }
        var steps = this.getPoSteps();
        var stepIndex = steps.findIndex(function (poStep) { return poStep.id === step.id; });
        return { steps: steps, stepIndex: stepIndex };
    };
    PoStepperComponent.prototype.getPoSteps = function () {
        return this.poSteps.toArray();
    };
    PoStepperComponent.prototype.isBeforeStep = function (stepIndex) {
        var _this = this;
        var currentActiveStepIndex = function () { return _this.getPoSteps().findIndex(function (step) { return step.id === _this.currentActiveStep.id; }); };
        return !!this.currentActiveStep && currentActiveStepIndex() >= stepIndex;
    };
    PoStepperComponent.prototype.setFinalSteppersAsDisabled = function (stepIndex) {
        this.getPoSteps()
            .filter(function (step, index) { return step && index >= stepIndex + 2; })
            .forEach(function (step) { return (step.status = PoStepperStatus.Disabled); });
    };
    PoStepperComponent.prototype.setStepAsActive = function (step) {
        step.status = PoStepperStatus.Active;
    };
    PoStepperComponent.prototype.setNextStepAsDefault = function (currentStep) {
        var _a = this.getStepsAndIndex(currentStep), steps = _a.steps, stepIndex = _a.stepIndex;
        var nextIndex = stepIndex + 1;
        if (nextIndex < this.poSteps.length) {
            steps[nextIndex].status = PoStepperStatus.Default;
        }
    };
    PoStepperComponent.prototype.setPreviousStepAsDone = function () {
        if (this.previousActiveStep) {
            this.previousActiveStep.status = PoStepperStatus.Done;
        }
    };
    PoStepperComponent.ctorParameters = function () { return [
        { type: ChangeDetectorRef }
    ]; };
    __decorate([
        ContentChildren(PoStepComponent),
        __metadata("design:type", QueryList)
    ], PoStepperComponent.prototype, "poSteps", void 0);
    PoStepperComponent = __decorate([
        Component({
            selector: 'po-stepper',
            template: "<div class=\"po-stepper po-stepper-{{ orientation }}\">\n  <div class=\"po-stepper-container\">\n    <po-stepper-step\n      *ngFor=\"let step of stepList; let index = index; trackBy: trackByFn\"\n      class=\"po-stepper-step-position\"\n      [p-circle-content]=\"index + 1\"\n      [p-label]=\"step.label\"\n      [p-orientation]=\"orientation\"\n      [p-status]=\"step.status\"\n      [p-step-icons]=\"stepIcons\"\n      [p-step-size]=\"stepSize\"\n      (p-activated)=\"onStepActive(step)\"\n      (p-click)=\"changeStep(index, step)\"\n      (p-enter)=\"changeStep(index, step)\"\n    >\n    </po-stepper-step>\n  </div>\n\n  <div *ngIf=\"usePoSteps\" class=\"po-stepper-content\">\n    <ng-content></ng-content>\n  </div>\n</div>\n"
        }),
        __metadata("design:paramtypes", [ChangeDetectorRef])
    ], PoStepperComponent);
    return PoStepperComponent;
}(PoStepperBaseComponent));
export { PoStepperComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tc3RlcHBlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImxpYi9jb21wb25lbnRzL3BvLXN0ZXBwZXIvcG8tc3RlcHBlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsZUFBZSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzRyxPQUFPLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsVUFBVSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFdkQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGdDQUFnQyxDQUFDO0FBQ2pFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUM5RCxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUdyRTs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW1CRztBQUtIO0lBQXdDLHNDQUFzQjtJQWtCNUQsNEJBQW9CLGNBQWlDO1FBQXJELFlBQ0UsaUJBQU8sU0FDUjtRQUZtQixvQkFBYyxHQUFkLGNBQWMsQ0FBbUI7O0lBRXJELENBQUM7SUFkRCxzQkFBSSxnREFBZ0I7YUFBcEI7WUFDRSxPQUFPLElBQUksQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQ3ZCLENBQUM7OztPQUFBO0lBRUQsc0JBQUksd0NBQVE7YUFBWjtZQUNFLE9BQU8sQ0FBQyxJQUFJLENBQUMsVUFBVSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDO1FBQ3pELENBQUM7OztPQUFBO0lBRUQsc0JBQUksMENBQVU7YUFBZDtZQUNFLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQy9CLENBQUM7OztPQUFBO0lBTUQsK0NBQWtCLEdBQWxCO1FBQUEsaUJBTUM7UUFMQyxJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFFdkIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsU0FBUyxDQUFDO1lBQzdCLEtBQUksQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLEVBQUUsS0FBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7Ozs7O09BTUc7SUFDSCxtQ0FBTSxHQUFOLFVBQU8sS0FBYTtRQUNsQixJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNwQixPQUFPO1NBQ1I7UUFFRCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDckMsSUFBTSxJQUFJLEdBQUcsVUFBVSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9CLElBQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxNQUFNLEtBQUssZUFBZSxDQUFDLFFBQVEsQ0FBQztRQUNoRSxJQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsTUFBTSxLQUFLLGVBQWUsQ0FBQyxLQUFLLENBQUM7UUFFMUQsSUFBSSxDQUFDLGNBQWMsSUFBSSxXQUFXLEVBQUU7WUFDbEMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7U0FDOUI7SUFDSCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGtDQUFLLEdBQUw7UUFDRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNwQixPQUFPO1NBQ1I7UUFFRCxJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQztRQUNyQyxJQUFNLGNBQWMsR0FBRyxDQUFDLENBQUM7UUFFekIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxjQUFjLEVBQUUsU0FBUyxDQUFDLENBQUM7SUFDN0MsQ0FBQztJQUVEOzs7O09BSUc7SUFDSCxpQ0FBSSxHQUFKO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDcEIsT0FBTztTQUNSO1FBRUssSUFBQSxrREFBb0UsRUFBbEUsZ0JBQUssRUFBRSx3QkFBMkQsQ0FBQztRQUMzRSxJQUFNLFNBQVMsR0FBRyxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBQ2hDLElBQU0sUUFBUSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUVsQyxJQUFJLENBQUMsVUFBVSxDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILHFDQUFRLEdBQVI7UUFDRSxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRTtZQUNwQixPQUFPO1NBQ1I7UUFFSyxJQUFBLGtEQUFvRSxFQUFsRSxnQkFBSyxFQUFFLHdCQUEyRCxDQUFDO1FBQzNFLElBQU0sYUFBYSxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFDcEMsSUFBTSxZQUFZLEdBQUcsS0FBSyxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTFDLElBQUksQ0FBQyxVQUFVLENBQUMsYUFBYSxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFFRCx1Q0FBVSxHQUFWLFVBQVcsU0FBaUIsRUFBRSxJQUFzQjtRQUFwRCxpQkFnQkM7UUFmQyxJQUFJLENBQUMsYUFBYSxDQUFDLFNBQVMsQ0FBQzthQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ2IsU0FBUyxDQUFDLFVBQUEsZUFBZTtZQUN4QixJQUFJLGVBQWUsRUFBRTtnQkFDbkIsSUFBTSxlQUFlLEdBQUcsQ0FBQyxLQUFJLENBQUMsaUJBQWlCLElBQUksSUFBSSxDQUFDLEVBQUUsS0FBSyxLQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxDQUFDO2dCQUV6RixJQUFJLEtBQUksQ0FBQyxVQUFVLElBQUksZUFBZSxFQUFFO29CQUN0QyxLQUFJLENBQUMsa0JBQWtCLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxDQUFDO29CQUN6QyxLQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztpQkFDOUI7cUJBQU0sSUFBSSxDQUFDLEtBQUksQ0FBQyxVQUFVLElBQUksU0FBUyxLQUFLLEtBQUksQ0FBQyxnQkFBZ0IsRUFBRTtvQkFDbEUsb0RBQW9EO29CQUNwRCxLQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsQ0FBQyxDQUFDLENBQUM7aUJBQ3ZDO2FBQ0Y7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRCx5Q0FBWSxHQUFaLFVBQWEsSUFBcUI7UUFDaEMsSUFBSSxDQUFDLGlCQUFpQixHQUFHLElBQUksQ0FBQztRQUU5QixJQUFJLENBQUMsa0JBQWtCLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQ3pDLFVBQUEsU0FBUyxJQUFJLE9BQUEsU0FBUyxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsTUFBTSxJQUFJLFNBQVMsQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBdkUsQ0FBdUUsQ0FDckYsQ0FBQztRQUVGLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO0lBQy9CLENBQUM7SUFFRCxzQ0FBUyxHQUFULFVBQVUsSUFBcUI7UUFDN0IsT0FBTyxJQUFJLENBQUMsRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFTyw0Q0FBZSxHQUF2QjtRQUNFLElBQU0sYUFBYSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFVBQUEsTUFBTSxJQUFJLE9BQUEsTUFBTSxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsTUFBTSxFQUF4QyxDQUF3QyxDQUFDLENBQUM7UUFFNUYsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFJLENBQUMsYUFBYSxFQUFFO1lBQ3JDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDeEM7SUFDSCxDQUFDO0lBRU8sMENBQWEsR0FBckIsVUFBc0IsYUFBcUI7UUFDekMsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDcEIsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7UUFFRCxJQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxVQUFVO1lBQ3RDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsaUJBQWlCLENBQUM7WUFDcEYsQ0FBQyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsYUFBYSxDQUFDLENBQUMsS0FBSyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLE1BQU0sS0FBSyxlQUFlLENBQUMsSUFBSSxFQUFwQyxDQUFvQyxDQUFDLENBQUM7UUFFbkcsT0FBTyxPQUFPLGdCQUFnQixLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLGdCQUFnQixDQUFDLENBQUMsQ0FBQyxDQUFDLGdCQUFnQixDQUFDO0lBQ3pGLENBQUM7SUFFTyw4Q0FBaUIsR0FBekIsVUFBMEIsaUJBQXVDO1FBQWpFLGlCQW1CQztRQW5CeUIsa0NBQUEsRUFBQSxvQkFBcUMsRUFBRTtRQUMvRCxJQUFJLENBQUMsaUJBQWlCLENBQUMsaUJBQWlCLEVBQUU7WUFDeEMsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUM7U0FDakI7UUFFRCxJQUFNLGlCQUFpQixHQUFHLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLGlCQUFpQixDQUFDLENBQUM7UUFFakYsSUFBTSxrQkFBa0IsR0FBRyxpQkFBaUIsWUFBWSxVQUFVLENBQUMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsaUJBQWlCLENBQUMsQ0FBQztRQUUvRyxPQUFPLGtCQUFrQixDQUFDLElBQUksQ0FDNUIsR0FBRyxDQUFDLFVBQUEsbUJBQW1CO1lBQ3JCLGlCQUFpQixDQUFDLE1BQU0sR0FBRyxLQUFJLENBQUMsMkJBQTJCLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUNuRixDQUFDLENBQUMsRUFDRixVQUFVLENBQUMsVUFBQSxHQUFHO1lBQ1osaUJBQWlCLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxLQUFLLENBQUM7WUFFakQsT0FBTyxVQUFVLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDekIsQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7SUFFTywrQ0FBa0IsR0FBMUIsVUFBMkIsU0FBaUIsRUFBRSxJQUFxQjtRQUNqRSxJQUFJLElBQUksQ0FBQyxVQUFVLEVBQUU7WUFDbkIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzQixJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUM7WUFFaEMsSUFBSSxJQUFJLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxFQUFFO2dCQUNoQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDNUM7WUFFRCxJQUFJLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3JDO0lBQ0gsQ0FBQztJQUVPLHdEQUEyQixHQUFuQyxVQUFvQyxpQkFBMEI7UUFDNUQsT0FBTyxpQkFBaUIsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLEtBQUssQ0FBQztJQUMxRSxDQUFDO0lBRU8sNkNBQWdCLEdBQXhCLFVBQXlCLElBQStCO1FBQS9CLHFCQUFBLEVBQUEsT0FBNkIsRUFBRTtRQUN0RCxJQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7UUFDaEMsSUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBQyxVQUFBLE1BQU0sSUFBSSxPQUFBLE1BQU0sQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsRUFBckIsQ0FBcUIsQ0FBQyxDQUFDO1FBRW5FLE9BQU8sRUFBRSxLQUFLLE9BQUEsRUFBRSxTQUFTLFdBQUEsRUFBRSxDQUFDO0lBQzlCLENBQUM7SUFFTyx1Q0FBVSxHQUFsQjtRQUNFLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsQ0FBQztJQUNoQyxDQUFDO0lBRU8seUNBQVksR0FBcEIsVUFBcUIsU0FBaUI7UUFBdEMsaUJBSUM7UUFIQyxJQUFNLHNCQUFzQixHQUFHLGNBQU0sT0FBQSxLQUFJLENBQUMsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsSUFBSSxDQUFDLEVBQUUsS0FBSyxLQUFJLENBQUMsaUJBQWlCLENBQUMsRUFBRSxFQUFyQyxDQUFxQyxDQUFDLEVBQTFFLENBQTBFLENBQUM7UUFFaEgsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUFDLGlCQUFpQixJQUFJLHNCQUFzQixFQUFFLElBQUksU0FBUyxDQUFDO0lBQzNFLENBQUM7SUFFTyx1REFBMEIsR0FBbEMsVUFBbUMsU0FBaUI7UUFDbEQsSUFBSSxDQUFDLFVBQVUsRUFBRTthQUNkLE1BQU0sQ0FBQyxVQUFDLElBQUksRUFBRSxLQUFLLElBQUssT0FBQSxJQUFJLElBQUksS0FBSyxJQUFJLFNBQVMsR0FBRyxDQUFDLEVBQTlCLENBQThCLENBQUM7YUFDdkQsT0FBTyxDQUFDLFVBQUEsSUFBSSxJQUFJLE9BQUEsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxRQUFRLENBQUMsRUFBeEMsQ0FBd0MsQ0FBQyxDQUFDO0lBQy9ELENBQUM7SUFFTyw0Q0FBZSxHQUF2QixVQUF3QixJQUFxQjtRQUMzQyxJQUFJLENBQUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUM7SUFDdkMsQ0FBQztJQUVPLGlEQUFvQixHQUE1QixVQUE2QixXQUE0QjtRQUNqRCxJQUFBLHVDQUF5RCxFQUF2RCxnQkFBSyxFQUFFLHdCQUFnRCxDQUFDO1FBQ2hFLElBQU0sU0FBUyxHQUFHLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFFaEMsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEVBQUU7WUFDbkMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU0sR0FBRyxlQUFlLENBQUMsT0FBTyxDQUFDO1NBQ25EO0lBQ0gsQ0FBQztJQUVPLGtEQUFxQixHQUE3QjtRQUNFLElBQUksSUFBSSxDQUFDLGtCQUFrQixFQUFFO1lBQzNCLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxNQUFNLEdBQUcsZUFBZSxDQUFDLElBQUksQ0FBQztTQUN2RDtJQUNILENBQUM7O2dCQXRObUMsaUJBQWlCOztJQWpCbkI7UUFBakMsZUFBZSxDQUFDLGVBQWUsQ0FBQztrQ0FBVSxTQUFTO3VEQUFrQjtJQUQzRCxrQkFBa0I7UUFKOUIsU0FBUyxDQUFDO1lBQ1QsUUFBUSxFQUFFLFlBQVk7WUFDdEIsK3VCQUEwQztTQUMzQyxDQUFDO3lDQW1Cb0MsaUJBQWlCO09BbEIxQyxrQkFBa0IsQ0F5TzlCO0lBQUQseUJBQUM7Q0FBQSxBQXpPRCxDQUF3QyxzQkFBc0IsR0F5TzdEO1NBek9ZLGtCQUFrQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEFmdGVyQ29udGVudEluaXQsIENoYW5nZURldGVjdG9yUmVmLCBDb21wb25lbnQsIENvbnRlbnRDaGlsZHJlbiwgUXVlcnlMaXN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IE9ic2VydmFibGUsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YWtlLCB0YXAsIGNhdGNoRXJyb3IgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFBvU3RlcHBlclN0YXR1cyB9IGZyb20gJy4vZW51bXMvcG8tc3RlcHBlci1zdGF0dXMuZW51bSc7XG5pbXBvcnQgeyBQb1N0ZXBDb21wb25lbnQgfSBmcm9tICcuL3BvLXN0ZXAvcG8tc3RlcC5jb21wb25lbnQnO1xuaW1wb3J0IHsgUG9TdGVwcGVyQmFzZUNvbXBvbmVudCB9IGZyb20gJy4vcG8tc3RlcHBlci1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb1N0ZXBwZXJJdGVtIH0gZnJvbSAnLi9wby1zdGVwcGVyLWl0ZW0uaW50ZXJmYWNlJztcblxuLyoqXG4gKiBAZG9jc0V4dGVuZHMgUG9TdGVwcGVyQmFzZUNvbXBvbmVudFxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLXN0ZXBwZXItYmFzaWNcIiB0aXRsZT1cIlBPIFN0ZXBwZXIgQmFzaWNcIj5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMvc2FtcGxlLXBvLXN0ZXBwZXItYmFzaWMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1iYXNpYy9zYW1wbGUtcG8tc3RlcHBlci1iYXNpYy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1zdGVwcGVyLWxhYnNcIiB0aXRsZT1cIlBPIFN0ZXBwZXIgTGFic1wiPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1sYWJzL3NhbXBsZS1wby1zdGVwcGVyLWxhYnMuY29tcG9uZW50Lmh0bWxcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tc3RlcHBlci1sYWJzL3NhbXBsZS1wby1zdGVwcGVyLWxhYnMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqXG4gKiA8ZXhhbXBsZSBuYW1lPVwicG8tc3RlcHBlci1zYWxlc1wiIHRpdGxlPVwiUE8gU3RlcHBlciAtIFNhbGVzXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1zdGVwcGVyLXNhbGVzL3NhbXBsZS1wby1zdGVwcGVyLXNhbGVzLmNvbXBvbmVudC5odG1sXCI+IDwvZmlsZT5cbiAqICA8ZmlsZSBuYW1lPVwic2FtcGxlLXBvLXN0ZXBwZXItc2FsZXMvc2FtcGxlLXBvLXN0ZXBwZXItc2FsZXMuY29tcG9uZW50LnRzXCI+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tc3RlcHBlcicsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1zdGVwcGVyLmNvbXBvbmVudC5odG1sJ1xufSlcbmV4cG9ydCBjbGFzcyBQb1N0ZXBwZXJDb21wb25lbnQgZXh0ZW5kcyBQb1N0ZXBwZXJCYXNlQ29tcG9uZW50IGltcGxlbWVudHMgQWZ0ZXJDb250ZW50SW5pdCB7XG4gIEBDb250ZW50Q2hpbGRyZW4oUG9TdGVwQ29tcG9uZW50KSBwb1N0ZXBzOiBRdWVyeUxpc3Q8UG9TdGVwQ29tcG9uZW50PjtcblxuICBwcml2YXRlIGN1cnJlbnRBY3RpdmVTdGVwOiBQb1N0ZXBDb21wb25lbnQ7XG4gIHByaXZhdGUgcHJldmlvdXNBY3RpdmVTdGVwOiBQb1N0ZXBDb21wb25lbnQ7XG5cbiAgZ2V0IGN1cnJlbnRTdGVwSW5kZXgoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5zdGVwIC0gMTtcbiAgfVxuXG4gIGdldCBzdGVwTGlzdCgpOiBRdWVyeUxpc3Q8UG9TdGVwQ29tcG9uZW50PiB8IEFycmF5PFBvU3RlcHBlckl0ZW0+IHtcbiAgICByZXR1cm4gKHRoaXMudXNlUG9TdGVwcyAmJiB0aGlzLnBvU3RlcHMpIHx8IHRoaXMuc3RlcHM7XG4gIH1cblxuICBnZXQgdXNlUG9TdGVwcygpOiBib29sZWFuIHtcbiAgICByZXR1cm4gISF0aGlzLnBvU3RlcHMubGVuZ3RoO1xuICB9XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBjaGFuZ2VEZXRlY3RvcjogQ2hhbmdlRGV0ZWN0b3JSZWYpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgbmdBZnRlckNvbnRlbnRJbml0KCkge1xuICAgIHRoaXMuYWN0aXZlRmlyc3RTdGVwKCk7XG5cbiAgICB0aGlzLnBvU3RlcHMuY2hhbmdlcy5zdWJzY3JpYmUoKCkgPT4ge1xuICAgICAgdGhpcy5jb250cm9sU3RlcHNTdGF0dXMoMCwgdGhpcy5wb1N0ZXBzLmZpcnN0KTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBbHRlcmEgbyBzdGF0dXMgZG8gKnN0ZXAqIHBhcmEgYXRpdm8uXG4gICAqXG4gICAqID4gRXN0ZSBtw6l0b2RvIMOpIHZhbGlkbyBhcGVuYXMgcGFyYSBhcyBpbXBsZW1lbnRhw6fDtWVzIHF1ZSB1dGlsaXphbSBvIGNvbXBvbmVudGUgWyoqcG8tc3RlcCoqXSgvZG9jdW1lbnRhdGlvbi9wby1zdGVwKS5cbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IGluZGV4IMONbmRpY2UgZG8gYHBvLXN0ZXBgIHF1ZSBzZSBkZXNlamEgYXRpdmFyLlxuICAgKi9cbiAgYWN0aXZlKGluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMudXNlUG9TdGVwcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IHN0ZXBzQXJyYXkgPSB0aGlzLmdldFBvU3RlcHMoKTtcbiAgICBjb25zdCBzdGVwID0gc3RlcHNBcnJheVtpbmRleF07XG4gICAgY29uc3QgaXNEaXNhYmxlZFN0ZXAgPSBzdGVwLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkRpc2FibGVkO1xuICAgIGNvbnN0IGlzRXJyb3JTdGVwID0gc3RlcC5zdGF0dXMgPT09IFBvU3RlcHBlclN0YXR1cy5FcnJvcjtcblxuICAgIGlmICghaXNEaXNhYmxlZFN0ZXAgfHwgaXNFcnJvclN0ZXApIHtcbiAgICAgIHRoaXMuY2hhbmdlU3RlcChpbmRleCwgc3RlcCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEF0aXZhIG8gcHJpbWVpcm8gKnN0ZXAqLlxuICAgKlxuICAgKiA+IEVzdGUgbcOpdG9kbyDDqSB2YWxpZG8gYXBlbmFzIHBhcmEgYXMgaW1wbGVtZW50YcOnw7VlcyBxdWUgdXRpbGl6YW0gbyBjb21wb25lbnRlIFsqKnBvLXN0ZXAqKl0oL2RvY3VtZW50YXRpb24vcG8tc3RlcCkuXG4gICAqL1xuICBmaXJzdCgpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMudXNlUG9TdGVwcykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGNvbnN0IGZpcnN0U3RlcCA9IHRoaXMucG9TdGVwcy5maXJzdDtcbiAgICBjb25zdCBmaXJzdFN0ZXBJbmRleCA9IDA7XG5cbiAgICB0aGlzLmNoYW5nZVN0ZXAoZmlyc3RTdGVwSW5kZXgsIGZpcnN0U3RlcCk7XG4gIH1cblxuICAvKipcbiAgICogQXRpdmEgbyBwcsOzeGltbyAqc3RlcCouXG4gICAqXG4gICAqID4gRXN0ZSBtw6l0b2RvIMOpIHZhbGlkbyBhcGVuYXMgcGFyYSBhcyBpbXBsZW1lbnRhw6fDtWVzIHF1ZSB1dGlsaXphbSBvIGNvbXBvbmVudGUgWyoqcG8tc3RlcCoqXSgvZG9jdW1lbnRhdGlvbi9wby1zdGVwKS5cbiAgICovXG4gIG5leHQoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnVzZVBvU3RlcHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHN0ZXBzLCBzdGVwSW5kZXggfSA9IHRoaXMuZ2V0U3RlcHNBbmRJbmRleCh0aGlzLmN1cnJlbnRBY3RpdmVTdGVwKTtcbiAgICBjb25zdCBuZXh0SW5kZXggPSBzdGVwSW5kZXggKyAxO1xuICAgIGNvbnN0IG5leHRTdGVwID0gc3RlcHNbbmV4dEluZGV4XTtcblxuICAgIHRoaXMuY2hhbmdlU3RlcChuZXh0SW5kZXgsIG5leHRTdGVwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBdGl2YSBvICpzdGVwKiBhbnRlcmlvci5cbiAgICpcbiAgICogPiBFc3RlIG3DqXRvZG8gw6kgdmFsaWRvIGFwZW5hcyBwYXJhIGFzIGltcGxlbWVudGHDp8O1ZXMgcXVlIHV0aWxpemFtIG8gY29tcG9uZW50ZSBbKipwby1zdGVwKipdKC9kb2N1bWVudGF0aW9uL3BvLXN0ZXApLlxuICAgKi9cbiAgcHJldmlvdXMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnVzZVBvU3RlcHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7IHN0ZXBzLCBzdGVwSW5kZXggfSA9IHRoaXMuZ2V0U3RlcHNBbmRJbmRleCh0aGlzLmN1cnJlbnRBY3RpdmVTdGVwKTtcbiAgICBjb25zdCBwcmV2aW91c0luZGV4ID0gc3RlcEluZGV4IC0gMTtcbiAgICBjb25zdCBwcmV2aW91c1N0ZXAgPSBzdGVwc1twcmV2aW91c0luZGV4XTtcblxuICAgIHRoaXMuY2hhbmdlU3RlcChwcmV2aW91c0luZGV4LCBwcmV2aW91c1N0ZXApO1xuICB9XG5cbiAgY2hhbmdlU3RlcChzdGVwSW5kZXg6IG51bWJlciwgc3RlcD86IFBvU3RlcENvbXBvbmVudCk6IHZvaWQge1xuICAgIHRoaXMuYWxsb3dOZXh0U3RlcChzdGVwSW5kZXgpXG4gICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgLnN1YnNjcmliZShuZXh0U3RlcEFsbG93ZWQgPT4ge1xuICAgICAgICBpZiAobmV4dFN0ZXBBbGxvd2VkKSB7XG4gICAgICAgICAgY29uc3QgaXNEaWZmZXJlbnRTdGVwID0gIXRoaXMuY3VycmVudEFjdGl2ZVN0ZXAgfHwgc3RlcC5pZCAhPT0gdGhpcy5jdXJyZW50QWN0aXZlU3RlcC5pZDtcblxuICAgICAgICAgIGlmICh0aGlzLnVzZVBvU3RlcHMgJiYgaXNEaWZmZXJlbnRTdGVwKSB7XG4gICAgICAgICAgICB0aGlzLmNvbnRyb2xTdGVwc1N0YXR1cyhzdGVwSW5kZXgsIHN0ZXApO1xuICAgICAgICAgICAgdGhpcy5vbkNoYW5nZVN0ZXAuZW1pdChzdGVwKTtcbiAgICAgICAgICB9IGVsc2UgaWYgKCF0aGlzLnVzZVBvU3RlcHMgJiYgc3RlcEluZGV4ICE9PSB0aGlzLmN1cnJlbnRTdGVwSW5kZXgpIHtcbiAgICAgICAgICAgIC8vIGlmIHBhcmEgdHJhdGFtZW50byBkbyBtb2RlbG8gYW50aWdvIGRvIHBvLXN0ZXBwZXJcbiAgICAgICAgICAgIHRoaXMub25DaGFuZ2VTdGVwLmVtaXQoc3RlcEluZGV4ICsgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9KTtcbiAgfVxuXG4gIG9uU3RlcEFjdGl2ZShzdGVwOiBQb1N0ZXBDb21wb25lbnQpIHtcbiAgICB0aGlzLmN1cnJlbnRBY3RpdmVTdGVwID0gc3RlcDtcblxuICAgIHRoaXMucHJldmlvdXNBY3RpdmVTdGVwID0gdGhpcy5wb1N0ZXBzLmZpbmQoXG4gICAgICBzdGVwQ2hpbGQgPT4gc3RlcENoaWxkLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkFjdGl2ZSAmJiBzdGVwQ2hpbGQuaWQgIT09IHN0ZXAuaWRcbiAgICApO1xuXG4gICAgdGhpcy5zZXRQcmV2aW91c1N0ZXBBc0RvbmUoKTtcbiAgfVxuXG4gIHRyYWNrQnlGbihzdGVwOiBQb1N0ZXBDb21wb25lbnQpIHtcbiAgICByZXR1cm4gc3RlcC5pZDtcbiAgfVxuXG4gIHByaXZhdGUgYWN0aXZlRmlyc3RTdGVwKCkge1xuICAgIGNvbnN0IGhhc1N0ZXBBY3RpdmUgPSB0aGlzLnBvU3RlcHMuc29tZShwb1N0ZXAgPT4gcG9TdGVwLnN0YXR1cyA9PT0gUG9TdGVwcGVyU3RhdHVzLkFjdGl2ZSk7XG5cbiAgICBpZiAodGhpcy51c2VQb1N0ZXBzICYmICFoYXNTdGVwQWN0aXZlKSB7XG4gICAgICB0aGlzLmNoYW5nZVN0ZXAoMCwgdGhpcy5wb1N0ZXBzLmZpcnN0KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFsbG93TmV4dFN0ZXAobmV4dFN0ZXBJbmRleDogbnVtYmVyKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgaWYgKCF0aGlzLnNlcXVlbnRpYWwpIHtcbiAgICAgIHJldHVybiBvZih0cnVlKTtcbiAgICB9XG5cbiAgICBjb25zdCBpc0FsbG93TmV4dFN0ZXAkID0gdGhpcy51c2VQb1N0ZXBzXG4gICAgICA/IHRoaXMuaXNCZWZvcmVTdGVwKG5leHRTdGVwSW5kZXgpIHx8IHRoaXMuY2FuQWN0aXZlTmV4dFN0ZXAodGhpcy5jdXJyZW50QWN0aXZlU3RlcClcbiAgICAgIDogdGhpcy5zdGVwcy5zbGljZSh0aGlzLnN0ZXAsIG5leHRTdGVwSW5kZXgpLmV2ZXJ5KHN0ZXAgPT4gc3RlcC5zdGF0dXMgPT09IFBvU3RlcHBlclN0YXR1cy5Eb25lKTtcblxuICAgIHJldHVybiB0eXBlb2YgaXNBbGxvd05leHRTdGVwJCA9PT0gJ2Jvb2xlYW4nID8gb2YoaXNBbGxvd05leHRTdGVwJCkgOiBpc0FsbG93TmV4dFN0ZXAkO1xuICB9XG5cbiAgcHJpdmF0ZSBjYW5BY3RpdmVOZXh0U3RlcChjdXJyZW50QWN0aXZlU3RlcCA9IDxQb1N0ZXBDb21wb25lbnQ+e30pOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICBpZiAoIWN1cnJlbnRBY3RpdmVTdGVwLmNhbkFjdGl2ZU5leHRTdGVwKSB7XG4gICAgICByZXR1cm4gb2YodHJ1ZSk7XG4gICAgfVxuXG4gICAgY29uc3QgY2FuQWN0aXZlTmV4dFN0ZXAgPSBjdXJyZW50QWN0aXZlU3RlcC5jYW5BY3RpdmVOZXh0U3RlcChjdXJyZW50QWN0aXZlU3RlcCk7XG5cbiAgICBjb25zdCBjYW5BY3RpdmVOZXh0U3RlcCQgPSBjYW5BY3RpdmVOZXh0U3RlcCBpbnN0YW5jZW9mIE9ic2VydmFibGUgPyBjYW5BY3RpdmVOZXh0U3RlcCA6IG9mKGNhbkFjdGl2ZU5leHRTdGVwKTtcblxuICAgIHJldHVybiBjYW5BY3RpdmVOZXh0U3RlcCQucGlwZShcbiAgICAgIHRhcChpc0NhbkFjdGl2ZU5leHRTdGVwID0+IHtcbiAgICAgICAgY3VycmVudEFjdGl2ZVN0ZXAuc3RhdHVzID0gdGhpcy5nZXRTdGVwcGVyU3RhdHVzQnlDYW5BY3RpdmUoaXNDYW5BY3RpdmVOZXh0U3RlcCk7XG4gICAgICB9KSxcbiAgICAgIGNhdGNoRXJyb3IoZXJyID0+IHtcbiAgICAgICAgY3VycmVudEFjdGl2ZVN0ZXAuc3RhdHVzID0gUG9TdGVwcGVyU3RhdHVzLkVycm9yO1xuXG4gICAgICAgIHJldHVybiB0aHJvd0Vycm9yKGVycik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNvbnRyb2xTdGVwc1N0YXR1cyhzdGVwSW5kZXg6IG51bWJlciwgc3RlcDogUG9TdGVwQ29tcG9uZW50KTogdm9pZCB7XG4gICAgaWYgKHRoaXMudXNlUG9TdGVwcykge1xuICAgICAgdGhpcy5zZXRTdGVwQXNBY3RpdmUoc3RlcCk7XG4gICAgICB0aGlzLnNldE5leHRTdGVwQXNEZWZhdWx0KHN0ZXApO1xuXG4gICAgICBpZiAodGhpcy5pc0JlZm9yZVN0ZXAoc3RlcEluZGV4KSkge1xuICAgICAgICB0aGlzLnNldEZpbmFsU3RlcHBlcnNBc0Rpc2FibGVkKHN0ZXBJbmRleCk7XG4gICAgICB9XG5cbiAgICAgIHRoaXMuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RlcHBlclN0YXR1c0J5Q2FuQWN0aXZlKGNhbkFjdGl2ZU5leHRTdGVwOiBib29sZWFuKTogUG9TdGVwcGVyU3RhdHVzIHtcbiAgICByZXR1cm4gY2FuQWN0aXZlTmV4dFN0ZXAgPyBQb1N0ZXBwZXJTdGF0dXMuRG9uZSA6IFBvU3RlcHBlclN0YXR1cy5FcnJvcjtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0U3RlcHNBbmRJbmRleChzdGVwOiBQb1N0ZXBDb21wb25lbnQgPSA8YW55Pnt9KTogeyBzdGVwczogQXJyYXk8UG9TdGVwQ29tcG9uZW50Pjsgc3RlcEluZGV4OiBudW1iZXIgfSB7XG4gICAgY29uc3Qgc3RlcHMgPSB0aGlzLmdldFBvU3RlcHMoKTtcbiAgICBjb25zdCBzdGVwSW5kZXggPSBzdGVwcy5maW5kSW5kZXgocG9TdGVwID0+IHBvU3RlcC5pZCA9PT0gc3RlcC5pZCk7XG5cbiAgICByZXR1cm4geyBzdGVwcywgc3RlcEluZGV4IH07XG4gIH1cblxuICBwcml2YXRlIGdldFBvU3RlcHMoKTogQXJyYXk8UG9TdGVwQ29tcG9uZW50PiB7XG4gICAgcmV0dXJuIHRoaXMucG9TdGVwcy50b0FycmF5KCk7XG4gIH1cblxuICBwcml2YXRlIGlzQmVmb3JlU3RlcChzdGVwSW5kZXg6IG51bWJlcik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGN1cnJlbnRBY3RpdmVTdGVwSW5kZXggPSAoKSA9PiB0aGlzLmdldFBvU3RlcHMoKS5maW5kSW5kZXgoc3RlcCA9PiBzdGVwLmlkID09PSB0aGlzLmN1cnJlbnRBY3RpdmVTdGVwLmlkKTtcblxuICAgIHJldHVybiAhIXRoaXMuY3VycmVudEFjdGl2ZVN0ZXAgJiYgY3VycmVudEFjdGl2ZVN0ZXBJbmRleCgpID49IHN0ZXBJbmRleDtcbiAgfVxuXG4gIHByaXZhdGUgc2V0RmluYWxTdGVwcGVyc0FzRGlzYWJsZWQoc3RlcEluZGV4OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmdldFBvU3RlcHMoKVxuICAgICAgLmZpbHRlcigoc3RlcCwgaW5kZXgpID0+IHN0ZXAgJiYgaW5kZXggPj0gc3RlcEluZGV4ICsgMilcbiAgICAgIC5mb3JFYWNoKHN0ZXAgPT4gKHN0ZXAuc3RhdHVzID0gUG9TdGVwcGVyU3RhdHVzLkRpc2FibGVkKSk7XG4gIH1cblxuICBwcml2YXRlIHNldFN0ZXBBc0FjdGl2ZShzdGVwOiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcbiAgICBzdGVwLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5BY3RpdmU7XG4gIH1cblxuICBwcml2YXRlIHNldE5leHRTdGVwQXNEZWZhdWx0KGN1cnJlbnRTdGVwOiBQb1N0ZXBDb21wb25lbnQpOiB2b2lkIHtcbiAgICBjb25zdCB7IHN0ZXBzLCBzdGVwSW5kZXggfSA9IHRoaXMuZ2V0U3RlcHNBbmRJbmRleChjdXJyZW50U3RlcCk7XG4gICAgY29uc3QgbmV4dEluZGV4ID0gc3RlcEluZGV4ICsgMTtcblxuICAgIGlmIChuZXh0SW5kZXggPCB0aGlzLnBvU3RlcHMubGVuZ3RoKSB7XG4gICAgICBzdGVwc1tuZXh0SW5kZXhdLnN0YXR1cyA9IFBvU3RlcHBlclN0YXR1cy5EZWZhdWx0O1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0UHJldmlvdXNTdGVwQXNEb25lKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnByZXZpb3VzQWN0aXZlU3RlcCkge1xuICAgICAgdGhpcy5wcmV2aW91c0FjdGl2ZVN0ZXAuc3RhdHVzID0gUG9TdGVwcGVyU3RhdHVzLkRvbmU7XG4gICAgfVxuICB9XG59XG4iXX0=