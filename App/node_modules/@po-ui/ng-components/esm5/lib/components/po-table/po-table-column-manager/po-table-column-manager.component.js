import { __assign, __decorate, __metadata } from "tslib";
import { Component, ElementRef, EventEmitter, Input, OnChanges, OnDestroy, OnInit, Output, SimpleChange, SimpleChanges, Renderer2, ViewChild } from '@angular/core';
import { browserLanguage, capitalizeFirstLetter, convertToInt, poLocaleDefault } from '../../../utils/util';
import { PoPopoverComponent } from '../../po-popover/po-popover.component';
var PoTableColumnManagerMaxColumnsDefault = 99999;
export var poTableColumnManagerLiteralsDefault = {
    en: {
        columnsManager: 'Columns manager',
        restoreDefault: 'Restore default'
    },
    es: {
        columnsManager: 'Gerente de columna',
        restoreDefault: 'Restaurar por defecto'
    },
    pt: {
        columnsManager: 'Gerenciador de colunas',
        restoreDefault: 'Restaurar padrão'
    },
    ru: {
        columnsManager: 'менеджер колонок',
        restoreDefault: 'сброс настроек'
    }
};
var PoTableColumnManagerComponent = /** @class */ (function () {
    function PoTableColumnManagerComponent(renderer) {
        this.renderer = renderer;
        this._maxColumns = PoTableColumnManagerMaxColumnsDefault;
        this.columnsOptions = [];
        this.literals = __assign(__assign({}, poTableColumnManagerLiteralsDefault[poLocaleDefault]), poTableColumnManagerLiteralsDefault[browserLanguage()]);
        this.visibleColumns = [];
        this.defaultColumns = [];
        this.columns = [];
        this.visibleColumnsChange = new EventEmitter();
    }
    Object.defineProperty(PoTableColumnManagerComponent.prototype, "maxColumns", {
        get: function () {
            return this._maxColumns;
        },
        set: function (value) {
            this._maxColumns = convertToInt(value, PoTableColumnManagerMaxColumnsDefault);
        },
        enumerable: true,
        configurable: true
    });
    PoTableColumnManagerComponent.prototype.ngOnInit = function () {
        this.updateColumnsOptions(this.columns);
    };
    PoTableColumnManagerComponent.prototype.ngOnChanges = function (changes) {
        var columns = changes.columns, maxColumns = changes.maxColumns, target = changes.target;
        if (target && target.firstChange) {
            this.initializeListeners();
        }
        if (columns) {
            this.onChangeColumns(columns);
        }
        if (maxColumns) {
            this.updateColumnsOptions(this.columns);
        }
    };
    PoTableColumnManagerComponent.prototype.ngOnDestroy = function () {
        this.removeListeners();
    };
    PoTableColumnManagerComponent.prototype.onChangeVisibleColumns = function (checkedColumns) {
        this.disableColumnsOptions(this.columnsOptions);
        var visibleTableColumns = this.getVisibleTableColumns(checkedColumns);
        this.visibleColumnsChange.emit(visibleTableColumns);
    };
    PoTableColumnManagerComponent.prototype.restore = function () {
        this.updateColumnsOptions(this.defaultColumns);
    };
    // desabilitará as colunas, que não estiverem selecionadas, após exeder o numero maximo de colunas.
    PoTableColumnManagerComponent.prototype.disableColumnsOptions = function (columns) {
        var _this = this;
        if (columns === void 0) { columns = []; }
        // necessario timeout para que seja possivel atualizar os columnsOptions apos a mudança do model
        setTimeout(function () {
            _this.columnsOptions = columns.map(function (column) { return (__assign(__assign({}, column), { disabled: _this.isDisableColumn(column.value) })); });
        });
    };
    PoTableColumnManagerComponent.prototype.getColumnTitleLabel = function (column) {
        return column.label || capitalizeFirstLetter(column.property);
    };
    /** Retorna um Array de column.property das colunas que são visiveis. */
    PoTableColumnManagerComponent.prototype.getVisibleColumns = function (columns) {
        var _this = this;
        var visibleColumns = [];
        columns.forEach(function (column) {
            if (column.visible !== false && visibleColumns.length < _this.maxColumns && column.type !== 'detail') {
                visibleColumns.push(column.property);
            }
        });
        return visibleColumns;
    };
    /** Retorna um Array PoTableColumn a partir das colunas visiveis no gerenciador de colunas. */
    PoTableColumnManagerComponent.prototype.getVisibleTableColumns = function (visibleColumns) {
        return this.columns.map(function (column) { return (__assign(__assign({}, column), { visible: visibleColumns.includes(column.property) || column.type === 'detail' })); });
    };
    PoTableColumnManagerComponent.prototype.initializeListeners = function () {
        var _this = this;
        this.resizeListener = this.renderer.listen('window', 'resize', function () {
            if (_this.popover) {
                _this.popover.close();
            }
        });
    };
    PoTableColumnManagerComponent.prototype.isDisableColumn = function (property) {
        return this.visibleColumns.length >= this.maxColumns ? !this.visibleColumns.includes(property) : false;
    };
    PoTableColumnManagerComponent.prototype.mapTableColumnsToCheckboxOptions = function (columns) {
        var _this = this;
        if (columns === void 0) { columns = []; }
        var columnsOptions = [];
        columns.forEach(function (column) {
            if (column.type !== 'detail') {
                columnsOptions.push({
                    value: column.property,
                    label: _this.getColumnTitleLabel(column),
                    disabled: _this.isDisableColumn(column.property)
                });
            }
        });
        return columnsOptions;
    };
    PoTableColumnManagerComponent.prototype.onChangeColumns = function (columns) {
        var firstChange = columns.firstChange, _a = columns.currentValue, currentValue = _a === void 0 ? [] : _a, _b = columns.previousValue, previousValue = _b === void 0 ? [] : _b;
        // atualizara o defaultColumns, quando for a primeira vez ou quando o defaultColumns for diferente do currentValue
        if (firstChange || this.defaultColumns.length !== currentValue.length) {
            this.defaultColumns = currentValue;
        }
        // verifica se o valor anterior é diferente do atual para atualizar as columnsOptions apenas quando for necessario
        if (previousValue.length !== currentValue.length) {
            this.updateColumnsOptions(currentValue);
        }
    };
    PoTableColumnManagerComponent.prototype.removeListeners = function () {
        if (this.resizeListener) {
            this.resizeListener();
        }
    };
    PoTableColumnManagerComponent.prototype.updateColumnsOptions = function (columns) {
        this.visibleColumns = this.getVisibleColumns(columns);
        this.columnsOptions = this.mapTableColumnsToCheckboxOptions(columns);
        this.onChangeVisibleColumns(this.visibleColumns);
    };
    PoTableColumnManagerComponent.ctorParameters = function () { return [
        { type: Renderer2 }
    ]; };
    __decorate([
        Input('p-columns'),
        __metadata("design:type", Array)
    ], PoTableColumnManagerComponent.prototype, "columns", void 0);
    __decorate([
        Input('p-max-columns'),
        __metadata("design:type", Number),
        __metadata("design:paramtypes", [Number])
    ], PoTableColumnManagerComponent.prototype, "maxColumns", null);
    __decorate([
        Input('p-target'),
        __metadata("design:type", ElementRef)
    ], PoTableColumnManagerComponent.prototype, "target", void 0);
    __decorate([
        Output('p-visible-columns-change'),
        __metadata("design:type", Object)
    ], PoTableColumnManagerComponent.prototype, "visibleColumnsChange", void 0);
    __decorate([
        ViewChild(PoPopoverComponent),
        __metadata("design:type", PoPopoverComponent)
    ], PoTableColumnManagerComponent.prototype, "popover", void 0);
    PoTableColumnManagerComponent = __decorate([
        Component({
            selector: 'po-table-column-manager',
            template: "<po-popover #popover *ngIf=\"target\" [p-target]=\"target\" p-position=\"bottom-left\">\n  <div class=\"po-table-column-manager-header\">\n    <div class=\"po-table-column-manager-header-title\">{{ literals.columnsManager }}</div>\n\n    <div class=\"po-table-column-manager-header-close\">\n      <button\n        class=\"po-table-column-manager-header-close-button po-clickable po-icon po-icon-close\"\n        (click)=\"popover.close()\"\n      ></button>\n    </div>\n  </div>\n\n  <div class=\"po-table-column-manager-body\">\n    <po-checkbox-group\n      name=\"visibleColumns\"\n      [(ngModel)]=\"visibleColumns\"\n      p-columns=\"1\"\n      [p-options]=\"columnsOptions\"\n      (p-change)=\"onChangeVisibleColumns($event)\"\n    >\n    </po-checkbox-group>\n  </div>\n\n  <div class=\"po-table-column-manager-footer\">\n    <po-button\n      class=\"po-table-column-manager-footer-restore\"\n      p-small\n      p-type=\"link\"\n      [p-label]=\"literals.restoreDefault\"\n      (p-click)=\"restore()\"\n    >\n    </po-button>\n  </div>\n</po-popover>\n"
        }),
        __metadata("design:paramtypes", [Renderer2])
    ], PoTableColumnManagerComponent);
    return PoTableColumnManagerComponent;
}());
export { PoTableColumnManagerComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tdGFibGUtY29sdW1uLW1hbmFnZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6Im5nOi8vQHBvLXVpL25nLWNvbXBvbmVudHMvIiwic291cmNlcyI6WyJsaWIvY29tcG9uZW50cy9wby10YWJsZS9wby10YWJsZS1jb2x1bW4tbWFuYWdlci9wby10YWJsZS1jb2x1bW4tbWFuYWdlci5jb21wb25lbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLE9BQU8sRUFDTCxTQUFTLEVBQ1QsVUFBVSxFQUNWLFlBQVksRUFDWixLQUFLLEVBQ0wsU0FBUyxFQUNULFNBQVMsRUFDVCxNQUFNLEVBQ04sTUFBTSxFQUNOLFlBQVksRUFDWixhQUFhLEVBQ2IsU0FBUyxFQUNULFNBQVMsRUFDVixNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUUsZUFBZSxFQUFFLHFCQUFxQixFQUFFLFlBQVksRUFBRSxlQUFlLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUU1RyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSx1Q0FBdUMsQ0FBQztBQUkzRSxJQUFNLHFDQUFxQyxHQUFHLEtBQUssQ0FBQztBQUVwRCxNQUFNLENBQUMsSUFBTSxtQ0FBbUMsR0FBRztJQUNqRCxFQUFFLEVBQUU7UUFDRixjQUFjLEVBQUUsaUJBQWlCO1FBQ2pDLGNBQWMsRUFBRSxpQkFBaUI7S0FDbEM7SUFDRCxFQUFFLEVBQUU7UUFDRixjQUFjLEVBQUUsb0JBQW9CO1FBQ3BDLGNBQWMsRUFBRSx1QkFBdUI7S0FDeEM7SUFDRCxFQUFFLEVBQUU7UUFDRixjQUFjLEVBQUUsd0JBQXdCO1FBQ3hDLGNBQWMsRUFBRSxrQkFBa0I7S0FDbkM7SUFDRCxFQUFFLEVBQUU7UUFDRixjQUFjLEVBQUUsa0JBQWtCO1FBQ2xDLGNBQWMsRUFBRSxnQkFBZ0I7S0FDakM7Q0FDRixDQUFDO0FBTUY7SUE2QkUsdUNBQW9CLFFBQW1CO1FBQW5CLGFBQVEsR0FBUixRQUFRLENBQVc7UUE1Qi9CLGdCQUFXLEdB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QkEvSDZCLFNBQVM7O0lBaEJuQjtRQUFuQixLQUFLLENBQUMsV0FBVyxDQUFDO2tDQUFVLEtBQUs7a0VBQXFCO0lBRS9CO1FBQXZCLEtBQUssQ0FBQyxlQUFlLENBQUM7OzttRUFFdEI7SUFNa0I7UUFBbEIsS0FBSyxDQUFDLFVBQVUsQ0FBQztrQ0FBUyxVQUFVO2lFQUFDO0lBRUY7UUFBbkMsTUFBTSxDQUFDLDBCQUEwQixDQUFDOzsrRUFBaUU7SUFFckU7UUFBOUIsU0FBUyxDQUFDLGtCQUFrQixDQUFDO2tDQUFVLGtCQUFrQjtrRUFBQztJQTNCaEQsNkJBQTZCO1FBSnpDLFNBQVMsQ0FBQztZQUNULFFBQVEsRUFBRSx5QkFBeUI7WUFDbkMsMGpDQUF1RDtTQUN4RCxDQUFDO3lDQThCOEIsU0FBUztPQTdCNUIsNkJBQTZCLENBNkp6QztJQUFELG9DQUFDO0NBQUEsQUE3SkQsSUE2SkM7U0E3SlksNkJBQTZCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgQ29tcG9uZW50LFxuICBFbGVtZW50UmVmLFxuICBFdmVudEVtaXR0ZXIsXG4gIElucHV0LFxuICBPbkNoYW5nZXMsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPdXRwdXQsXG4gIFNpbXBsZUNoYW5nZSxcbiAgU2ltcGxlQ2hhbmdlcyxcbiAgUmVuZGVyZXIyLFxuICBWaWV3Q2hpbGRcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5cbmltcG9ydCB7IGJyb3dzZXJMYW5ndWFnZSwgY2FwaXRhbGl6ZUZpcnN0TGV0dGVyLCBjb252ZXJ0VG9JbnQsIHBvTG9jYWxlRGVmYXVsdCB9IGZyb20gJy4uLy4uLy4uL3V0aWxzL3V0aWwnO1xuaW1wb3J0IHsgUG9DaGVja2JveEdyb3VwT3B0aW9uIH0gZnJvbSAnLi4vLi4vcG8tZmllbGQvcG8tY2hlY2tib3gtZ3JvdXAvaW50ZXJmYWNlcy9wby1jaGVja2JveC1ncm91cC1vcHRpb24uaW50ZXJmYWNlJztcbmltcG9ydCB7IFBvUG9wb3ZlckNvbXBvbmVudCB9IGZyb20gJy4uLy4uL3BvLXBvcG92ZXIvcG8tcG9wb3Zlci5jb21wb25lbnQnO1xuXG5pbXBvcnQgeyBQb1RhYmxlQ29sdW1uIH0gZnJvbSAnLi4vaW50ZXJmYWNlcy9wby10YWJsZS1jb2x1bW4uaW50ZXJmYWNlJztcblxuY29uc3QgUG9UYWJsZUNvbHVtbk1hbmFnZXJNYXhDb2x1bW5zRGVmYXVsdCA9IDk5OTk5O1xuXG5leHBvcnQgY29uc3QgcG9UYWJsZUNvbHVtbk1hbmFnZXJMaXRlcmFsc0RlZmF1bHQgPSB7XG4gIGVuOiB7XG4gICAgY29sdW1uc01hbmFnZXI6ICdDb2x1bW5zIG1hbmFnZXInLFxuICAgIHJlc3RvcmVEZWZhdWx0OiAnUmVzdG9yZSBkZWZhdWx0J1xuICB9LFxuICBlczoge1xuICAgIGNvbHVtbnNNYW5hZ2VyOiAnR2VyZW50ZSBkZSBjb2x1bW5hJyxcbiAgICByZXN0b3JlRGVmYXVsdDogJ1Jlc3RhdXJhciBwb3IgZGVmZWN0bydcbiAgfSxcbiAgcHQ6IHtcbiAgICBjb2x1bW5zTWFuYWdlcjogJ0dlcmVuY2lhZG9yIGRlIGNvbHVuYXMnLFxuICAgIHJlc3RvcmVEZWZhdWx0OiAnUmVzdGF1cmFyIHBhZHLDo28nXG4gIH0sXG4gIHJ1OiB7XG4gICAgY29sdW1uc01hbmFnZXI6ICfQvNC10L3QtdC00LbQtdGAINC60L7Qu9C+0L3QvtC6JyxcbiAgICByZXN0b3JlRGVmYXVsdDogJ9GB0LHRgNC+0YEg0L3QsNGB0YLRgNC+0LXQuidcbiAgfVxufTtcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tdGFibGUtY29sdW1uLW1hbmFnZXInLFxuICB0ZW1wbGF0ZVVybDogJy4vcG8tdGFibGUtY29sdW1uLW1hbmFnZXIuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvVGFibGVDb2x1bW5NYW5hZ2VyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkNoYW5nZXMsIE9uRGVzdHJveSB7XG4gIHByaXZhdGUgX21heENvbHVtbnM6IG51bWJlciA9IFBvVGFibGVDb2x1bW5NYW5hZ2VyTWF4Q29sdW1uc0RlZmF1bHQ7XG5cbiAgY29sdW1uc09wdGlvbnM6IEFycmF5PFBvQ2hlY2tib3hHcm91cE9wdGlvbj4gPSBbXTtcbiAgbGl0ZXJhbHMgPSB7XG4gICAgLi4ucG9UYWJsZUNvbHVtbk1hbmFnZXJMaXRlcmFsc0RlZmF1bHRbcG9Mb2NhbGVEZWZhdWx0XSxcbiAgICAuLi5wb1RhYmxlQ29sdW1uTWFuYWdlckxpdGVyYWxzRGVmYXVsdFticm93c2VyTGFuZ3VhZ2UoKV1cbiAgfTtcbiAgdmlzaWJsZUNvbHVtbnM6IEFycmF5PHN0cmluZz4gPSBbXTtcblxuICBwcml2YXRlIGRlZmF1bHRDb2x1bW5zOiBBcnJheTxQb1RhYmxlQ29sdW1uPiA9IFtdO1xuICBwcml2YXRlIHJlc2l6ZUxpc3RlbmVyOiAoKSA9PiB2b2lkO1xuXG4gIEBJbnB1dCgncC1jb2x1bW5zJykgY29sdW1uczogQXJyYXk8UG9UYWJsZUNvbHVtbj4gPSBbXTtcblxuICBASW5wdXQoJ3AtbWF4LWNvbHVtbnMnKSBzZXQgbWF4Q29sdW1ucyh2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5fbWF4Q29sdW1ucyA9IGNvbnZlcnRUb0ludCh2YWx1ZSwgUG9UYWJsZUNvbHVtbk1hbmFnZXJNYXhDb2x1bW5zRGVmYXVsdCk7XG4gIH1cblxuICBnZXQgbWF4Q29sdW1ucygpIHtcbiAgICByZXR1cm4gdGhpcy5fbWF4Q29sdW1ucztcbiAgfVxuXG4gIEBJbnB1dCgncC10YXJnZXQnKSB0YXJnZXQ6IEVsZW1lbnRSZWY7XG5cbiAgQE91dHB1dCgncC12aXNpYmxlLWNvbHVtbnMtY2hhbmdlJykgdmlzaWJsZUNvbHVtbnNDaGFuZ2UgPSBuZXcgRXZlbnRFbWl0dGVyPEFycmF5PFBvVGFibGVDb2x1bW4+PigpO1xuXG4gIEBWaWV3Q2hpbGQoUG9Qb3BvdmVyQ29tcG9uZW50KSBwb3BvdmVyOiBQb1BvcG92ZXJDb21wb25lbnQ7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSByZW5kZXJlcjogUmVuZGVyZXIyKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMudXBkYXRlQ29sdW1uc09wdGlvbnModGhpcy5jb2x1bW5zKTtcbiAgfVxuXG4gIG5nT25DaGFuZ2VzKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMpIHtcbiAgICBjb25zdCB7IGNvbHVtbnMsIG1heENvbHVtbnMsIHRhcmdldCB9ID0gY2hhbmdlcztcblxuICAgIGlmICh0YXJnZXQgJiYgdGFyZ2V0LmZpcnN0Q2hhbmdlKSB7XG4gICAgICB0aGlzLmluaXRpYWxpemVMaXN0ZW5lcnMoKTtcbiAgICB9XG5cbiAgICBpZiAoY29sdW1ucykge1xuICAgICAgdGhpcy5vbkNoYW5nZUNvbHVtbnMoY29sdW1ucyk7XG4gICAgfVxuXG4gICAgaWYgKG1heENvbHVtbnMpIHtcbiAgICAgIHRoaXMudXBkYXRlQ29sdW1uc09wdGlvbnModGhpcy5jb2x1bW5zKTtcbiAgICB9XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnJlbW92ZUxpc3RlbmVycygpO1xuICB9XG5cbiAgb25DaGFuZ2VWaXNpYmxlQ29sdW1ucyhjaGVja2VkQ29sdW1uczogQXJyYXk8c3RyaW5nPikge1xuICAgIHRoaXMuZGlzYWJsZUNvbHVtbnNPcHRpb25zKHRoaXMuY29sdW1uc09wdGlvbnMpO1xuXG4gICAgY29uc3QgdmlzaWJsZVRhYmxlQ29sdW1ucyA9IHRoaXMuZ2V0VmlzaWJsZVRhYmxlQ29sdW1ucyhjaGVja2VkQ29sdW1ucyk7XG5cbiAgICB0aGlzLnZpc2libGVDb2x1bW5zQ2hhbmdlLmVtaXQodmlzaWJsZVRhYmxlQ29sdW1ucyk7XG4gIH1cblxuICByZXN0b3JlKCkge1xuICAgIHRoaXMudXBkYXRlQ29sdW1uc09wdGlvbnModGhpcy5kZWZhdWx0Q29sdW1ucyk7XG4gIH1cblxuICAvLyBkZXNhYmlsaXRhcsOhIGFzIGNvbHVuYXMsIHF1ZSBuw6NvIGVzdGl2ZXJlbSBzZWxlY2lvbmFkYXMsIGFww7NzIGV4ZWRlciBvIG51bWVybyBtYXhpbW8gZGUgY29sdW5hcy5cbiAgcHJpdmF0ZSBkaXNhYmxlQ29sdW1uc09wdGlvbnMoY29sdW1uczogQXJyYXk8UG9DaGVja2JveEdyb3VwT3B0aW9uPiA9IFtdKSB7XG4gICAgLy8gbmVjZXNzYXJpbyB0aW1lb3V0IHBhcmEgcXVlIHNlamEgcG9zc2l2ZWwgYXR1YWxpemFyIG9zIGNvbHVtbnNPcHRpb25zIGFwb3MgYSBtdWRhbsOnYSBkbyBtb2RlbFxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5jb2x1bW5zT3B0aW9ucyA9IGNvbHVtbnMubWFwKGNvbHVtbiA9PiAoe1xuICAgICAgICAuLi5jb2x1bW4sXG4gICAgICAgIGRpc2FibGVkOiB0aGlzLmlzRGlzYWJsZUNvbHVtbihjb2x1bW4udmFsdWUpXG4gICAgICB9KSk7XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGdldENvbHVtblRpdGxlTGFiZWwoY29sdW1uOiBQb1RhYmxlQ29sdW1uKSB7XG4gICAgcmV0dXJuIGNvbHVtbi5sYWJlbCB8fCBjYXBpdGFsaXplRmlyc3RMZXR0ZXIoY29sdW1uLnByb3BlcnR5KTtcbiAgfVxuXG4gIC8qKiBSZXRvcm5hIHVtIEFycmF5IGRlIGNvbHVtbi5wcm9wZXJ0eSBkYXMgY29sdW5hcyBxdWUgc8OjbyB2aXNpdmVpcy4gKi9cbiAgcHJpdmF0ZSBnZXRWaXNpYmxlQ29sdW1ucyhjb2x1bW5zOiBBcnJheTxQb1RhYmxlQ29sdW1uPik6IEFycmF5PHN0cmluZz4ge1xuICAgIGNvbnN0IHZpc2libGVDb2x1bW5zID0gW107XG5cbiAgICBjb2x1bW5zLmZvckVhY2goY29sdW1uID0+IHtcbiAgICAgIGlmIChjb2x1bW4udmlzaWJsZSAhPT0gZmFsc2UgJiYgdmlzaWJsZUNvbHVtbnMubGVuZ3RoIDwgdGhpcy5tYXhDb2x1bW5zICYmIGNvbHVtbi50eXBlICE9PSAnZGV0YWlsJykge1xuICAgICAgICB2aXNpYmxlQ29sdW1ucy5wdXNoKGNvbHVtbi5wcm9wZXJ0eSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdmlzaWJsZUNvbHVtbnM7XG4gIH1cblxuICAvKiogUmV0b3JuYSB1bSBBcnJheSBQb1RhYmxlQ29sdW1uIGEgcGFydGlyIGRhcyBjb2x1bmFzIHZpc2l2ZWlzIG5vIGdlcmVuY2lhZG9yIGRlIGNvbHVuYXMuICovXG4gIHByaXZhdGUgZ2V0VmlzaWJsZVRhYmxlQ29sdW1ucyh2aXNpYmxlQ29sdW1uczogQXJyYXk8c3RyaW5nPik6IEFycmF5PFBvVGFibGVDb2x1bW4+IHtcbiAgICByZXR1cm4gdGhpcy5jb2x1bW5zLm1hcChjb2x1bW4gPT4gKHtcbiAgICAgIC4uLmNvbHVtbixcbiAgICAgIHZpc2libGU6IHZpc2libGVDb2x1bW5zLmluY2x1ZGVzKGNvbHVtbi5wcm9wZXJ0eSkgfHwgY29sdW1uLnR5cGUgPT09ICdkZXRhaWwnXG4gICAgfSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBpbml0aWFsaXplTGlzdGVuZXJzKCkge1xuICAgIHRoaXMucmVzaXplTGlzdGVuZXIgPSB0aGlzLnJlbmRlcmVyLmxpc3Rlbignd2luZG93JywgJ3Jlc2l6ZScsICgpID0+IHtcbiAgICAgIGlmICh0aGlzLnBvcG92ZXIpIHtcbiAgICAgICAgdGhpcy5wb3BvdmVyLmNsb3NlKCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGlzRGlzYWJsZUNvbHVtbihwcm9wZXJ0eTogc3RyaW5nKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMudmlzaWJsZUNvbHVtbnMubGVuZ3RoID49IHRoaXMubWF4Q29sdW1ucyA/ICF0aGlzLnZpc2libGVDb2x1bW5zLmluY2x1ZGVzKHByb3BlcnR5KSA6IGZhbHNlO1xuICB9XG5cbiAgcHJpdmF0ZSBtYXBUYWJsZUNvbHVtbnNUb0NoZWNrYm94T3B0aW9ucyhjb2x1bW5zOiBBcnJheTxQb1RhYmxlQ29sdW1uPiA9IFtdKSB7XG4gICAgY29uc3QgY29sdW1uc09wdGlvbnMgPSBbXTtcblxuICAgIGNvbHVtbnMuZm9yRWFjaChjb2x1bW4gPT4ge1xuICAgICAgaWYgKGNvbHVtbi50eXBlICE9PSAnZGV0YWlsJykge1xuICAgICAgICBjb2x1bW5zT3B0aW9ucy5wdXNoKHtcbiAgICAgICAgICB2YWx1ZTogY29sdW1uLnByb3BlcnR5LFxuICAgICAgICAgIGxhYmVsOiB0aGlzLmdldENvbHVtblRpdGxlTGFiZWwoY29sdW1uKSxcbiAgICAgICAgICBkaXNhYmxlZDogdGhpcy5pc0Rpc2FibGVDb2x1bW4oY29sdW1uLnByb3BlcnR5KVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJldHVybiBjb2x1bW5zT3B0aW9ucztcbiAgfVxuXG4gIHByaXZhdGUgb25DaGFuZ2VDb2x1bW5zKGNvbHVtbnM6IFNpbXBsZUNoYW5nZSkge1xuICAgIGNvbnN0IHsgZmlyc3RDaGFuZ2UsIGN1cnJlbnRWYWx1ZSA9IFtdLCBwcmV2aW91c1ZhbHVlID0gW10gfSA9IGNvbHVtbnM7XG5cbiAgICAvLyBhdHVhbGl6YXJhIG8gZGVmYXVsdENvbHVtbnMsIHF1YW5kbyBmb3IgYSBwcmltZWlyYSB2ZXogb3UgcXVhbmRvIG8gZGVmYXVsdENvbHVtbnMgZm9yIGRpZmVyZW50ZSBkbyBjdXJyZW50VmFsdWVcbiAgICBpZiAoZmlyc3RDaGFuZ2UgfHwgdGhpcy5kZWZhdWx0Q29sdW1ucy5sZW5ndGggIT09IGN1cnJlbnRWYWx1ZS5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZGVmYXVsdENvbHVtbnMgPSBjdXJyZW50VmFsdWU7XG4gICAgfVxuXG4gICAgLy8gdmVyaWZpY2Egc2UgbyB2YWxvciBhbnRlcmlvciDDqSBkaWZlcmVudGUgZG8gYXR1YWwgcGFyYSBhdHVhbGl6YXIgYXMgY29sdW1uc09wdGlvbnMgYXBlbmFzIHF1YW5kbyBmb3IgbmVjZXNzYXJpb1xuICAgIGlmIChwcmV2aW91c1ZhbHVlLmxlbmd0aCAhPT0gY3VycmVudFZhbHVlLmxlbmd0aCkge1xuICAgICAgdGhpcy51cGRhdGVDb2x1bW5zT3B0aW9ucyhjdXJyZW50VmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXJzKCkge1xuICAgIGlmICh0aGlzLnJlc2l6ZUxpc3RlbmVyKSB7XG4gICAgICB0aGlzLnJlc2l6ZUxpc3RlbmVyKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVDb2x1bW5zT3B0aW9ucyhjb2x1bW5zOiBBcnJheTxQb1RhYmxlQ29sdW1uPikge1xuICAgIHRoaXMudmlzaWJsZUNvbHVtbnMgPSB0aGlzLmdldFZpc2libGVDb2x1bW5zKGNvbHVtbnMpO1xuICAgIHRoaXMuY29sdW1uc09wdGlvbnMgPSB0aGlzLm1hcFRhYmxlQ29sdW1uc1RvQ2hlY2tib3hPcHRpb25zKGNvbHVtbnMpO1xuXG4gICAgdGhpcy5vbkNoYW5nZVZpc2libGVDb2x1bW5zKHRoaXMudmlzaWJsZUNvbHVtbnMpO1xuICB9XG59XG4iXX0=