import { __assign, __awaiter, __decorate, __generator, __metadata } from "tslib";
import { Component, ElementRef, EventEmitter, Output, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { convertImageToBase64, isExternalLink, isIE } from '../../../../utils/util';
import { PoLanguageService } from './../../../../services/po-language/po-language.service';
import { PoModalComponent } from '../../../po-modal';
import { poRichTextLiteralsDefault } from '../po-rich-text-literals';
import { PoRichTextModalType } from '../enums/po-rich-text-modal-type.enum';
import { PoUploadComponent } from '../../po-upload/po-upload.component';
var uploadRestrictions = ['.apng', '.bmp', '.gif', '.ico', '.jpeg', '.jpg', '.png', '.svg'];
var PoRichTextModalComponent = /** @class */ (function () {
    function PoRichTextModalComponent(languageService) {
        var _this = this;
        this.languageService = languageService;
        this.selection = document.getSelection();
        this.uploadRestrictions = {
            allowedExtensions: uploadRestrictions
        };
        this.literals = __assign({}, poRichTextLiteralsDefault[this.languageService.getShortLanguage()]);
        this.modalCancelAction = {
            label: this.literals.cancel,
            action: function () {
                _this.modal.close();
                _this.command.emit();
                _this.retrieveCursorPosition();
                _this.cleanUpFields();
            }
        };
        this.modalConfirmAction = {
            label: this.literals.insert,
            disabled: false,
            action: function () { return _this.insertElementRef(); }
        };
        this.modalLinkConfirmAction = {
            label: this.linkConfirmAction(),
            disabled: true,
            action: function () { return (_this.isLinkEditing ? _this.toEditLink() : _this.toInsertLink(_this.urlLink, _this.urlLinkText)); }
        };
        this.command = new EventEmitter();
        this.linkEditing = new EventEmitter();
    }
    Object.defineProperty(PoRichTextModalComponent.prototype, "modalTitle", {
        get: function () {
            if (this.modalType === 'image') {
                return this.literals.insertImage;
            }
            return this.linkConfirmAction();
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoRichTextModalComponent.prototype, "isUploadValid", {
        get: function () {
            return !!(this.uploadModel && this.uploadModel.length);
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoRichTextModalComponent.prototype, "isUrlValid", {
        get: function () {
            return !!this.urlImage && this.modalImageForm && this.modalImageForm.valid;
        },
        enumerable: true,
        configurable: true
    });
    Object.defineProperty(PoRichTextModalComponent.prototype, "modalPrimaryAction", {
        get: function () {
            return this.modalType === 'image' ? this.modalConfirmAction : this.modalLinkConfirmAction;
        },
        enumerable: true,
        configurable: true
    });
    PoRichTextModalComponent.prototype.convertToBase64 = function () {
        return __awaiter(this, void 0, void 0, function () {
            var uploadImage;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!this.isUploadValid) return [3 /*break*/, 2];
                        uploadImage = this.uploadModel[0].rawFile;
                        return [4 /*yield*/, convertImageToBase64(uploadImage)];
                    case 1: return [2 /*return*/, _a.sent()];
                    case 2: return [2 /*return*/];
                }
            });
        });
    };
    PoRichTextModalComponent.prototype.linkConfirmAction = function () {
        return this.isLinkEditing ? this.literals.editLink : this.literals.insertLink;
    };
    PoRichTextModalComponent.prototype.emitCommand = function (value) {
        var command;
        if (value && this.modalType === PoRichTextModalType.Image) {
            command = 'insertImage';
            this.command.emit({ command: command, value: value });
        }
    };
    PoRichTextModalComponent.prototype.formModelValidate = function () {
        return (this.modalLinkConfirmAction.disabled = this.modalLinkForm && this.modalLinkForm.invalid);
    };
    PoRichTextModalComponent.prototype.insertElementRef = function () {
        return __awaiter(this, void 0, void 0, function () {
            var uploadImage;
            return __generator(this, function (_a) {
                switch (_a.label) {
                    case 0:
                        if (!(this.modalType === PoRichTextModalType.Image && !this.urlImage)) return [3 /*break*/, 2];
                        return [4 /*yield*/, this.convertToBase64()];
                    case 1:
                        uploadImage = _a.sent();
                        _a.label = 2;
                    case 2:
                        this.retrieveCursorPosition();
                        this.modal.close();
                        if (this.isUrlValid || this.isUploadValid) {
                            this.emitCommand(this.urlImage || uploadImage);
                        }
                        this.cleanUpFields();
                        return [2 /*return*/];
                }
            });
        });
    };
    PoRichTextModalComponent.prototype.openModal = function (type) {
        this.modalType = type;
        this.saveCursorPosition();
        if (this.modalType === PoRichTextModalType.Link) {
            this.prepareModalForLink();
            this.modalLinkConfirmAction.label = this.linkConfirmAction();
        }
        this.modal.open();
    };
    PoRichTextModalComponent.prototype.selectedLink = function (event) {
        this.isSelectedLink = !!event;
        this.linkElement = event;
    };
    PoRichTextModalComponent.prototype.checkIfIsEmpty = function (urlLink, urlLinkText) {
        return urlLinkText === undefined || urlLinkText.trim() === '' ? urlLink : urlLinkText;
    };
    PoRichTextModalComponent.prototype.cleanUpFields = function () {
        this.urlImage = undefined;
        this.urlLink = undefined;
        this.urlLinkText = undefined;
        this.uploadModel = undefined;
        this.isLinkEditing = false;
        this.isSelectedLink = false;
        this.linkElement = undefined;
    };
    PoRichTextModalComponent.prototype.formReset = function (control) {
        control.markAsPristine();
        control.markAsUntouched();
        control.updateValueAndValidity();
    };
    PoRichTextModalComponent.prototype.prepareModalForLink = function () {
        var _this = this;
        this.saveSelectionText();
        if (this.modalLinkForm) {
            this.formReset(this.modalLinkForm.control);
        }
        setTimeout(function () {
            _this.formModelValidate();
        });
        if (this.isSelectedLink) {
            this.isLinkEditing = true;
            this.setLinkEditableForModal();
        }
        this.linkEditing.emit(this.isLinkEditing);
    };
    PoRichTextModalComponent.prototype.restoreSelection = function () {
        if (this.savedSelection) {
            if (this.selection) {
                this.selection.removeAllRanges();
                this.selection.addRange(this.savedSelection);
            }
            return true;
        }
        else {
            return false;
        }
    };
    PoRichTextModalComponent.prototype.retrieveCursorPosition = function () {
        this.selection.collapse(this.savedCursorPosition[0], this.savedCursorPosition[1]);
    };
    PoRichTextModalComponent.prototype.saveCursorPosition = function () {
        this.savedCursorPosition = [this.selection.focusNode, this.selection.focusOffset];
    };
    PoRichTextModalComponent.prototype.saveSelectionText = function () {
        if (this.selection.anchorNode !== null) {
            this.savedSelection = this.selection.getRangeAt(0);
            this.urlLinkText = this.selection.toString();
        }
        else {
            return null;
        }
    };
    PoRichTextModalComponent.prototype.setLinkEditableForModal = function () {
        this.urlLinkText = this.linkElement.innerText;
        this.urlLink = this.linkElement.getAttribute('href');
    };
    PoRichTextModalComponent.prototype.toEditLink = function () {
        if (isIE()) {
            this.linkElement.parentNode.removeChild(this.linkElement);
        }
        else {
            this.linkElement.remove();
        }
        this.toInsertLink(this.urlLink, this.urlLinkText);
    };
    PoRichTextModalComponent.prototype.toInsertLink = function (urlLink, urlLinkText) {
        this.modal.close();
        this.restoreSelection();
        var urlLinkTextValue = this.checkIfIsEmpty(urlLink, urlLinkText);
        var urlAsExternalLink = isExternalLink(urlLink) ? urlLink : "http://" + urlLink;
        var command = 'InsertHTML';
        var value = { urlLink: urlAsExternalLink, urlLinkText: urlLinkTextValue };
        this.command.emit({ command: command, value: value });
        this.cleanUpFields();
    };
    PoRichTextModalComponent.ctorParameters = function () { return [
        { type: PoLanguageService }
    ]; };
    __decorate([
        ViewChild('modal', { static: true }),
        __metadata("design:type", PoModalComponent)
    ], PoRichTextModalComponent.prototype, "modal", void 0);
    __decorate([
        ViewChild('modalImageForm'),
        __metadata("design:type", NgForm)
    ], PoRichTextModalComponent.prototype, "modalImageForm", void 0);
    __decorate([
        ViewChild('upload', { static: true }),
        __metadata("design:type", PoUploadComponent)
    ], PoRichTextModalComponent.prototype, "upload", void 0);
    __decorate([
        ViewChild('modalImage', { static: true }),
        __metadata("design:type", ElementRef)
    ], PoRichTextModalComponent.prototype, "modalImage", void 0);
    __decorate([
        ViewChild('modalLink', { static: true }),
        __metadata("design:type", PoModalComponent)
    ], PoRichTextModalComponent.prototype, "modalLink", void 0);
    __decorate([
        ViewChild('modalLinkForm'),
        __metadata("design:type", NgForm)
    ], PoRichTextModalComponent.prototype, "modalLinkForm", void 0);
    __decorate([
        Output('p-command'),
        __metadata("design:type", Object)
    ], PoRichTextModalComponent.prototype, "command", void 0);
    __decorate([
        Output('p-link-editing'),
        __metadata("design:type", Object)
    ], PoRichTextModalComponent.prototype, "linkEditing", void 0);
    PoRichTextModalComponent = __decorate([
        Component({
            selector: 'po-rich-text-modal',
            template: "<po-modal\n  #modal\n  p-hide-close\n  [p-primary-action]=\"modalPrimaryAction\"\n  [p-secondary-action]=\"modalCancelAction\"\n  [p-title]=\"modalTitle\"\n>\n  <ng-container *ngTemplateOutlet=\"modalType === 'image' ? modalImage : modalLink\"></ng-container>\n</po-modal>\n\n<ng-template #modalImage>\n  <form #modalImageForm=\"ngForm\">\n    <div class=\"po-row\">\n      <!-- po-upload desabilita o drag drop caso n\u00E3o tenha valor atribuido para a propriedade p-url -->\n      <po-upload\n        #upload\n        class=\"po-md-12\"\n        name=\"upload\"\n        [(ngModel)]=\"uploadModel\"\n        p-drag-drop-height=\"160\"\n        p-hide-restrictions-info\n        p-hide-send-button\n        p-url=\"x\"\n        [p-drag-drop]=\"!modal.isHidden\"\n        [p-disabled]=\"isUrlValid\"\n        [p-restrictions]=\"uploadRestrictions\"\n      >\n      </po-upload>\n    </div>\n\n    <div class=\"po-row\">\n      <po-url\n        class=\"po-md-12 po-mt-3\"\n        name=\"url\"\n        [(ngModel)]=\"urlImage\"\n        [p-label]=\"literals.urlImage\"\n        [p-disabled]=\"isUploadValid\"\n      >\n      </po-url>\n    </div>\n  </form>\n</ng-template>\n\n<ng-template #modalLink>\n  <form #modalLinkForm=\"ngForm\">\n    <div class=\"po-row\">\n      <po-input\n        class=\"po-md-12 po-mb-2\"\n        name=\"urlLinkText\"\n        [(ngModel)]=\"urlLinkText\"\n        p-optional\n        [p-label]=\"literals.linkTextLabel\"\n        [p-placeholder]=\"literals.linkTextLabel\"\n      >\n      </po-input>\n\n      <po-url\n        class=\"po-md-12\"\n        name=\"urlLink\"\n        [(ngModel)]=\"urlLink\"\n        p-label=\"Link\"\n        p-required\n        [p-help]=\"literals.linkUrlTextHelper\"\n        [p-placeholder]=\"literals.linkUrlTextPlaceholder\"\n        (p-change-model)=\"formModelValidate()\"\n      >\n      </po-url>\n    </div>\n  </form>\n</ng-template>\n"
        }),
        __metadata("design:paramtypes", [PoLanguageService])
    ], PoRichTextModalComponent);
    return PoRichTextModalComponent;
}());
export { PoRichTextModalComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tcmljaC10ZXh0LW1vZGFsLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwby11aS9uZy1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZmllbGQvcG8tcmljaC10ZXh0L3BvLXJpY2gtdGV4dC1tb2RhbC9wby1yaWNoLXRleHQtbW9kYWwuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQUUsU0FBUyxFQUFFLFVBQVUsRUFBRSxZQUFZLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN2RixPQUFPLEVBQW1CLE1BQU0sRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRXpELE9BQU8sRUFBRSxvQkFBb0IsRUFBRSxjQUFjLEVBQUUsSUFBSSxFQUFFLE1BQU0sd0JBQXdCLENBQUM7QUFDcEYsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sd0RBQXdELENBQUM7QUFFM0YsT0FBTyxFQUFpQixnQkFBZ0IsRUFBRSxNQUFNLG1CQUFtQixDQUFDO0FBQ3BFLE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQ3JFLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBQzVFLE9BQU8sRUFBRSxpQkFBaUIsRUFBRSxNQUFNLHFDQUFxQyxDQUFDO0FBR3hFLElBQU0sa0JBQWtCLEdBQUcsQ0FBQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUUsTUFBTSxDQUFDLENBQUM7QUFNOUY7SUErRUUsa0NBQW9CLGVBQWtDO1FBQXRELGlCQUEwRDtRQUF0QyxvQkFBZSxHQUFmLGVBQWUsQ0FBbUI7UUE1RXRELGNBQVMsR0FBRyxRQUFRLENBQUMsWUFBWSxFQUFFLENBQUM7UUFFcEMsdUJBQWtCLEdBQTZCO1lBQzdDLGlCQUFpQixFQUFFLGtCQUFr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ZWYsIEV2ZW50RW1pdHRlciwgT3V0cHV0LCBWaWV3Q2hpbGQgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFic3RyYWN0Q29udHJvbCwgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQgeyBjb252ZXJ0SW1hZ2VUb0Jhc2U2NCwgaXNFeHRlcm5hbExpbmssIGlzSUUgfSBmcm9tICcuLi8uLi8uLi8uLi91dGlscy91dGlsJztcbmltcG9ydCB7IFBvTGFuZ3VhZ2VTZXJ2aWNlIH0gZnJvbSAnLi8uLi8uLi8uLi8uLi9zZXJ2aWNlcy9wby1sYW5ndWFnZS9wby1sYW5ndWFnZS5zZXJ2aWNlJztcblxuaW1wb3J0IHsgUG9Nb2RhbEFjdGlvbiwgUG9Nb2RhbENvbXBvbmVudCB9IGZyb20gJy4uLy4uLy4uL3BvLW1vZGFsJztcbmltcG9ydCB7IHBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHQgfSBmcm9tICcuLi9wby1yaWNoLXRleHQtbGl0ZXJhbHMnO1xuaW1wb3J0IHsgUG9SaWNoVGV4dE1vZGFsVHlwZSB9IGZyb20gJy4uL2VudW1zL3BvLXJpY2gtdGV4dC1tb2RhbC10eXBlLmVudW0nO1xuaW1wb3J0IHsgUG9VcGxvYWRDb21wb25lbnQgfSBmcm9tICcuLi8uLi9wby11cGxvYWQvcG8tdXBsb2FkLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb1VwbG9hZEZpbGVSZXN0cmljdGlvbnMgfSBmcm9tICcuLi8uLi9wby11cGxvYWQvaW50ZXJmYWNlcy9wby11cGxvYWQtZmlsZS1yZXN0cmljdGlvbi5pbnRlcmZhY2UnO1xuXG5jb25zdCB1cGxvYWRSZXN0cmljdGlvbnMgPSBbJy5hcG5nJywgJy5ibXAnLCAnLmdpZicsICcuaWNvJywgJy5qcGVnJywgJy5qcGcnLCAnLnBuZycsICcuc3ZnJ107XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ3BvLXJpY2gtdGV4dC1tb2RhbCcsXG4gIHRlbXBsYXRlVXJsOiAnLi9wby1yaWNoLXRleHQtbW9kYWwuY29tcG9uZW50Lmh0bWwnXG59KVxuZXhwb3J0IGNsYXNzIFBvUmljaFRleHRNb2RhbENvbXBvbmVudCB7XG4gIG1vZGFsVHlwZTogUG9SaWNoVGV4dE1vZGFsVHlwZTtcbiAgc2F2ZWRDdXJzb3JQb3NpdGlvbjtcbiAgc2VsZWN0aW9uID0gZG9jdW1lbnQuZ2V0U2VsZWN0aW9uKCk7XG4gIHVwbG9hZE1vZGVsOiBBcnJheTxhbnk+O1xuICB1cGxvYWRSZXN0cmljdGlvbnM6IFBvVXBsb2FkRmlsZVJlc3RyaWN0aW9ucyA9IHtcbiAgICBhbGxvd2VkRXh0ZW5zaW9uczogdXBsb2FkUmVzdHJpY3Rpb25zXG4gIH07XG4gIHVybEltYWdlOiBzdHJpbmc7XG4gIHVybExpbms6IHN0cmluZztcbiAgdXJsTGlua1RleHQ6IHN0cmluZztcblxuICBwcml2YXRlIGlzTGlua0VkaXRpbmc6IGJvb2xlYW47XG4gIHByaXZhdGUgaXNTZWxlY3RlZExpbms6IGJvb2xlYW47XG4gIHByaXZhdGUgbGlua0VsZW1lbnQ6IGFueTtcbiAgcHJpdmF0ZSBzYXZlZFNlbGVjdGlvbjogUmFuZ2UgfCBudWxsO1xuXG4gIHJlYWRvbmx5IGxpdGVyYWxzID0ge1xuICAgIC4uLnBvUmljaFRleHRMaXRlcmFsc0RlZmF1bHRbdGhpcy5sYW5ndWFnZVNlcnZpY2UuZ2V0U2hvcnRMYW5ndWFnZSgpXVxuICB9O1xuXG4gIG1vZGFsQ2FuY2VsQWN0aW9uOiBQb01vZGFsQWN0aW9uID0ge1xuICAgIGxhYmVsOiB0aGlzLmxpdGVyYWxzLmNhbmNlbCxcbiAgICBhY3Rpb246ICgpID0+IHtcbiAgICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcbiAgICAgIHRoaXMuY29tbWFuZC5lbWl0KCk7XG4gICAgICB0aGlzLnJldHJpZXZlQ3Vyc29yUG9zaXRpb24oKTtcbiAgICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xuICAgIH1cbiAgfTtcblxuICBtb2RhbENvbmZpcm1BY3Rpb246IFBvTW9kYWxBY3Rpb24gPSB7XG4gICAgbGFiZWw6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0LFxuICAgIGRpc2FibGVkOiBmYWxzZSxcbiAgICBhY3Rpb246ICgpID0+IHRoaXMuaW5zZXJ0RWxlbWVudFJlZigpXG4gIH07XG5cbiAgbW9kYWxMaW5rQ29uZmlybUFjdGlvbiA9IHtcbiAgICBsYWJlbDogdGhpcy5saW5rQ29uZmlybUFjdGlvbigpLFxuICAgIGRpc2FibGVkOiB0cnVlLFxuICAgIGFjdGlvbjogKCkgPT4gKHRoaXMuaXNMaW5rRWRpdGluZyA/IHRoaXMudG9FZGl0TGluaygpIDogdGhpcy50b0luc2VydExpbmsodGhpcy51cmxMaW5rLCB0aGlzLnVybExpbmtUZXh0KSlcbiAgfTtcblxuICBnZXQgbW9kYWxUaXRsZSgpOiBzdHJpbmcge1xuICAgIGlmICh0aGlzLm1vZGFsVHlwZSA9PT0gJ2ltYWdlJykge1xuICAgICAgcmV0dXJuIHRoaXMubGl0ZXJhbHMuaW5zZXJ0SW1hZ2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubGlua0NvbmZpcm1BY3Rpb24oKTtcbiAgfVxuXG4gIGdldCBpc1VwbG9hZFZhbGlkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhISh0aGlzLnVwbG9hZE1vZGVsICYmIHRoaXMudXBsb2FkTW9kZWwubGVuZ3RoKTtcbiAgfVxuXG4gIGdldCBpc1VybFZhbGlkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMudXJsSW1hZ2UgJiYgdGhpcy5tb2RhbEltYWdlRm9ybSAmJiB0aGlzLm1vZGFsSW1hZ2VGb3JtLnZhbGlkO1xuICB9XG5cbiAgZ2V0IG1vZGFsUHJpbWFyeUFjdGlvbigpIHtcbiAgICByZXR1cm4gdGhpcy5tb2RhbFR5cGUgPT09ICdpbWFnZScgPyB0aGlzLm1vZGFsQ29uZmlybUFjdGlvbiA6IHRoaXMubW9kYWxMaW5rQ29uZmlybUFjdGlvbjtcbiAgfVxuXG4gIEBWaWV3Q2hpbGQoJ21vZGFsJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWw6IFBvTW9kYWxDb21wb25lbnQ7XG5cbiAgQFZpZXdDaGlsZCgnbW9kYWxJbWFnZUZvcm0nKSBtb2RhbEltYWdlRm9ybTogTmdGb3JtO1xuXG4gIEBWaWV3Q2hpbGQoJ3VwbG9hZCcsIHsgc3RhdGljOiB0cnVlIH0pIHVwbG9hZDogUG9VcGxvYWRDb21wb25lbnQ7XG5cbiAgQFZpZXdDaGlsZCgnbW9kYWxJbWFnZScsIHsgc3RhdGljOiB0cnVlIH0pIG1vZGFsSW1hZ2U6IEVsZW1lbnRSZWY7XG5cbiAgQFZpZXdDaGlsZCgnbW9kYWxMaW5rJywgeyBzdGF0aWM6IHRydWUgfSkgbW9kYWxMaW5rOiBQb01vZGFsQ29tcG9uZW50O1xuXG4gIEBWaWV3Q2hpbGQoJ21vZGFsTGlua0Zvcm0nKSBtb2RhbExpbmtGb3JtOiBOZ0Zvcm07XG5cbiAgQE91dHB1dCgncC1jb21tYW5kJykgY29tbWFuZCA9IG5ldyBFdmVudEVtaXR0ZXI8c3RyaW5nIHwgeyBjb21tYW5kOiBzdHJpbmc7IHZhbHVlOiBzdHJpbmcgfCBhbnkgfT4oKTtcblxuICBAT3V0cHV0KCdwLWxpbmstZWRpdGluZycpIGxpbmtFZGl0aW5nID0gbmV3IEV2ZW50RW1pdHRlcjxhbnk+KCk7XG5cbiAgY29uc3RydWN0b3IocHJpdmF0ZSBsYW5ndWFnZVNlcnZpY2U6IFBvTGFuZ3VhZ2VTZXJ2aWNlKSB7fVxuXG4gIGFzeW5jIGNvbnZlcnRUb0Jhc2U2NCgpIHtcbiAgICBpZiAodGhpcy5pc1VwbG9hZFZhbGlkKSB7XG4gICAgICBjb25zdCB1cGxvYWRJbWFnZSA9IHRoaXMudXBsb2FkTW9kZWxbMF0ucmF3RmlsZTtcbiAgICAgIHJldHVybiBhd2FpdCBjb252ZXJ0SW1hZ2VUb0Jhc2U2NCh1cGxvYWRJbWFnZSk7XG4gICAgfVxuICB9XG5cbiAgbGlua0NvbmZpcm1BY3Rpb24oKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5pc0xpbmtFZGl0aW5nID8gdGhpcy5saXRlcmFscy5lZGl0TGluayA6IHRoaXMubGl0ZXJhbHMuaW5zZXJ0TGluaztcbiAgfVxuXG4gIGVtaXRDb21tYW5kKHZhbHVlKSB7XG4gICAgbGV0IGNvbW1hbmQ6IHN0cmluZztcbiAgICBpZiAodmFsdWUgJiYgdGhpcy5tb2RhbFR5cGUgPT09IFBvUmljaFRleHRNb2RhbFR5cGUuSW1hZ2UpIHtcbiAgICAgIGNvbW1hbmQgPSAnaW5zZXJ0SW1hZ2UnO1xuICAgICAgdGhpcy5jb21tYW5kLmVtaXQoeyBjb21tYW5kLCB2YWx1ZSB9KTtcbiAgICB9XG4gIH1cblxuICBmb3JtTW9kZWxWYWxpZGF0ZSgpIHtcbiAgICByZXR1cm4gKHRoaXMubW9kYWxMaW5rQ29uZmlybUFjdGlvbi5kaXNhYmxlZCA9IHRoaXMubW9kYWxMaW5rRm9ybSAmJiB0aGlzLm1vZGFsTGlua0Zvcm0uaW52YWxpZCk7XG4gIH1cblxuICBhc3luYyBpbnNlcnRFbGVtZW50UmVmKCkge1xuICAgIGxldCB1cGxvYWRJbWFnZTogc3RyaW5nO1xuXG4gICAgaWYgKHRoaXMubW9kYWxUeXBlID09PSBQb1JpY2hUZXh0TW9kYWxUeXBlLkltYWdlICYmICF0aGlzLnVybEltYWdlKSB7XG4gICAgICB1cGxvYWRJbWFnZSA9IGF3YWl0IHRoaXMuY29udmVydFRvQmFzZTY0KCk7XG4gICAgfVxuXG4gICAgdGhpcy5yZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCk7XG4gICAgdGhpcy5tb2RhbC5jbG9zZSgpO1xuXG4gICAgaWYgKHRoaXMuaXNVcmxWYWxpZCB8fCB0aGlzLmlzVXBsb2FkVmFsaWQpIHtcbiAgICAgIHRoaXMuZW1pdENvbW1hbmQodGhpcy51cmxJbWFnZSB8fCB1cGxvYWRJbWFnZSk7XG4gICAgfVxuICAgIHRoaXMuY2xlYW5VcEZpZWxkcygpO1xuICB9XG5cbiAgb3Blbk1vZGFsKHR5cGU6IFBvUmljaFRleHRNb2RhbFR5cGUpIHtcbiAgICB0aGlzLm1vZGFsVHlwZSA9IHR5cGU7XG5cbiAgICB0aGlzLnNhdmVDdXJzb3JQb3NpdGlvbigpO1xuXG4gICAgaWYgKHRoaXMubW9kYWxUeXBlID09PSBQb1JpY2hUZXh0TW9kYWxUeXBlLkxpbmspIHtcbiAgICAgIHRoaXMucHJlcGFyZU1vZGFsRm9yTGluaygpO1xuICAgICAgdGhpcy5tb2RhbExpbmtDb25maXJtQWN0aW9uLmxhYmVsID0gdGhpcy5saW5rQ29uZmlybUFjdGlvbigpO1xuICAgIH1cblxuICAgIHRoaXMubW9kYWwub3BlbigpO1xuICB9XG5cbiAgc2VsZWN0ZWRMaW5rKGV2ZW50KSB7XG4gICAgdGhpcy5pc1NlbGVjdGVkTGluayA9ICEhZXZlbnQ7XG4gICAgdGhpcy5saW5rRWxlbWVudCA9IGV2ZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBjaGVja0lmSXNFbXB0eSh1cmxMaW5rOiBzdHJpbmcsIHVybExpbmtUZXh0OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdXJsTGlua1RleHQgPT09IHVuZGVmaW5lZCB8fCB1cmxMaW5rVGV4dC50cmltKCkgPT09ICcnID8gdXJsTGluayA6IHVybExpbmtUZXh0O1xuICB9XG5cbiAgcHJpdmF0ZSBjbGVhblVwRmllbGRzKCkge1xuICAgIHRoaXMudXJsSW1hZ2UgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy51cmxMaW5rID0gdW5kZWZpbmVkO1xuICAgIHRoaXMudXJsTGlua1RleHQgPSB1bmRlZmluZWQ7XG4gICAgdGhpcy51cGxvYWRNb2RlbCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmlzTGlua0VkaXRpbmcgPSBmYWxzZTtcbiAgICB0aGlzLmlzU2VsZWN0ZWRMaW5rID0gZmFsc2U7XG4gICAgdGhpcy5saW5rRWxlbWVudCA9IHVuZGVmaW5lZDtcbiAgfVxuXG4gIHByaXZhdGUgZm9ybVJlc2V0KGNvbnRyb2w6IEFic3RyYWN0Q29udHJvbCkge1xuICAgIGNvbnRyb2wubWFya0FzUHJpc3RpbmUoKTtcbiAgICBjb250cm9sLm1hcmtBc1VudG91Y2hlZCgpO1xuICAgIGNvbnRyb2wudXBkYXRlVmFsdWVBbmRWYWxpZGl0eSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBwcmVwYXJlTW9kYWxGb3JMaW5rKCkge1xuICAgIHRoaXMuc2F2ZVNlbGVjdGlvblRleHQoKTtcbiAgICBpZiAodGhpcy5tb2RhbExpbmtGb3JtKSB7XG4gICAgICB0aGlzLmZvcm1SZXNldCh0aGlzLm1vZGFsTGlua0Zvcm0uY29udHJvbCk7XG4gICAgfVxuXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLmZvcm1Nb2RlbFZhbGlkYXRlKCk7XG4gICAgfSk7XG5cbiAgICBpZiAodGhpcy5pc1NlbGVjdGVkTGluaykge1xuICAgICAgdGhpcy5pc0xpbmtFZGl0aW5nID0gdHJ1ZTtcbiAgICAgIHRoaXMuc2V0TGlua0VkaXRhYmxlRm9yTW9kYWwoKTtcbiAgICB9XG5cbiAgICB0aGlzLmxpbmtFZGl0aW5nLmVtaXQodGhpcy5pc0xpbmtFZGl0aW5nKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVzdG9yZVNlbGVjdGlvbigpIHtcbiAgICBpZiAodGhpcy5zYXZlZFNlbGVjdGlvbikge1xuICAgICAgaWYgKHRoaXMuc2VsZWN0aW9uKSB7XG4gICAgICAgIHRoaXMuc2VsZWN0aW9uLnJlbW92ZUFsbFJhbmdlcygpO1xuICAgICAgICB0aGlzLnNlbGVjdGlvbi5hZGRSYW5nZSh0aGlzLnNhdmVkU2VsZWN0aW9uKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXRyaWV2ZUN1cnNvclBvc2l0aW9uKCkge1xuICAgIHRoaXMuc2VsZWN0aW9uLmNvbGxhcHNlKHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvblswXSwgdGhpcy5zYXZlZEN1cnNvclBvc2l0aW9uWzFdKTtcbiAgfVxuXG4gIHByaXZhdGUgc2F2ZUN1cnNvclBvc2l0aW9uKCkge1xuICAgIHRoaXMuc2F2ZWRDdXJzb3JQb3NpdGlvbiA9IFt0aGlzLnNlbGVjdGlvbi5mb2N1c05vZGUsIHRoaXMuc2VsZWN0aW9uLmZvY3VzT2Zmc2V0XTtcbiAgfVxuXG4gIHByaXZhdGUgc2F2ZVNlbGVjdGlvblRleHQoKSB7XG4gICAgaWYgKHRoaXMuc2VsZWN0aW9uLmFuY2hvck5vZGUgIT09IG51bGwpIHtcbiAgICAgIHRoaXMuc2F2ZWRTZWxlY3Rpb24gPSB0aGlzLnNlbGVjdGlvbi5nZXRSYW5nZUF0KDApO1xuICAgICAgdGhpcy51cmxMaW5rVGV4dCA9IHRoaXMuc2VsZWN0aW9uLnRvU3RyaW5nKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0TGlua0VkaXRhYmxlRm9yTW9kYWwoKSB7XG4gICAgdGhpcy51cmxMaW5rVGV4dCA9IHRoaXMubGlua0VsZW1lbnQuaW5uZXJUZXh0O1xuICAgIHRoaXMudXJsTGluayA9IHRoaXMubGlua0VsZW1lbnQuZ2V0QXR0cmlidXRlKCdocmVmJyk7XG4gIH1cblxuICBwcml2YXRlIHRvRWRpdExpbmsoKSB7XG4gICAgaWYgKGlzSUUoKSkge1xuICAgICAgdGhpcy5saW5rRWxlbWVudC5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHRoaXMubGlua0VsZW1lbnQpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmxpbmtFbGVtZW50LnJlbW92ZSgpO1xuICAgIH1cblxuICAgIHRoaXMudG9JbnNlcnRMaW5rKHRoaXMudXJsTGluaywgdGhpcy51cmxMaW5rVGV4dCk7XG4gIH1cblxuICBwcml2YXRlIHRvSW5zZXJ0TGluayh1cmxMaW5rLCB1cmxMaW5rVGV4dCkge1xuICAgIHRoaXMubW9kYWwuY2xvc2UoKTtcbiAgICB0aGlzLnJlc3RvcmVTZWxlY3Rpb24oKTtcblxuICAgIGNvbnN0IHVybExpbmtUZXh0VmFsdWUgPSB0aGlzLmNoZWNrSWZJc0VtcHR5KHVybExpbmssIHVybExpbmtUZXh0KTtcbiAgICBjb25zdCB1cmxBc0V4dGVybmFsTGluayA9IGlzRXh0ZXJuYWxMaW5rKHVybExpbmspID8gdXJsTGluayA6IGBodHRwOi8vJHt1cmxMaW5rfWA7XG5cbiAgICBjb25zdCBjb21tYW5kOiBzdHJpbmcgPSAnSW5zZXJ0SFRNTCc7XG5cbiAgICBjb25zdCB2YWx1ZSA9IHsgdXJsTGluazogdXJsQXNFeHRlcm5hbExpbmssIHVybExpbmtUZXh0OiB1cmxMaW5rVGV4dFZhbHVlIH07XG5cbiAgICB0aGlzLmNvbW1hbmQuZW1pdCh7IGNvbW1hbmQsIHZhbHVlIH0pO1xuXG4gICAgdGhpcy5jbGVhblVwRmllbGRzKCk7XG4gIH1cbn1cbiJdfQ==