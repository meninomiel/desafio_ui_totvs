import { __decorate, __extends, __metadata } from "tslib";
import { Component, ChangeDetectorRef, OnDestroy, OnInit, ViewChild } from '@angular/core';
import { NgForm } from '@angular/forms';
import { PoDynamicFormBaseComponent } from './po-dynamic-form-base.component';
import { PoDynamicFormLoadService } from './po-dynamic-form-load/po-dynamic-form-load.service';
import { PoDynamicFormValidationService } from './po-dynamic-form-validation/po-dynamic-form-validation.service';
/**
 * @docsExtends PoDynamicFormBaseComponent
 *
 * @example
 *
 * <example name="po-dynamic-form-basic" title="PO Dynamic Form Basic">
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.html"> </file>
 *  <file name="sample-po-dynamic-form-basic/sample-po-dynamic-form-basic.component.ts"> </file>
 * </example>
 *
 * <example name="po-dynamic-form-register" title="PO Dynamic Form - Register">
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.html"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.component.ts"> </file>
 *  <file name="sample-po-dynamic-form-register/sample-po-dynamic-form-register.service.ts"> </file>
 * </example>
 */
var PoDynamicFormComponent = /** @class */ (function (_super) {
    __extends(PoDynamicFormComponent, _super);
    function PoDynamicFormComponent(changes, loadService, validationService) {
        var _this = _super.call(this) || this;
        _this.changes = changes;
        _this.loadService = loadService;
        _this.validationService = validationService;
        return _this;
    }
    Object.defineProperty(PoDynamicFormComponent.prototype, "form", {
        get: function () {
            return this._form || {};
        },
        set: function (value) {
            var _this = this;
            // necessario para nao ocorrer o ExpressionChangedAfterItHasBeenCheckedError
            setTimeout(function () {
                _this._form = value;
                _this.emitForm();
            });
        },
        enumerable: true,
        configurable: true
    });
    PoDynamicFormComponent.prototype.ngOnDestroy = function () {
        this.removeListeners();
    };
    PoDynamicFormComponent.prototype.ngOnInit = function () {
        if (this.load) {
            this.loadDataOnInitialize();
        }
    };
    /**
     * Função que atribui foco ao campo desejado.
     *
     * Para utilizá-la é necessário capturar a instância do `dynamic form`, como por exemplo:
     *
     * ``` html
     * <po-dynamic-form #dynamicForm [p-fields]="fields"></po-dynamic-form>
     * ```
     *
     * ``` javascript
     * import { PoDynamicFormComponent, PoDynamicFormField } from '@po-ui/ng-components';
     *
     * ...
     *
     * @ViewChild('dynamicForm', { static: true }) dynamicForm: PoDynamicFormComponent;
     *
     * fields: Array<PoDynamicFormField> = [
     *   { property: 'fieldOne' },
     *   { property: 'fieldTwo' }
     * ];
     *
     * fieldFocus() {
     *   this.dynamicForm.focus('fieldTwo');
     * }
     * ```
     *
     * @param {string} property Nome da propriedade atribuída ao `PoDynamicFormField.property`.
     */
    PoDynamicFormComponent.prototype.focus = function (property) {
        this.fieldsComponent.focus(property);
    };
    PoDynamicFormComponent.prototype.validateForm = function (field) {
        var _this = this;
        var previousFocusElement = document.activeElement;
        this.disableForm(true);
        var errorOnValidation = function () { return _this.disableForm(false); };
        this.sendFormSubscription = this.validationService
            .sendFormChange(this.validate, field, this.value)
            .subscribe(this.applyFormValidation(previousFocusElement), errorOnValidation);
    };
    PoDynamicFormComponent.prototype.applyFormUpdatesOnLoad = function (previousFocusElement) {
        var _this = this;
        return function (dynamicFormData) {
            _this.updateModelOnLoad(dynamicFormData);
            _this.disableForm(false);
            _this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    };
    PoDynamicFormComponent.prototype.applyFormValidation = function (previousFocusElement) {
        var _this = this;
        return function (dynamicFormData) {
            _this.updateModelWithValidation(dynamicFormData);
            _this.disableForm(false);
            _this.setFocusOnFieldByProperty(dynamicFormData.focus, previousFocusElement);
        };
    };
    PoDynamicFormComponent.prototype.disableForm = function (value) {
        this.disabledForm = value;
        this.changes.detectChanges();
    };
    PoDynamicFormComponent.prototype.emitForm = function () {
        if (!this.groupForm && this.formOutput.observers.length) {
            this.formOutput.emit(this.form);
        }
    };
    PoDynamicFormComponent.prototype.loadDataOnInitialize = function () {
        var _this = this;
        var previousFocusElement = document.activeElement;
        this.disabledForm = true;
        var errorOnLoad = function () { return (_this.disabledForm = false); };
        this.onLoadSubscription = this.loadService
            .executeLoad(this.load, this.value)
            .subscribe(this.applyFormUpdatesOnLoad(previousFocusElement), errorOnLoad);
    };
    PoDynamicFormComponent.prototype.removeListeners = function () {
        if (this.onLoadSubscription) {
            this.onLoadSubscription.unsubscribe();
        }
        if (this.sendFormSubscription) {
            this.sendFormSubscription.unsubscribe();
        }
    };
    PoDynamicFormComponent.prototype.setFocusOnFieldByProperty = function (property, previousFocusElement) {
        var _this = this;
        if (property) {
            // precisa do timeout para que o valor seja atribuido no campo antes de setar o focus,
            // para nao disparar a mudança posteriormente. Situação ocorre quando retornar campo com valor e focus atribuido a ele.
            setTimeout(function () { return _this.focus(property); });
        }
        else {
            previousFocusElement['focus']();
        }
    };
    PoDynamicFormComponent.prototype.updateModelOnLoad = function (loadedFormData) {
        Object.assign(this.value, loadedFormData.value);
        this.fields = this.loadService.createAndUpdateFieldsForm(loadedFormData.fields, this.fields);
    };
    PoDynamicFormComponent.prototype.updateModelWithValidation = function (formData) {
        Object.assign(this.value, formData.value);
        this.fields = this.validationService.updateFieldsForm(formData.fields, this.fields);
    };
    PoDynamicFormComponent.ctorParameters = function () { return [
        { type: ChangeDetectorRef },
        { type: PoDynamicFormLoadService },
        { type: PoDynamicFormValidationService }
    ]; };
    __decorate([
        ViewChild('dynamicForm'),
        __metadata("design:type", NgForm),
        __metadata("design:paramtypes", [NgForm])
    ], PoDynamicFormComponent.prototype, "form", null);
    __decorate([
        ViewChild('fieldsComponent'),
        __metadata("design:type", Object)
    ], PoDynamicFormComponent.prototype, "fieldsComponent", void 0);
    PoDynamicFormComponent = __decorate([
        Component({
            selector: 'po-dynamic-form',
            template: "<ng-container *ngIf=\"groupForm; then reuseFormTemplate; else uniqueFormTemplate\"></ng-container>\n\n<ng-template #reuseFormTemplate>\n  <po-dynamic-form-fields #fieldsComponent [p-auto-focus]=\"autoFocus\" [p-fields]=\"fields\" [p-value]=\"value\">\n  </po-dynamic-form-fields>\n</ng-template>\n\n<ng-template #uniqueFormTemplate>\n  <form #dynamicForm=\"ngForm\">\n    <po-dynamic-form-fields\n      #fieldsComponent\n      [(p-fields)]=\"fields\"\n      [p-auto-focus]=\"autoFocus\"\n      [p-disabled-form]=\"disabledForm\"\n      [p-validate]=\"validate\"\n      [p-value]=\"value\"\n      (p-form-validate)=\"validateForm($event)\"\n    >\n    </po-dynamic-form-fields>\n  </form>\n</ng-template>\n"
        }),
        __metadata("design:paramtypes", [ChangeDetectorRef,
            PoDynamicFormLoadService,
            PoDynamicFormValidationService])
    ], PoDynamicFormComponent);
    return PoDynamicFormComponent;
}(PoDynamicFormBaseComponent));
export { PoDynamicFormComponent };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC5qcyIsInNvdXJjZVJvb3QiOiJuZzovL0Bwby11aS9uZy1jb21wb25lbnRzLyIsInNvdXJjZXMiOlsibGliL2NvbXBvbmVudHMvcG8tZHluYW1pYy9wby1keW5hbWljLWZvcm0vcG8tZHluYW1pYy1mb3JtLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsT0FBTyxFQUFFLFNBQVMsRUFBRSxpQkFBaUIsRUFBRSxTQUFTLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRixPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFJeEMsT0FBTyxFQUFFLDBCQUEwQixFQUFFLE1BQU0sa0NBQWtDLENBQUM7QUFHOUUsT0FBTyxFQUFFLHdCQUF3QixFQUFFLE1BQU0scURBQXFELENBQUM7QUFFL0YsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0saUVBQWlFLENBQUM7QUFFakg7Ozs7Ozs7Ozs7Ozs7OztHQWVHO0FBTUg7SUFBNEMsMENBQTBCO0lBdUJwRSxnQ0FDVSxPQUEwQixFQUMxQixXQUFxQyxFQUNyQyxpQkFBaUQ7UUFIM0QsWUFLRSxpQkFBTyxTQUNSO1FBTFMsYUFBTyxHQUFQLE9BQU8sQ0FBbUI7UUFDMUIsaUJBQVcsR0FBWCxXQUFXLENBQTBCO1FBQ3JDLHVCQUFpQixHQUFqQixpQkFBaUIsQ0FBZ0M7O0lBRzNELENBQUM7SUFyQnlCLHNCQUFJLHdDQUFJO2FBU2xDO1lBQ0UsT0FBTyxJQUFJLENBQUMsS0FBSyxJQUFTLEVBQUUsQ0FBQztRQUMvQixDQUFDO2FBWHlCLFVBQVMsS0FBYTtZQUFoRCxpQkFPQztZQU5DLDRFQUE0RTtZQUM1RSxVQUFVLENBQUM7Z0JBQ1QsS0FBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7Z0JBRW5CLEtBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNsQixDQUFDLENBQUMsQ0FBQztRQUNMLENBQUM7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d0I7Z0JBQ2xCLDhCQUE4Qjs7SUFsQmpDO1FBQXpCLFNBQVMsQ0FBQyxhQUFhLENBQUM7a0NBQWlCLE1BQU07eUNBQU4sTUFBTTtzREFPL0M7SUFNNkI7UUFBN0IsU0FBUyxDQUFDLGlCQUFpQixDQUFDOzttRUFBd0Q7SUFyQjFFLHNCQUFzQjtRQUpsQyxTQUFTLENBQUM7WUFDVCxRQUFRLEVBQUUsaUJBQWlCO1lBQzNCLDZzQkFBK0M7U0FDaEQsQ0FBQzt5Q0F5Qm1CLGlCQUFpQjtZQUNiLHdCQUF3QjtZQUNsQiw4QkFBOEI7T0ExQmhELHNCQUFzQixDQXVKbEM7SUFBRCw2QkFBQztDQUFBLEFBdkpELENBQTRDLDBCQUEwQixHQXVKckU7U0F2Slksc0JBQXNCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBDaGFuZ2VEZXRlY3RvclJlZiwgT25EZXN0cm95LCBPbkluaXQsIFZpZXdDaGlsZCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgTmdGb3JtIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuXG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tICdyeGpzJztcblxuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUJhc2VDb21wb25lbnQgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1iYXNlLmNvbXBvbmVudCc7XG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtRmllbGQgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1maWVsZC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9EeW5hbWljRm9ybUxvYWQgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1sb2FkL3BvLWR5bmFtaWMtZm9ybS1sb2FkLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtTG9hZFNlcnZpY2UgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS1sb2FkL3BvLWR5bmFtaWMtZm9ybS1sb2FkLnNlcnZpY2UnO1xuaW1wb3J0IHsgUG9EeW5hbWljRm9ybVZhbGlkYXRpb24gfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uLmludGVyZmFjZSc7XG5pbXBvcnQgeyBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvblNlcnZpY2UgfSBmcm9tICcuL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uL3BvLWR5bmFtaWMtZm9ybS12YWxpZGF0aW9uLnNlcnZpY2UnO1xuXG4vKipcbiAqIEBkb2NzRXh0ZW5kcyBQb0R5bmFtaWNGb3JtQmFzZUNvbXBvbmVudFxuICpcbiAqIEBleGFtcGxlXG4gKlxuICogPGV4YW1wbGUgbmFtZT1cInBvLWR5bmFtaWMtZm9ybS1iYXNpY1wiIHRpdGxlPVwiUE8gRHluYW1pYyBGb3JtIEJhc2ljXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tYmFzaWMvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tYmFzaWMvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1iYXNpYy5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogPC9leGFtcGxlPlxuICpcbiAqIDxleGFtcGxlIG5hbWU9XCJwby1keW5hbWljLWZvcm0tcmVnaXN0ZXJcIiB0aXRsZT1cIlBPIER5bmFtaWMgRm9ybSAtIFJlZ2lzdGVyXCI+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci5jb21wb25lbnQuaHRtbFwiPiA8L2ZpbGU+XG4gKiAgPGZpbGUgbmFtZT1cInNhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIvc2FtcGxlLXBvLWR5bmFtaWMtZm9ybS1yZWdpc3Rlci5jb21wb25lbnQudHNcIj4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9XCJzYW1wbGUtcG8tZHluYW1pYy1mb3JtLXJlZ2lzdGVyL3NhbXBsZS1wby1keW5hbWljLWZvcm0tcmVnaXN0ZXIuc2VydmljZS50c1wiPiA8L2ZpbGU+XG4gKiA8L2V4YW1wbGU+XG4gKi9cblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAncG8tZHluYW1pYy1mb3JtJyxcbiAgdGVtcGxhdGVVcmw6ICcuL3BvLWR5bmFtaWMtZm9ybS5jb21wb25lbnQuaHRtbCdcbn0pXG5leHBvcnQgY2xhc3MgUG9EeW5hbWljRm9ybUNvbXBvbmVudCBleHRlbmRzIFBvRHluYW1pY0Zvcm1CYXNlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBwcml2YXRlIF9mb3JtOiBOZ0Zvcm07XG5cbiAgZGlzYWJsZWRGb3JtOiBib29sZWFuO1xuXG4gIHByaXZhdGUgb25Mb2FkU3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gIHByaXZhdGUgc2VuZEZvcm1TdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcblxuICBAVmlld0NoaWxkKCdkeW5hbWljRm9ybScpIHNldCBmb3JtKHZhbHVlOiBOZ0Zvcm0pIHtcbiAgICAvLyBuZWNlc3NhcmlvIHBhcmEgbmFvIG9jb3JyZXIgbyBFeHByZXNzaW9uQ2hhbmdlZEFmdGVySXRIYXNCZWVuQ2hlY2tlZEVycm9yXG4gICAgc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICB0aGlzLl9mb3JtID0gdmFsdWU7XG5cbiAgICAgIHRoaXMuZW1pdEZvcm0oKTtcbiAgICB9KTtcbiAgfVxuXG4gIGdldCBmb3JtKCkge1xuICAgIHJldHVybiB0aGlzLl9mb3JtIHx8IDxhbnk+e307XG4gIH1cblxuICBAVmlld0NoaWxkKCdmaWVsZHNDb21wb25lbnQnKSBmaWVsZHNDb21wb25lbnQ6IHsgZm9jdXM6IChwcm9wZXJ0eTogc3RyaW5nKSA9PiB2b2lkIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjaGFuZ2VzOiBDaGFuZ2VEZXRlY3RvclJlZixcbiAgICBwcml2YXRlIGxvYWRTZXJ2aWNlOiBQb0R5bmFtaWNGb3JtTG9hZFNlcnZpY2UsXG4gICAgcHJpdmF0ZSB2YWxpZGF0aW9uU2VydmljZTogUG9EeW5hbWljRm9ybVZhbGlkYXRpb25TZXJ2aWNlXG4gICkge1xuICAgIHN1cGVyKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpIHtcbiAgICB0aGlzLnJlbW92ZUxpc3RlbmVycygpO1xuICB9XG5cbiAgbmdPbkluaXQoKSB7XG4gICAgaWYgKHRoaXMubG9hZCkge1xuICAgICAgdGhpcy5sb2FkRGF0YU9uSW5pdGlhbGl6ZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGdW7Dp8OjbyBxdWUgYXRyaWJ1aSBmb2NvIGFvIGNhbXBvIGRlc2VqYWRvLlxuICAgKlxuICAgKiBQYXJhIHV0aWxpesOhLWxhIMOpIG5lY2Vzc8OhcmlvIGNhcHR1cmFyIGEgaW5zdMOibmNpYSBkbyBgZHluYW1pYyBmb3JtYCwgY29tbyBwb3IgZXhlbXBsbzpcbiAgICpcbiAgICogYGBgIGh0bWxcbiAgICogPHBvLWR5bmFtaWMtZm9ybSAjZHluYW1pY0Zvcm0gW3AtZmllbGRzXT1cImZpZWxkc1wiPjwvcG8tZHluYW1pYy1mb3JtPlxuICAgKiBgYGBcbiAgICpcbiAgICogYGBgIGphdmFzY3JpcHRcbiAgICogaW1wb3J0IHsgUG9EeW5hbWljRm9ybUNvbXBvbmVudCwgUG9EeW5hbWljRm9ybUZpZWxkIH0gZnJvbSAnQHBvLXVpL25nLWNvbXBvbmVudHMnO1xuICAgKlxuICAgKiAuLi5cbiAgICpcbiAgICogQFZpZXdDaGlsZCgnZHluYW1pY0Zvcm0nLCB7IHN0YXRpYzogdHJ1ZSB9KSBkeW5hbWljRm9ybTogUG9EeW5hbWljRm9ybUNvbXBvbmVudDtcbiAgICpcbiAgICogZmllbGRzOiBBcnJheTxQb0R5bmFtaWNGb3JtRmllbGQ+ID0gW1xuICAgKiAgIHsgcHJvcGVydHk6ICdmaWVsZE9uZScgfSxcbiAgICogICB7IHByb3BlcnR5OiAnZmllbGRUd28nIH1cbiAgICogXTtcbiAgICpcbiAgICogZmllbGRGb2N1cygpIHtcbiAgICogICB0aGlzLmR5bmFtaWNGb3JtLmZvY3VzKCdmaWVsZFR3bycpO1xuICAgKiB9XG4gICAqIGBgYFxuICAgKlxuICAgKiBAcGFyYW0ge3N0cmluZ30gcHJvcGVydHkgTm9tZSBkYSBwcm9wcmllZGFkZSBhdHJpYnXDrWRhIGFvIGBQb0R5bmFtaWNGb3JtRmllbGQucHJvcGVydHlgLlxuICAgKi9cbiAgZm9jdXMocHJvcGVydHk6IHN0cmluZykge1xuICAgIHRoaXMuZmllbGRzQ29tcG9uZW50LmZvY3VzKHByb3BlcnR5KTtcbiAgfVxuXG4gIHZhbGlkYXRlRm9ybShmaWVsZDogUG9EeW5hbWljRm9ybUZpZWxkKSB7XG4gICAgY29uc3QgcHJldmlvdXNGb2N1c0VsZW1lbnQgPSBkb2N1bWVudC5hY3RpdmVFbGVtZW50O1xuXG4gICAgdGhpcy5kaXNhYmxlRm9ybSh0cnVlKTtcbiAgICBjb25zdCBlcnJvck9uVmFsaWRhdGlvbiA9ICgpID0+IHRoaXMuZGlzYWJsZUZvcm0oZmFsc2UpO1xuXG4gICAgdGhpcy5zZW5kRm9ybVN1YnNjcmlwdGlvbiA9IHRoaXMudmFsaWRhdGlvblNlcnZpY2VcbiAgICAgIC5zZW5kRm9ybUNoYW5nZSh0aGlzLnZhbGlkYXRlLCBmaWVsZCwgdGhpcy52YWx1ZSlcbiAgICAgIC5zdWJzY3JpYmUodGhpcy5hcHBseUZvcm1WYWxpZGF0aW9uKHByZXZpb3VzRm9jdXNFbGVtZW50KSwgZXJyb3JPblZhbGlkYXRpb24pO1xuICB9XG5cbiAgcHJpdmF0ZSBhcHBseUZvcm1VcGRhdGVzT25Mb2FkKHByZXZpb3VzRm9jdXNFbGVtZW50OiBFbGVtZW50KTogKGR5bmFtaWNGb3JtRGF0YTogUG9EeW5hbWljRm9ybUxvYWQpID0+IHZvaWQge1xuICAgIHJldHVybiBkeW5hbWljRm9ybURhdGEgPT4ge1xuICAgICAgdGhpcy51cGRhdGVNb2RlbE9uTG9hZChkeW5hbWljRm9ybURhdGEpO1xuICAgICAgdGhpcy5kaXNhYmxlRm9ybShmYWxzZSk7XG4gICAgICB0aGlzLnNldEZvY3VzT25GaWVsZEJ5UHJvcGVydHkoZHluYW1pY0Zvcm1EYXRhLmZvY3VzLCBwcmV2aW91c0ZvY3VzRWxlbWVudCk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlGb3JtVmFsaWRhdGlvbihwcmV2aW91c0ZvY3VzRWxlbWVudDogRWxlbWVudCk6IChkeW5hbWljRm9ybURhdGE6IFBvRHluYW1pY0Zvcm1WYWxpZGF0aW9uKSA9PiB2b2lkIHtcbiAgICByZXR1cm4gZHluYW1pY0Zvcm1EYXRhID0+IHtcbiAgICAgIHRoaXMudXBkYXRlTW9kZWxXaXRoVmFsaWRhdGlvbihkeW5hbWljRm9ybURhdGEpO1xuICAgICAgdGhpcy5kaXNhYmxlRm9ybShmYWxzZSk7XG4gICAgICB0aGlzLnNldEZvY3VzT25GaWVsZEJ5UHJvcGVydHkoZHluYW1pY0Zvcm1EYXRhLmZvY3VzLCBwcmV2aW91c0ZvY3VzRWxlbWVudCk7XG4gICAgfTtcbiAgfVxuXG4gIHByaXZhdGUgZGlzYWJsZUZvcm0odmFsdWU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmRpc2FibGVkRm9ybSA9IHZhbHVlO1xuICAgIHRoaXMuY2hhbmdlcy5kZXRlY3RDaGFuZ2VzKCk7XG4gIH1cblxuICBwcml2YXRlIGVtaXRGb3JtKCkge1xuICAgIGlmICghdGhpcy5ncm91cEZvcm0gJiYgdGhpcy5mb3JtT3V0cHV0Lm9ic2VydmVycy5sZW5ndGgpIHtcbiAgICAgIHRoaXMuZm9ybU91dHB1dC5lbWl0KHRoaXMuZm9ybSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBsb2FkRGF0YU9uSW5pdGlhbGl6ZSgpIHtcbiAgICBjb25zdCBwcmV2aW91c0ZvY3VzRWxlbWVudCA9IGRvY3VtZW50LmFjdGl2ZUVsZW1lbnQ7XG5cbiAgICB0aGlzLmRpc2FibGVkRm9ybSA9IHRydWU7XG4gICAgY29uc3QgZXJyb3JPbkxvYWQgPSAoKSA9PiAodGhpcy5kaXNhYmxlZEZvcm0gPSBmYWxzZSk7XG5cbiAgICB0aGlzLm9uTG9hZFN1YnNjcmlwdGlvbiA9IHRoaXMubG9hZFNlcnZpY2VcbiAgICAgIC5leGVjdXRlTG9hZCh0aGlzLmxvYWQsIHRoaXMudmFsdWUpXG4gICAgICAuc3Vic2NyaWJlKHRoaXMuYXBwbHlGb3JtVXBkYXRlc09uTG9hZChwcmV2aW91c0ZvY3VzRWxlbWVudCksIGVycm9yT25Mb2FkKTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlTGlzdGVuZXJzKCkge1xuICAgIGlmICh0aGlzLm9uTG9hZFN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5vbkxvYWRTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5zZW5kRm9ybVN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zZW5kRm9ybVN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgc2V0Rm9jdXNPbkZpZWxkQnlQcm9wZXJ0eShwcm9wZXJ0eTogc3RyaW5nLCBwcmV2aW91c0ZvY3VzRWxlbWVudDogRWxlbWVudCkge1xuICAgIGlmIChwcm9wZXJ0eSkge1xuICAgICAgLy8gcHJlY2lzYSBkbyB0aW1lb3V0IHBhcmEgcXVlIG8gdmFsb3Igc2VqYSBhdHJpYnVpZG8gbm8gY2FtcG8gYW50ZXMgZGUgc2V0YXIgbyBmb2N1cyxcbiAgICAgIC8vIHBhcmEgbmFvIGRpc3BhcmFyIGEgbXVkYW7Dp2EgcG9zdGVyaW9ybWVudGUuIFNpdHVhw6fDo28gb2NvcnJlIHF1YW5kbyByZXRvcm5hciBjYW1wbyBjb20gdmFsb3IgZSBmb2N1cyBhdHJpYnVpZG8gYSBlbGUuXG4gICAgICBzZXRUaW1lb3V0KCgpID0+IHRoaXMuZm9jdXMocHJvcGVydHkpKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcHJldmlvdXNGb2N1c0VsZW1lbnRbJ2ZvY3VzJ10oKTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIHVwZGF0ZU1vZGVsT25Mb2FkKGxvYWRlZEZvcm1EYXRhOiBQb0R5bmFtaWNGb3JtTG9hZCkge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcy52YWx1ZSwgbG9hZGVkRm9ybURhdGEudmFsdWUpO1xuICAgIHRoaXMuZmllbGRzID0gdGhpcy5sb2FkU2VydmljZS5jcmVhdGVBbmRVcGRhdGVGaWVsZHNGb3JtKGxvYWRlZEZvcm1EYXRhLmZpZWxkcywgdGhpcy5maWVsZHMpO1xuICB9XG5cbiAgcHJpdmF0ZSB1cGRhdGVNb2RlbFdpdGhWYWxpZGF0aW9uKGZvcm1EYXRhOiBQb0R5bmFtaWNGb3JtVmFsaWRhdGlvbikge1xuICAgIE9iamVjdC5hc3NpZ24odGhpcy52YWx1ZSwgZm9ybURhdGEudmFsdWUpO1xuICAgIHRoaXMuZmllbGRzID0gdGhpcy52YWxpZGF0aW9uU2VydmljZS51cGRhdGVGaWVsZHNGb3JtKGZvcm1EYXRhLmZpZWxkcywgdGhpcy5maWVsZHMpO1xuICB9XG59XG4iXX0=