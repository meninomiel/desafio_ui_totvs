import { __decorate, __metadata } from "tslib";
import { Injectable } from '@angular/core';
import { HttpResponse } from '@angular/common/http';
import { throwError } from 'rxjs';
import { catchError, tap } from 'rxjs/operators';
import { PoComponentInjectorService } from '../../services/po-component-injector/po-component-injector.service';
import { PoLoadingOverlayComponent } from '../../components/po-loading/po-loading-overlay/po-loading-overlay.component';
import { PoHttpRequesControltService } from './po-http-request-control-service';
import * as i0 from "@angular/core";
import * as i1 from "./po-http-request-control-service";
import * as i2 from "../../services/po-component-injector/po-component-injector.service";
var noCountPendingRequests = 'X-PO-No-Count-Pending-Requests';
var screenLock = 'X-PO-Screen-Lock';
/**
 * @description
 *
 * O serviço PO Http Request Interceptor realiza a contabilização de requisições pendentes na aplicação.
 *
 * Existe a possibilidade de não efetuar a contabilização das requisições pendentes, utilizando o parâmetro
 * `X-PO-No-Count-Pending-Requests`. Para isso deve ser informado no cabeçalho da requisição com o valor `'true'`,
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Count-Pending-Requests': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * Para obter a quantidade de requisições pendentes, deve inscrever-se no método `getCountPendingRequests` do
 * serviço `PoHttpRequestInterceptorService`, com isso, ao realizar requisições utilizando `HttpClient`,
 * será retornado a quantidade de requisições pendentes.
 *
 * Também existe a possibildade de travar a tela e mostrar uma imagem de _loading_ durante o processamento de uma requisição
 * deve-se passar o parâmetro `X-PO-Screen-Lock` no cabeçalho da requisição com valor `'true'`.
 *
 * por exemplo:
 *
 * ```
 * ...
 *  const headers = { 'X-PO-Screen-Lock': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 * > Após a validação no interceptor, o parâmetro será removido do cabeçalho da requisição.
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-request-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 *
 * Segue abaixo um exemplo de uso:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class CustomersService {
 *
 *  headers = { 'X-PO-No-Count-Pending-Requests': true, 'X-PO-Screen-Lock': 'true' }
 *  pendingRequests: number = 0;
 *  subscription: Subscription;
 *
 *  constructor(
 *    private http: HttpClient,
 *    private httpRequestInterceptor: PoHttpRequestInterceptorService) { }
 *
 *  ngOnDestroy(): void {
 *    this.subscription.unsubscribe();
 *  }
 *
 *  ngOnInit(): void {
 *    this.subscription = this.httpRequestInterceptor.getCountPendingRequests().subscribe(data => {
 *      this.pendingRequests = data;
 *    });
 *  }
 *
 *  getCustomers() {
 *    return this.http.get(`/customers/1`, { headers: headers });
 *  }
 *
 *  ...
 *
 * }
 * ```
 *
 * @example
 * <example name='po-http-request-interceptor-labs' title='PO Http Request Interceptor Labs'>
 *  <file name='sample-po-http-request-interceptor-labs.component.ts'> </file>
 *  <file name='sample-po-http-request-interceptor-labs.component.html'> </file>
 * </example>
 */
var PoHttpRequestInterceptorService = /** @class */ (function () {
    function PoHttpRequestInterceptorService(controlHttpRequest, poComponentInjector) {
        this.controlHttpRequest = controlHttpRequest;
        this.poComponentInjector = poComponentInjector;
        this.loadingOverlayComponent = undefined;
        this.pendingRequests = 0;
        this.overlayRequests = 0;
    }
    PoHttpRequestInterceptorService.prototype.intercept = function (request, next) {
        var _this = this;
        var requestClone = request.clone();
        request = this.requestCloneWithoutHeaderParam([noCountPendingRequests, screenLock], request);
        this.setCountPendingRequests(true, requestClone);
        this.setCountOverlayRequests(true, requestClone);
        return next.handle(request).pipe(tap(function (response) {
            if (response instanceof HttpResponse) {
                _this.setCountPendingRequests(false, requestClone);
                _this.setCountOverlayRequests(false, requestClone);
            }
        }), catchError(function (error) {
            _this.setCountPendingRequests(false, requestClone);
            _this.setCountOverlayRequests(false, requestClone);
            return throwError(error);
        }));
    };
    PoHttpRequestInterceptorService.prototype.getCountPendingRequests = function () {
        return this.controlHttpRequest.getControlHttpRequest();
    };
    PoHttpRequestInterceptorService.prototype.buildLoading = function () {
        if (!this.loadingOverlayComponent) {
            this.loadingOverlayComponent = this.poComponentInjector.createComponentInApplication(PoLoadingOverlayComponent);
            this.loadingOverlayComponent.instance.screenLock = true;
            this.loadingOverlayComponent.instance.changeDetector.detectChanges();
        }
    };
    PoHttpRequestInterceptorService.prototype.destroyLoading = function () {
        if (this.loadingOverlayComponent) {
            this.poComponentInjector.destroyComponentInApplication(this.loadingOverlayComponent);
            this.loadingOverlayComponent = undefined;
        }
    };
    PoHttpRequestInterceptorService.prototype.requestCloneWithoutHeaderParam = function (headersParams, request) {
        var isRequestClone = false;
        headersParams.forEach(function (headerParam) {
            if (request.headers.has(headerParam)) {
                request.headers.delete(headerParam);
                isRequestClone = true;
            }
        });
        return isRequestClone ? request.clone({ headers: request.headers }) : request;
    };
    PoHttpRequestInterceptorService.prototype.setCountPendingRequests = function (isIncrement, request) {
        var hasCountPendingRequestHeaderParam = request.headers.has(noCountPendingRequests);
        var headerParam = request.headers.get(noCountPendingRequests);
        if (hasCountPendingRequestHeaderParam && headerParam.toString().toLowerCase() === 'true') {
            return;
        }
        this.pendingRequests += isIncrement ? 1 : -1;
        this.controlHttpRequest.send(this.pendingRequests);
    };
    PoHttpRequestInterceptorService.prototype.setCountOverlayRequests = function (isIncrement, request) {
        var hasOverlayRequestHeaderParam = request.headers.has(screenLock);
        if (hasOverlayRequestHeaderParam) {
            var headerParam = request.headers.get(screenLock);
            if (headerParam.toString().toLowerCase() === 'false') {
                return;
            }
            this.overlayRequests += isIncrement ? 1 : -1;
            this.overlayRequests > 0 ? this.buildLoading() : this.destroyLoading();
        }
    };
    PoHttpRequestInterceptorService.ctorParameters = function () { return [
        { type: PoHttpRequesControltService },
        { type: PoComponentInjectorService }
    ]; };
    PoHttpRequestInterceptorService.ɵprov = i0.ɵɵdefineInjectable({ factory: function PoHttpRequestInterceptorService_Factory() { return new PoHttpRequestInterceptorService(i0.ɵɵinject(i1.PoHttpRequesControltService), i0.ɵɵinject(i2.PoComponentInjectorService)); }, token: PoHttpRequestInterceptorService, providedIn: "root" });
    PoHttpRequestInterceptorService = __decorate([
        Injectable({
            providedIn: 'root'
        }),
        __metadata("design:paramtypes", [PoHttpRequesControltService,
            PoComponentInjectorService])
    ], PoHttpRequestInterceptorService);
    return PoHttpRequestInterceptorService;
}());
export { PoHttpRequestInterceptorService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1yZXF1ZXN0L3BvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvci5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxPQUFPLEVBQWdCLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUN6RCxPQUFPLEVBQXdELFlBQVksRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBRTFHLE9BQU8sRUFBYyxVQUFVLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDOUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVqRCxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSxvRUFBb0UsQ0FBQztBQUNoSCxPQUFPLEVBQUUseUJBQXlCLEVBQUUsTUFBTSw2RUFBNkUsQ0FBQztBQUV4SCxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQzs7OztBQUVoRixJQUFNLHNCQUFzQixHQUFHLGdDQUFnQyxDQUFDO0FBQ2hFLElBQU0sVUFBVSxHQUFHLGtCQUFrQixDQUFDO0FBRXRDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBa0ZHO0FBSUg7SUFNRSx5Q0FDVSxrQkFBK0MsRUFDL0MsbUJBQStDO1FBRC9DLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBNkI7UUFDL0Msd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE0QjtRQVBqRCw0QkFBdUIsR0FBNEMsU0FBUyxDQUFDO1FBRTdFLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO1FBQzVCLG9CQUFlLEdBQVcsQ0FBQyxDQUFDO0lBS2pDLENBQUM7SUFFSixtREFBUyxHQUFULFVBQVUsT0FBeUIsRUFBRSxJQUFpQjtRQUF0RCxpQkFzQkM7UUFyQkMsSUFBTSxZQUFZLEdBQUcsT0FBTyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRXJDLE9BQU8sR0FBRyxJQUFJLENBQUMsOEJBQThCLENBQUMsQ0FBQyxzQkFBc0IsRUFBRSxVQUFVLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUU3RixJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ2pELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFFakQsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksQ0FDOUIsR0FBRyxDQUFDLFVBQUMsUUFBd0I7WUFDM0IsSUFBSSxRQUFRLFlBQVksWUFBWSxFQUFFO2dCQUNwQyxLQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO2dCQUNsRCxLQUFJLENBQUMsdUJBQXVCLENBQUMsS0FBSyxFQUFFLFlBQVksQ0FBQyxDQUFDO2FBQ25EO1FBQ0gsQ0FBQyxDQUFDLEVBQ0YsVUFBVSxDQUFDLFVBQUEsS0FBSztZQUNkLEtBQUksQ0FBQyx1QkFBdUIsQ0FBQyxLQUFLLEVBQUUsWUFBWSxDQUFDLENBQUM7WUFDbEQsS0FBSSxDQUFDLHVCQUF1QixDQUFDLEtBQUssRUFBRSxZQUFZLENBQUMsQ0FBQztZQUVsRCxPQUFPLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMzQixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVELGlFQUF1QixHQUF2QjtRQUNFLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDekQsQ0FBQztJQUVPLHNEQUFZLEdBQXBCO1FBQ0UsSUFBSSxDQUFDLElBQUksQ0FBQyx1QkFBdUIsRUFBRTtZQUNqQyxJQUFJLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLDRCQUE0QixDQUFDLHlCQUF5QixDQUFDLENBQUM7WUFDaEgsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFFBQVEsQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDO1lBQ3hELElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLGFBQWEsRUFBRSxDQUFDO1NBQ3RFO0lBQ0gsQ0FBQztJQUVPLHdEQUFjLEdBQXRCO1FBQ0UsSUFBSSxJQUFJLENBQUMsdUJBQXVCLEVBQUU7WUFDaEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLDZCQUE2QixDQUFDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxDQUFDO1lBQ3JGLElBQUksQ0FBQyx1QkFBdUIsR0FBRyxTQUFTLENBQUM7U0FDMUM7SUFDSCxDQUFDO0lBRU8sd0VBQThCLEdBQXRDLFVBQXVDLGFBQTRCLEVBQUUsT0FBeUI7UUFDNUYsSUFBSSxjQUFjLEdBQUcsS0FBSyxDQUFDO1FBRTNCLGFBQWEsQ0FBQyxPQUFPLENBQUMsVUFBQSxXQUFXO1lBQy9CLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUU7Z0JBQ3BDLE9BQU8sQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsQ0FBQyxDQUFDO2dCQUNwQyxjQUFjLEdBQUcsSUFBSSxDQUFDO2FBQ3ZCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFFSCxPQUFPLGNBQWMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxFQUFFLE9BQU8sRUFBRSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDO0lBQ2hGLENBQUM7SUFFTyxpRUFBdUIsR0FBL0IsVUFBZ0MsV0FBb0IsRUFBRSxPQUF5QjtRQUM3RSxJQUFNLGlDQUFpQyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLHNCQUFzQixDQUFDLENBQUM7UUFDdEYsSUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLENBQUMsQ0FBQztRQUVoRSxJQUFJLGlDQUFpQyxJQUFJLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxNQUFNLEVBQUU7WUFDeEYsT0FBTztTQUNSO1FBRUQsSUFBSSxDQUFDLGVBQWUsSUFBSSxXQUFXLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDN0MsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVPLGlFQUF1QixHQUEvQixVQUFnQyxXQUFvQixFQUFFLE9BQXlCO1FBQzdFLElBQU0sNEJBQTRCLEdBQUcsT0FBTyxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFckUsSUFBSSw0QkFBNEIsRUFBRTtZQUNoQyxJQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUVwRCxJQUFJLFdBQVcsQ0FBQyxRQUFRLEVBQUUsQ0FBQyxXQUFXLEVBQUUsS0FBSyxPQUFPLEVBQUU7Z0JBQ3BELE9BQU87YUFDUjtZQUVELElBQUksQ0FBQyxlQUFlLElBQUksV0FBVyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxlQUFlLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztTQUN4RTtJQUNILENBQUM7O2dCQXJGNkIsMkJBQTJCO2dCQUMxQiwwQkFBMEI7OztJQVI5QywrQkFBK0I7UUFIM0MsVUFBVSxDQUFDO1lBQ1YsVUFBVSxFQUFFLE1BQU07U0FDbkIsQ0FBQzt5Q0FROEIsMkJBQTJCO1lBQzFCLDBCQUEwQjtPQVI5QywrQkFBK0IsQ0E2RjNDOzBDQWpNRDtDQWlNQyxBQTdGRCxJQTZGQztTQTdGWSwrQkFBK0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYsIEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEh0dHBFdmVudCwgSHR0cEhhbmRsZXIsIEh0dHBJbnRlcmNlcHRvciwgSHR0cFJlcXVlc3QsIEh0dHBSZXNwb25zZSB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcblxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5pbXBvcnQgeyBQb0NvbXBvbmVudEluamVjdG9yU2VydmljZSB9IGZyb20gJy4uLy4uL3NlcnZpY2VzL3BvLWNvbXBvbmVudC1pbmplY3Rvci9wby1jb21wb25lbnQtaW5qZWN0b3Iuc2VydmljZSc7XG5pbXBvcnQgeyBQb0xvYWRpbmdPdmVybGF5Q29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY29tcG9uZW50cy9wby1sb2FkaW5nL3BvLWxvYWRpbmctb3ZlcmxheS9wby1sb2FkaW5nLW92ZXJsYXkuY29tcG9uZW50JztcblxuaW1wb3J0IHsgUG9IdHRwUmVxdWVzQ29udHJvbHRTZXJ2aWNlIH0gZnJvbSAnLi9wby1odHRwLXJlcXVlc3QtY29udHJvbC1zZXJ2aWNlJztcblxuY29uc3Qgbm9Db3VudFBlbmRpbmdSZXF1ZXN0cyA9ICdYLVBPLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnO1xuY29uc3Qgc2NyZWVuTG9jayA9ICdYLVBPLVNjcmVlbi1Mb2NrJztcblxuLyoqXG4gKiBAZGVzY3JpcHRpb25cbiAqXG4gKiBPIHNlcnZpw6dvIFBPIEh0dHAgUmVxdWVzdCBJbnRlcmNlcHRvciByZWFsaXphIGEgY29udGFiaWxpemHDp8OjbyBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcyBuYSBhcGxpY2HDp8Ojby5cbiAqXG4gKiBFeGlzdGUgYSBwb3NzaWJpbGlkYWRlIGRlIG7Do28gZWZldHVhciBhIGNvbnRhYmlsaXphw6fDo28gZGFzIHJlcXVpc2nDp8O1ZXMgcGVuZGVudGVzLCB1dGlsaXphbmRvIG8gcGFyw6JtZXRyb1xuICogYFgtUE8tTm8tQ291bnQtUGVuZGluZy1SZXF1ZXN0c2AuIFBhcmEgaXNzbyBkZXZlIHNlciBpbmZvcm1hZG8gbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gY29tIG8gdmFsb3IgYCd0cnVlJ2AsXG4gKiBwb3IgZXhlbXBsbzpcbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBPLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnOiAndHJ1ZScgfTtcbiAqXG4gKiAgdGhpcy5odHRwLmdldChgL2N1c3RvbWVycy8xYCwgeyBoZWFkZXJzOiBoZWFkZXJzIH0pO1xuICogLi4uXG4gKlxuICogYGBgXG4gKiBQYXJhIG9idGVyIGEgcXVhbnRpZGFkZSBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcywgZGV2ZSBpbnNjcmV2ZXItc2Ugbm8gbcOpdG9kbyBgZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHNgIGRvXG4gKiBzZXJ2acOnbyBgUG9IdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZWAsIGNvbSBpc3NvLCBhbyByZWFsaXphciByZXF1aXNpw6fDtWVzIHV0aWxpemFuZG8gYEh0dHBDbGllbnRgLFxuICogc2Vyw6EgcmV0b3JuYWRvIGEgcXVhbnRpZGFkZSBkZSByZXF1aXNpw6fDtWVzIHBlbmRlbnRlcy5cbiAqXG4gKiBUYW1iw6ltIGV4aXN0ZSBhIHBvc3NpYmlsZGFkZSBkZSB0cmF2YXIgYSB0ZWxhIGUgbW9zdHJhciB1bWEgaW1hZ2VtIGRlIF9sb2FkaW5nXyBkdXJhbnRlIG8gcHJvY2Vzc2FtZW50byBkZSB1bWEgcmVxdWlzacOnw6NvXG4gKiBkZXZlLXNlIHBhc3NhciBvIHBhcsOibWV0cm8gYFgtUE8tU2NyZWVuLUxvY2tgIG5vIGNhYmXDp2FsaG8gZGEgcmVxdWlzacOnw6NvIGNvbSB2YWxvciBgJ3RydWUnYC5cbiAqXG4gKiBwb3IgZXhlbXBsbzpcbiAqXG4gKiBgYGBcbiAqIC4uLlxuICogIGNvbnN0IGhlYWRlcnMgPSB7ICdYLVBPLVNjcmVlbi1Mb2NrJzogJ3RydWUnIH07XG4gKlxuICogIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqIC4uLlxuICpcbiAqIGBgYFxuICogPiBBcMOzcyBhIHZhbGlkYcOnw6NvIG5vIGludGVyY2VwdG9yLCBvIHBhcsOibWV0cm8gc2Vyw6EgcmVtb3ZpZG8gZG8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28uXG4gKlxuICogQW8gaW1wb3J0YXIgbyBtw7NkdWxvIGBQb01vZHVsZWAgbmEgYXBsaWNhw6fDo28sIG8gYHBvLWh0dHAtcmVxdWVzdC1pbnRlcmNlcHRvcmAgw6kgYXV0b21hdGljYW1lbnRlIGNvbmZpZ3VyYWRvIHNlbSBhIG5lY2Vzc2lkYWRlXG4gKiBkZSBxdWFscXVlciBjb25maWd1cmHDp8OjbyBleHRyYS5cbiAqXG4gKlxuICogU2VndWUgYWJhaXhvIHVtIGV4ZW1wbG8gZGUgdXNvOlxuICpcbiAqIGBgYFxuICogaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbiAqXG4gKiAuLi5cbiAqXG4gKiBASW5qZWN0YWJsZSgpXG4gKiBleHBvcnQgY2xhc3MgQ3VzdG9tZXJzU2VydmljZSB7XG4gKlxuICogIGhlYWRlcnMgPSB7ICdYLVBPLU5vLUNvdW50LVBlbmRpbmctUmVxdWVzdHMnOiB0cnVlLCAnWC1QTy1TY3JlZW4tTG9jayc6ICd0cnVlJyB9XG4gKiAgcGVuZGluZ1JlcXVlc3RzOiBudW1iZXIgPSAwO1xuICogIHN1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICpcbiAqICBjb25zdHJ1Y3RvcihcbiAqICAgIHByaXZhdGUgaHR0cDogSHR0cENsaWVudCxcbiAqICAgIHByaXZhdGUgaHR0cFJlcXVlc3RJbnRlcmNlcHRvcjogUG9IdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZSkgeyB9XG4gKlxuICogIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICogICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAqICB9XG4gKlxuICogIG5nT25Jbml0KCk6IHZvaWQge1xuICogICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLmh0dHBSZXF1ZXN0SW50ZXJjZXB0b3IuZ2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoKS5zdWJzY3JpYmUoZGF0YSA9PiB7XG4gKiAgICAgIHRoaXMucGVuZGluZ1JlcXVlc3RzID0gZGF0YTtcbiAqICAgIH0pO1xuICogIH1cbiAqXG4gKiAgZ2V0Q3VzdG9tZXJzKCkge1xuICogICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoYC9jdXN0b21lcnMvMWAsIHsgaGVhZGVyczogaGVhZGVycyB9KTtcbiAqICB9XG4gKlxuICogIC4uLlxuICpcbiAqIH1cbiAqIGBgYFxuICpcbiAqIEBleGFtcGxlXG4gKiA8ZXhhbXBsZSBuYW1lPSdwby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicycgdGl0bGU9J1BPIEh0dHAgUmVxdWVzdCBJbnRlcmNlcHRvciBMYWJzJz5cbiAqICA8ZmlsZSBuYW1lPSdzYW1wbGUtcG8taHR0cC1yZXF1ZXN0LWludGVyY2VwdG9yLWxhYnMuY29tcG9uZW50LnRzJz4gPC9maWxlPlxuICogIDxmaWxlIG5hbWU9J3NhbXBsZS1wby1odHRwLXJlcXVlc3QtaW50ZXJjZXB0b3ItbGFicy5jb21wb25lbnQuaHRtbCc+IDwvZmlsZT5cbiAqIDwvZXhhbXBsZT5cbiAqL1xuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCdcbn0pXG5leHBvcnQgY2xhc3MgUG9IdHRwUmVxdWVzdEludGVyY2VwdG9yU2VydmljZSBpbXBsZW1lbnRzIEh0dHBJbnRlcmNlcHRvciB7XG4gIHByaXZhdGUgbG9hZGluZ092ZXJsYXlDb21wb25lbnQ6IENvbXBvbmVudFJlZjxQb0xvYWRpbmdPdmVybGF5Q29tcG9uZW50PiA9IHVuZGVmaW5lZDtcblxuICBwcml2YXRlIHBlbmRpbmdSZXF1ZXN0czogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSBvdmVybGF5UmVxdWVzdHM6IG51bWJlciA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBjb250cm9sSHR0cFJlcXVlc3Q6IFBvSHR0cFJlcXVlc0NvbnRyb2x0U2VydmljZSxcbiAgICBwcml2YXRlIHBvQ29tcG9uZW50SW5qZWN0b3I6IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlXG4gICkge31cblxuICBpbnRlcmNlcHQocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55PiwgbmV4dDogSHR0cEhhbmRsZXIpIHtcbiAgICBjb25zdCByZXF1ZXN0Q2xvbmUgPSByZXF1ZXN0LmNsb25lKCk7XG5cbiAgICByZXF1ZXN0ID0gdGhpcy5yZXF1ZXN0Q2xvbmVXaXRob3V0SGVhZGVyUGFyYW0oW25vQ291bnRQZW5kaW5nUmVxdWVzdHMsIHNjcmVlbkxvY2tdLCByZXF1ZXN0KTtcblxuICAgIHRoaXMuc2V0Q291bnRQZW5kaW5nUmVxdWVzdHModHJ1ZSwgcmVxdWVzdENsb25lKTtcbiAgICB0aGlzLnNldENvdW50T3ZlcmxheVJlcXVlc3RzKHRydWUsIHJlcXVlc3RDbG9uZSk7XG5cbiAgICByZXR1cm4gbmV4dC5oYW5kbGUocmVxdWVzdCkucGlwZShcbiAgICAgIHRhcCgocmVzcG9uc2U6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG4gICAgICAgIGlmIChyZXNwb25zZSBpbnN0YW5jZW9mIEh0dHBSZXNwb25zZSkge1xuICAgICAgICAgIHRoaXMuc2V0Q291bnRQZW5kaW5nUmVxdWVzdHMoZmFsc2UsIHJlcXVlc3RDbG9uZSk7XG4gICAgICAgICAgdGhpcy5zZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBjYXRjaEVycm9yKGVycm9yID0+IHtcbiAgICAgICAgdGhpcy5zZXRDb3VudFBlbmRpbmdSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcbiAgICAgICAgdGhpcy5zZXRDb3VudE92ZXJsYXlSZXF1ZXN0cyhmYWxzZSwgcmVxdWVzdENsb25lKTtcblxuICAgICAgICByZXR1cm4gdGhyb3dFcnJvcihlcnJvcik7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBnZXRDb3VudFBlbmRpbmdSZXF1ZXN0cygpOiBPYnNlcnZhYmxlPGFueT4ge1xuICAgIHJldHVybiB0aGlzLmNvbnRyb2xIdHRwUmVxdWVzdC5nZXRDb250cm9sSHR0cFJlcXVlc3QoKTtcbiAgfVxuXG4gIHByaXZhdGUgYnVpbGRMb2FkaW5nKCkge1xuICAgIGlmICghdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCkge1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudCA9IHRoaXMucG9Db21wb25lbnRJbmplY3Rvci5jcmVhdGVDb21wb25lbnRJbkFwcGxpY2F0aW9uKFBvTG9hZGluZ092ZXJsYXlDb21wb25lbnQpO1xuICAgICAgdGhpcy5sb2FkaW5nT3ZlcmxheUNvbXBvbmVudC5pbnN0YW5jZS5zY3JlZW5Mb2NrID0gdHJ1ZTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQuaW5zdGFuY2UuY2hhbmdlRGV0ZWN0b3IuZGV0ZWN0Q2hhbmdlcygpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgZGVzdHJveUxvYWRpbmcoKSB7XG4gICAgaWYgKHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQpIHtcbiAgICAgIHRoaXMucG9Db21wb25lbnRJbmplY3Rvci5kZXN0cm95Q29tcG9uZW50SW5BcHBsaWNhdGlvbih0aGlzLmxvYWRpbmdPdmVybGF5Q29tcG9uZW50KTtcbiAgICAgIHRoaXMubG9hZGluZ092ZXJsYXlDb21wb25lbnQgPSB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSByZXF1ZXN0Q2xvbmVXaXRob3V0SGVhZGVyUGFyYW0oaGVhZGVyc1BhcmFtczogQXJyYXk8c3RyaW5nPiwgcmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IEh0dHBSZXF1ZXN0PGFueT4ge1xuICAgIGxldCBpc1JlcXVlc3RDbG9uZSA9IGZhbHNlO1xuXG4gICAgaGVhZGVyc1BhcmFtcy5mb3JFYWNoKGhlYWRlclBhcmFtID0+IHtcbiAgICAgIGlmIChyZXF1ZXN0LmhlYWRlcnMuaGFzKGhlYWRlclBhcmFtKSkge1xuICAgICAgICByZXF1ZXN0LmhlYWRlcnMuZGVsZXRlKGhlYWRlclBhcmFtKTtcbiAgICAgICAgaXNSZXF1ZXN0Q2xvbmUgPSB0cnVlO1xuICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlzUmVxdWVzdENsb25lID8gcmVxdWVzdC5jbG9uZSh7IGhlYWRlcnM6IHJlcXVlc3QuaGVhZGVycyB9KSA6IHJlcXVlc3Q7XG4gIH1cblxuICBwcml2YXRlIHNldENvdW50UGVuZGluZ1JlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtID0gcmVxdWVzdC5oZWFkZXJzLmhhcyhub0NvdW50UGVuZGluZ1JlcXVlc3RzKTtcbiAgICBjb25zdCBoZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5nZXQobm9Db3VudFBlbmRpbmdSZXF1ZXN0cyk7XG5cbiAgICBpZiAoaGFzQ291bnRQZW5kaW5nUmVxdWVzdEhlYWRlclBhcmFtICYmIGhlYWRlclBhcmFtLnRvU3RyaW5nKCkudG9Mb3dlckNhc2UoKSA9PT0gJ3RydWUnKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5wZW5kaW5nUmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgdGhpcy5jb250cm9sSHR0cFJlcXVlc3Quc2VuZCh0aGlzLnBlbmRpbmdSZXF1ZXN0cyk7XG4gIH1cblxuICBwcml2YXRlIHNldENvdW50T3ZlcmxheVJlcXVlc3RzKGlzSW5jcmVtZW50OiBib29sZWFuLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSA9IHJlcXVlc3QuaGVhZGVycy5oYXMoc2NyZWVuTG9jayk7XG5cbiAgICBpZiAoaGFzT3ZlcmxheVJlcXVlc3RIZWFkZXJQYXJhbSkge1xuICAgICAgY29uc3QgaGVhZGVyUGFyYW0gPSByZXF1ZXN0LmhlYWRlcnMuZ2V0KHNjcmVlbkxvY2spO1xuXG4gICAgICBpZiAoaGVhZGVyUGFyYW0udG9TdHJpbmcoKS50b0xvd2VyQ2FzZSgpID09PSAnZmFsc2UnKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgdGhpcy5vdmVybGF5UmVxdWVzdHMgKz0gaXNJbmNyZW1lbnQgPyAxIDogLTE7XG4gICAgICB0aGlzLm92ZXJsYXlSZXF1ZXN0cyA+IDAgPyB0aGlzLmJ1aWxkTG9hZGluZygpIDogdGhpcy5kZXN0cm95TG9hZGluZygpO1xuICAgIH1cbiAgfVxufVxuIl19