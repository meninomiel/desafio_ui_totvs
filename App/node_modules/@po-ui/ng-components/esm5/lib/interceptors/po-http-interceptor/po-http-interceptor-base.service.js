import { __assign, __read, __spread } from "tslib";
import { HttpResponse } from '@angular/common/http';
import { tap } from 'rxjs/operators';
import { PoHttpInterceptorDetailComponent } from './po-http-interceptor-detail/po-http-interceptor-detail.component';
// DEPRECATED 4.x.x
var NO_ERROR_HEADER_PARAM = 'X-PO-No-Error';
var NO_MESSAGE_HEADER_PARAM = 'X-PO-No-Message';
/**
 * @description
 *
 * O *interceptor* tem a finalidade de exibir notificações com mensagens na tela, baseado nas respostas das requisições HTTP.
 *
 * Pode ser utilizado para dar feedback das ações do usuário como, por exemplo: erro de autorização, mensagens de regras de negócio,
 * atualizações de registros, erro quando o servidor estiver indisponível e entre outros.
 *
 * ## Configuração
 *
 * Para o correto funcionamento do interceptor `po-http-interceptor`, deve ser importado o `BrowserAnimationsModule` no
 * módulo principal da sua aplicação.
 *
 * Módulo da aplicação:
 * ```
 * import { BrowserAnimationsModule } from '@angular/platform-browser/animations';
 * import { PoModule } from '@po-ui/ng-components';
 * ...
 *
 * @NgModule({
 *   imports: [
 *     BrowserModule,
 *     BrowserAnimationsModule,
 *     ...
 *     PoModule
 *   ],
 *   declarations: [
 *     AppComponent,
 *     ...
 *   ],
 *   providers: [],
 *   bootstrap: [AppComponent]
 * })
 * export class AppModule { }
 * ```
 *
 * Ao importar o módulo `PoModule` na aplicação, o `po-http-interceptor` é automaticamente configurado sem a necessidade
 * de qualquer configuração extra.
 *
 * Ao realizar requisições utilize o `HttpClient`, conforme exemplo abaixo:
 *
 * ```
 * import { HttpClient } from '@angular/common/http';
 *
 * ...
 *
 * @Injectable()
 * export class UserService {
 *
 *   constructor(private http: HttpClient) { }
 *
 *   getUsers() {
 *     return this.http.get('/api/users');
 *   }
 *
 *   ...
 *
 * }
 * ```
 *
 * ## Como usar
 *
 * Para exibir as noticações é necessário informar a mensagem no retorno da requisição. A estrutura da mensagem
 * é feita com base no status da resposta, conforme será apresentado nos próximos tópicos.
 *
 * ### Estrutura das mensagens
 *
 * #### Mensagens de sucesso `2xx`
 *
 * Para exibir mensagens ao retornar uma lista ou um item, deve-se incluir a propriedade `_messages` no objeto de retorno.
 * Por exemplo:
 * ```
 * {
 *   "_messages": [
 *     {
 *       "type": "success" || "warning" || "error" || "information" (será exibido a `tag` apenas se esta propriedade possuir valor),
 *       "code": "título ou código da mensagem",
 *       "message": "texto da mensagem",
 *       "detailedMessage": "detalhamento da mensagem"
 *     }
 *   ]
 * }
 * ```
 *
 * #### Mensagens de erro `4xx` ou `5xx`
 *
 * Ao retornar erro, o objeto não necessita ter `_messages`, deve-se retornar o objeto diretamente:
 *
 * ```
 * {
 *    "code": "título ou código da mensagem",
 *    "message": "texto da mensagem",
 *    "detailedMessage": "detalhamento da mensagem"
 * }
 * ```
 *
 * Também é possível informar as seguintes propriedades:
 *
 * - `helpUrl`: link para a documentação do erro;
 *    - Caso for informado, será exibido uma ação de "Ajuda" na notificação, para isso não deverá ter a propriedade `detailedMessage`.
 * - `details`: Uma lista de objetos de mensagem (recursiva) com mais detalhes sobre a mensagem principal.
 *
 * > Veja o [Guia de implementação de APIs](guides/api) para mais detalhes sobre a estrutura das mensagens.
 *
 * ### Cabeçalho
 *
 * É possível dispensar a notificação para o usuário utilizando no cabeçalho da requisição os parâmetros listados abaixo com o valor
 * igual a `true`:
 *
 * - `X-PO-No-Message`: Não exibe notificações de erro e/ou sucesso.
 *
 * - **Depreciado** `X-PO-No-Error`: não mostra notificações de erro com códigos `4xx` e `5xx`.
 *
 * ```
 * ...
 *  const headers = { 'X-PO-No-Message': 'true' };
 *
 *  this.http.get(`/customers/1`, { headers: headers });
 * ...
 *
 * ```
 *
 * > Após a validação no *interceptor*, os parâmetros serão removidos do cabeçalho da requisição.
 *
 */
var PoHttpInterceptorBaseService = /** @class */ (function () {
    function PoHttpInterceptorBaseService(componentInjector, notification) {
        this.componentInjector = componentInjector;
        this.notification = notification;
        this.notificationTypes = ['success', 'warning', 'error', 'information'];
        this.httpInterceptorDetailComponent = undefined;
    }
    PoHttpInterceptorBaseService.prototype.intercept = function (request, next) {
        var _this = this;
        var cloneRequest = request.clone();
        request = request && this.hasParameters(request) ? this.cloneRequestWithoutParameters(request) : request;
        return next.handle(request).pipe(tap(function (response) {
            if (response instanceof HttpResponse) {
                _this.processResponse(response, cloneRequest);
            }
        }, function (error) {
            _this.processErrorResponse(error, cloneRequest);
        }));
    };
    PoHttpInterceptorBaseService.prototype.processResponse = function (response, request) {
        var _this = this;
        var hasNoMessageParam = this.hasNoMessageParam(request);
        if (!hasNoMessageParam && response.body && response.body._messages) {
            var messages = response.body._messages;
            if (messages instanceof Array) {
                messages.forEach(function (message) {
                    _this.showNotification(message);
                });
            }
            else {
                this.showNotification(messages);
            }
        }
    };
    PoHttpInterceptorBaseService.prototype.processErrorResponse = function (response, request) {
        var errorResponse = response.status !== 0
            ? response.error
            : { code: 0, message: 'Servidor não está respondendo.', detailedMessage: response.message };
        var hasNoErrorParam = this.hasNoErrorParam(request);
        var hasNoMessageParam = this.hasNoMessageParam(request);
        if (errorResponse && errorResponse.message && !hasNoErrorParam && !hasNoMessageParam) {
            this.showNotification(__assign(__assign({}, errorResponse), { type: 'error' }));
        }
    };
    PoHttpInterceptorBaseService.prototype.cloneRequestWithoutParameters = function (request) {
        var headers = request.headers.delete(NO_ERROR_HEADER_PARAM).delete(NO_MESSAGE_HEADER_PARAM);
        return request.clone({ headers: headers });
    };
    PoHttpInterceptorBaseService.prototype.createModal = function (responseMessage) {
        var _this = this;
        var details = responseMessage.details ? __spread([responseMessage], responseMessage.details) : [responseMessage];
        this.httpInterceptorDetailComponent = this.componentInjector.createComponentInApplication(PoHttpInterceptorDetailComponent);
        this.httpInterceptorDetailComponent.instance.detail = details;
        this.httpInterceptorDetailComponent.instance.closed.subscribe(function () { return _this.destroyModal(); });
        this.httpInterceptorDetailComponent.instance.open();
    };
    PoHttpInterceptorBaseService.prototype.destroyModal = function () {
        if (this.httpInterceptorDetailComponent) {
            this.componentInjector.destroyComponentInApplication(this.httpInterceptorDetailComponent);
            this.httpInterceptorDetailComponent = undefined;
        }
    };
    PoHttpInterceptorBaseService.prototype.hasMessage = function (responseMessage) {
        var hasMessageProperties = responseMessage.message;
        return responseMessage && hasMessageProperties;
    };
    PoHttpInterceptorBaseService.prototype.hasNoErrorParam = function (request) {
        var noErrorParam = request && request.headers.get(NO_ERROR_HEADER_PARAM);
        return noErrorParam && noErrorParam.toString().toLocaleLowerCase() === 'true';
    };
    PoHttpInterceptorBaseService.prototype.hasNoMessageParam = function (request) {
        var noMessageParam = request && request.headers.get(NO_MESSAGE_HEADER_PARAM);
        return noMessageParam && noMessageParam.toString().toLocaleLowerCase() === 'true';
    };
    PoHttpInterceptorBaseService.prototype.hasParameters = function (request) {
        return request.headers.has(NO_ERROR_HEADER_PARAM) || request.headers.has(NO_MESSAGE_HEADER_PARAM);
    };
    PoHttpInterceptorBaseService.prototype.showNotification = function (response) {
        if (!this.hasMessage(response)) {
            return;
        }
        var typeNotification = this.notificationTypes.includes(response.type) ? response.type : 'information';
        var notificationAction = this.generateNotificationAction(response);
        this.notification[typeNotification]({
            message: response.message,
            actionLabel: notificationAction.label,
            action: notificationAction.action
        });
    };
    PoHttpInterceptorBaseService.prototype.generateDetailModal = function (responseMessage) {
        var _this = this;
        return function () {
            if (!_this.httpInterceptorDetailComponent) {
                _this.createModal(responseMessage);
            }
        };
    };
    PoHttpInterceptorBaseService.prototype.generateNotificationAction = function (responseMessage) {
        var notificationAction;
        var notificationLabel;
        if (responseMessage.helpUrl && !(responseMessage.detailedMessage || responseMessage.details)) {
            notificationLabel = 'Ajuda';
            notificationAction = this.generateUrlHelpFunction(responseMessage.helpUrl);
        }
        else if (responseMessage.detailedMessage || responseMessage.details) {
            notificationLabel = 'Detalhes';
            notificationAction = this.generateDetailModal(responseMessage);
        }
        return { label: notificationLabel, action: notificationAction };
    };
    PoHttpInterceptorBaseService.prototype.generateUrlHelpFunction = function (helpUrl) {
        return function () {
            window.open(helpUrl, '_blank');
        };
    };
    return PoHttpInterceptorBaseService;
}());
export { PoHttpInterceptorBaseService };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG8taHR0cC1pbnRlcmNlcHRvci1iYXNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290Ijoibmc6Ly9AcG8tdWkvbmctY29tcG9uZW50cy8iLCJzb3VyY2VzIjpbImxpYi9pbnRlcmNlcHRvcnMvcG8taHR0cC1pbnRlcmNlcHRvci9wby1odHRwLWludGVyY2VwdG9yLWJhc2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQ0EsT0FBTyxFQUlMLFlBQVksRUFHYixNQUFNLHNCQUFzQixDQUFDO0FBRzlCLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUlyQyxPQUFPLEVBQUUsZ0NBQWdDLEVBQUUsTUFBTSxtRUFBbUUsQ0FBQztBQUVySCxtQkFBbUI7QUFDbkIsSUFBTSxxQkFBcUIsR0FBRyxlQUFlLENBQUM7QUFDOUMsSUFBTSx1QkFBdUIsR0FBRyxpQkFBaUIsQ0FBQztBQUVsRDs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQTRIRztBQUNIO0lBS0Usc0NBQW9CLGlCQUE2QyxFQUFVLFlBQWlCO1FBQXhFLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBNEI7UUFBVSxpQkFBWSxHQUFaLFlBQVksQ0FBSztRQUo1RixzQkFBaUIsR0FBRyxDQUFDLFNBQVMsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRTNELG1DQUE4QixHQUFtRCxTQUFTLENBQUM7SUFFSixDQUFDO0lBRWhHLGdEQUFTLEdBQVQsVUFBVSxPQUF5QixFQUFFLElBQWlCO1FBQXRELGlCQWlCQztRQWhCQyxJQUFNLFlBQVksR0FBRyxPQUFPLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFckMsT0FBTyxHQUFHLE9BQU8sSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFD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Q0FBQyx1QkFBdUIsQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDNUU7YUFBTSxJQUFJLGVBQWUsQ0FBQyxlQUFlLElBQUksZUFBZSxDQUFDLE9BQU8sRUFBRTtZQUNyRSxpQkFBaUIsR0FBRyxVQUFVLENBQUM7WUFDL0Isa0JBQWtCLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1NBQ2hFO1FBQ0QsT0FBTyxFQUFFLEtBQUssRUFBRSxpQkFBaUIsRUFBRSxNQUFNLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQztJQUNsRSxDQUFDO0lBRU8sOERBQXVCLEdBQS9CLFVBQWdDLE9BQWU7UUFDN0MsT0FBTztZQUNMLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQztJQUNKLENBQUM7SUFDSCxtQ0FBQztBQUFELENBQUMsQUFqSkQsSUFpSkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb21wb25lbnRSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEh0dHBJbnRlcmNlcHRvcixcbiAgSHR0cEhhbmRsZXIsXG4gIEh0dHBSZXF1ZXN0LFxuICBIdHRwUmVzcG9uc2UsXG4gIEh0dHBFdmVudCxcbiAgSHR0cEVycm9yUmVzcG9uc2Vcbn0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuXG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc2VydmljZXMvcG8tY29tcG9uZW50LWluamVjdG9yL3BvLWNvbXBvbmVudC1pbmplY3Rvci5zZXJ2aWNlJztcbmltcG9ydCB7IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsIH0gZnJvbSAnLi9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC9wby1odHRwLWludGVyY2VwdG9yLWRldGFpbC5pbnRlcmZhY2UnO1xuaW1wb3J0IHsgUG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQgfSBmcm9tICcuL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsL3BvLWh0dHAtaW50ZXJjZXB0b3ItZGV0YWlsLmNvbXBvbmVudCc7XG5cbi8vIERFUFJFQ0FURUQgNC54LnhcbmNvbnN0IE5PX0VSUk9SX0hFQURFUl9QQVJBTSA9ICdYLVBPLU5vLUVycm9yJztcbmNvbnN0IE5PX01FU1NBR0VfSEVBREVSX1BBUkFNID0gJ1gtUE8tTm8tTWVzc2FnZSc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKlxuICogTyAqaW50ZXJjZXB0b3IqIHRlbSBhIGZpbmFsaWRhZGUgZGUgZXhpYmlyIG5vdGlmaWNhw6fDtWVzIGNvbSBtZW5zYWdlbnMgbmEgdGVsYSwgYmFzZWFkbyBuYXMgcmVzcG9zdGFzIGRhcyByZXF1aXNpw6fDtWVzIEhUVFAuXG4gKlxuICogUG9kZSBzZXIgdXRpbGl6YWRvIHBhcmEgZGFyIGZlZWRiYWNrIGRhcyBhw6fDtWVzIGRvIHVzdcOhcmlvIGNvbW8sIHBvciBleGVtcGxvOiBlcnJvIGRlIGF1dG9yaXphw6fDo28sIG1lbnNhZ2VucyBkZSByZWdyYXMgZGUgbmVnw7NjaW8sXG4gKiBhdHVhbGl6YcOnw7VlcyBkZSByZWdpc3Ryb3MsIGVycm8gcXVhbmRvIG8gc2Vydmlkb3IgZXN0aXZlciBpbmRpc3BvbsOtdmVsIGUgZW50cmUgb3V0cm9zLlxuICpcbiAqICMjIENvbmZpZ3VyYcOnw6NvXG4gKlxuICogUGFyYSBvIGNvcnJldG8gZnVuY2lvbmFtZW50byBkbyBpbnRlcmNlcHRvciBgcG8taHR0cC1pbnRlcmNlcHRvcmAsIGRldmUgc2VyIGltcG9ydGFkbyBvIGBCcm93c2VyQW5pbWF0aW9uc01vZHVsZWAgbm9cbiAqIG3Ds2R1bG8gcHJpbmNpcGFsIGRhIHN1YSBhcGxpY2HDp8Ojby5cbiAqXG4gKiBNw7NkdWxvIGRhIGFwbGljYcOnw6NvOlxuICogYGBgXG4gKiBpbXBvcnQgeyBCcm93c2VyQW5pbWF0aW9uc01vZHVsZSB9IGZyb20gJ0Bhbmd1bGFyL3BsYXRmb3JtLWJyb3dzZXIvYW5pbWF0aW9ucyc7XG4gKiBpbXBvcnQgeyBQb01vZHVsZSB9IGZyb20gJ0Bwby11aS9uZy1jb21wb25lbnRzJztcbiAqIC4uLlxuICpcbiAqIEBOZ01vZHVsZSh7XG4gKiAgIGltcG9ydHM6IFtcbiAqICAgICBCcm93c2VyTW9kdWxlLFxuICogICAgIEJyb3dzZXJBbmltYXRpb25zTW9kdWxlLFxuICogICAgIC4uLlxuICogICAgIFBvTW9kdWxlXG4gKiAgIF0sXG4gKiAgIGRlY2xhcmF0aW9uczogW1xuICogICAgIEFwcENvbXBvbmVudCxcbiAqICAgICAuLi5cbiAqICAgXSxcbiAqICAgcHJvdmlkZXJzOiBbXSxcbiAqICAgYm9vdHN0cmFwOiBbQXBwQ29tcG9uZW50XVxuICogfSlcbiAqIGV4cG9ydCBjbGFzcyBBcHBNb2R1bGUgeyB9XG4gKiBgYGBcbiAqXG4gKiBBbyBpbXBvcnRhciBvIG3Ds2R1bG8gYFBvTW9kdWxlYCBuYSBhcGxpY2HDp8OjbywgbyBgcG8taHR0cC1pbnRlcmNlcHRvcmAgw6kgYXV0b21hdGljYW1lbnRlIGNvbmZpZ3VyYWRvIHNlbSBhIG5lY2Vzc2lkYWRlXG4gKiBkZSBxdWFscXVlciBjb25maWd1cmHDp8OjbyBleHRyYS5cbiAqXG4gKiBBbyByZWFsaXphciByZXF1aXNpw6fDtWVzIHV0aWxpemUgbyBgSHR0cENsaWVudGAsIGNvbmZvcm1lIGV4ZW1wbG8gYWJhaXhvOlxuICpcbiAqIGBgYFxuICogaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcbiAqXG4gKiAuLi5cbiAqXG4gKiBASW5qZWN0YWJsZSgpXG4gKiBleHBvcnQgY2xhc3MgVXNlclNlcnZpY2Uge1xuICpcbiAqICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwQ2xpZW50KSB7IH1cbiAqXG4gKiAgIGdldFVzZXJzKCkge1xuICogICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KCcvYXBpL3VzZXJzJyk7XG4gKiAgIH1cbiAqXG4gKiAgIC4uLlxuICpcbiAqIH1cbiAqIGBgYFxuICpcbiAqICMjIENvbW8gdXNhclxuICpcbiAqIFBhcmEgZXhpYmlyIGFzIG5vdGljYcOnw7VlcyDDqSBuZWNlc3PDoXJpbyBpbmZvcm1hciBhIG1lbnNhZ2VtIG5vIHJldG9ybm8gZGEgcmVxdWlzacOnw6NvLiBBIGVzdHJ1dHVyYSBkYSBtZW5zYWdlbVxuICogw6kgZmVpdGEgY29tIGJhc2Ugbm8gc3RhdHVzIGRhIHJlc3Bvc3RhLCBjb25mb3JtZSBzZXLDoSBhcHJlc2VudGFkbyBub3MgcHLDs3hpbW9zIHTDs3BpY29zLlxuICpcbiAqICMjIyBFc3RydXR1cmEgZGFzIG1lbnNhZ2Vuc1xuICpcbiAqICMjIyMgTWVuc2FnZW5zIGRlIHN1Y2Vzc28gYDJ4eGBcbiAqXG4gKiBQYXJhIGV4aWJpciBtZW5zYWdlbnMgYW8gcmV0b3JuYXIgdW1hIGxpc3RhIG91IHVtIGl0ZW0sIGRldmUtc2UgaW5jbHVpciBhIHByb3ByaWVkYWRlIGBfbWVzc2FnZXNgIG5vIG9iamV0byBkZSByZXRvcm5vLlxuICogUG9yIGV4ZW1wbG86XG4gKiBgYGBcbiAqIHtcbiAqICAgXCJfbWVzc2FnZXNcIjogW1xuICogICAgIHtcbiAqICAgICAgIFwidHlwZVwiOiBcInN1Y2Nlc3NcIiB8fCBcIndhcm5pbmdcIiB8fCBcImVycm9yXCIgfHwgXCJpbmZvcm1hdGlvblwiIChzZXLDoSBleGliaWRvIGEgYHRhZ2AgYXBlbmFzIHNlIGVzdGEgcHJvcHJpZWRhZGUgcG9zc3VpciB2YWxvciksXG4gKiAgICAgICBcImNvZGVcIjogXCJ0w610dWxvIG91IGPDs2RpZ28gZGEgbWVuc2FnZW1cIixcbiAqICAgICAgIFwibWVzc2FnZVwiOiBcInRleHRvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICAgICBcImRldGFpbGVkTWVzc2FnZVwiOiBcImRldGFsaGFtZW50byBkYSBtZW5zYWdlbVwiXG4gKiAgICAgfVxuICogICBdXG4gKiB9XG4gKiBgYGBcbiAqXG4gKiAjIyMjIE1lbnNhZ2VucyBkZSBlcnJvIGA0eHhgIG91IGA1eHhgXG4gKlxuICogQW8gcmV0b3JuYXIgZXJybywgbyBvYmpldG8gbsOjbyBuZWNlc3NpdGEgdGVyIGBfbWVzc2FnZXNgLCBkZXZlLXNlIHJldG9ybmFyIG8gb2JqZXRvIGRpcmV0YW1lbnRlOlxuICpcbiAqIGBgYFxuICoge1xuICogICAgXCJjb2RlXCI6IFwidMOtdHVsbyBvdSBjw7NkaWdvIGRhIG1lbnNhZ2VtXCIsXG4gKiAgICBcIm1lc3NhZ2VcIjogXCJ0ZXh0byBkYSBtZW5zYWdlbVwiLFxuICogICAgXCJkZXRhaWxlZE1lc3NhZ2VcIjogXCJkZXRhbGhhbWVudG8gZGEgbWVuc2FnZW1cIlxuICogfVxuICogYGBgXG4gKlxuICogVGFtYsOpbSDDqSBwb3Nzw612ZWwgaW5mb3JtYXIgYXMgc2VndWludGVzIHByb3ByaWVkYWRlczpcbiAqXG4gKiAtIGBoZWxwVXJsYDogbGluayBwYXJhIGEgZG9jdW1lbnRhw6fDo28gZG8gZXJybztcbiAqICAgIC0gQ2FzbyBmb3IgaW5mb3JtYWRvLCBzZXLDoSBleGliaWRvIHVtYSBhw6fDo28gZGUgXCJBanVkYVwiIG5hIG5vdGlmaWNhw6fDo28sIHBhcmEgaXNzbyBuw6NvIGRldmVyw6EgdGVyIGEgcHJvcHJpZWRhZGUgYGRldGFpbGVkTWVzc2FnZWAuXG4gKiAtIGBkZXRhaWxzYDogVW1hIGxpc3RhIGRlIG9iamV0b3MgZGUgbWVuc2FnZW0gKHJlY3Vyc2l2YSkgY29tIG1haXMgZGV0YWxoZXMgc29icmUgYSBtZW5zYWdlbSBwcmluY2lwYWwuXG4gKlxuICogPiBWZWphIG8gW0d1aWEgZGUgaW1wbGVtZW50YcOnw6NvIGRlIEFQSXNdKGd1aWRlcy9hcGkpIHBhcmEgbWFpcyBkZXRhbGhlcyBzb2JyZSBhIGVzdHJ1dHVyYSBkYXMgbWVuc2FnZW5zLlxuICpcbiAqICMjIyBDYWJlw6dhbGhvXG4gKlxuICogw4kgcG9zc8OtdmVsIGRpc3BlbnNhciBhIG5vdGlmaWNhw6fDo28gcGFyYSBvIHVzdcOhcmlvIHV0aWxpemFuZG8gbm8gY2FiZcOnYWxobyBkYSByZXF1aXNpw6fDo28gb3MgcGFyw6JtZXRyb3MgbGlzdGFkb3MgYWJhaXhvIGNvbSBvIHZhbG9yXG4gKiBpZ3VhbCBhIGB0cnVlYDpcbiAqXG4gKiAtIGBYLVBPLU5vLU1lc3NhZ2VgOiBOw6NvIGV4aWJlIG5vdGlmaWNhw6fDtWVzIGRlIGVycm8gZS9vdSBzdWNlc3NvLlxuICpcbiAqIC0gKipEZXByZWNpYWRvKiogYFgtUE8tTm8tRXJyb3JgOiBuw6NvIG1vc3RyYSBub3RpZmljYcOnw7VlcyBkZSBlcnJvIGNvbSBjw7NkaWdvcyBgNHh4YCBlIGA1eHhgLlxuICpcbiAqIGBgYFxuICogLi4uXG4gKiAgY29uc3QgaGVhZGVycyA9IHsgJ1gtUE8tTm8tTWVzc2FnZSc6ICd0cnVlJyB9O1xuICpcbiAqICB0aGlzLmh0dHAuZ2V0KGAvY3VzdG9tZXJzLzFgLCB7IGhlYWRlcnM6IGhlYWRlcnMgfSk7XG4gKiAuLi5cbiAqXG4gKiBgYGBcbiAqXG4gKiA+IEFww7NzIGEgdmFsaWRhw6fDo28gbm8gKmludGVyY2VwdG9yKiwgb3MgcGFyw6JtZXRyb3Mgc2Vyw6NvIHJlbW92aWRvcyBkbyBjYWJlw6dhbGhvIGRhIHJlcXVpc2nDp8Ojby5cbiAqXG4gKi9cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBQb0h0dHBJbnRlcmNlcHRvckJhc2VTZXJ2aWNlIGltcGxlbWVudHMgSHR0cEludGVyY2VwdG9yIHtcbiAgbm90aWZpY2F0aW9uVHlwZXMgPSBbJ3N1Y2Nlc3MnLCAnd2FybmluZycsICdlcnJvcicsICdpbmZvcm1hdGlvbiddO1xuXG4gIHByaXZhdGUgaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50OiBDb21wb25lbnRSZWY8UG9IdHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQ+ID0gdW5kZWZpbmVkO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY29tcG9uZW50SW5qZWN0b3I6IFBvQ29tcG9uZW50SW5qZWN0b3JTZXJ2aWNlLCBwcml2YXRlIG5vdGlmaWNhdGlvbjogYW55KSB7fVxuXG4gIGludGVyY2VwdChyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+LCBuZXh0OiBIdHRwSGFuZGxlcik6IE9ic2VydmFibGU8SHR0cEV2ZW50PGFueT4+IHtcbiAgICBjb25zdCBjbG9uZVJlcXVlc3QgPSByZXF1ZXN0LmNsb25lKCk7XG5cbiAgICByZXF1ZXN0ID0gcmVxdWVzdCAmJiB0aGlzLmhhc1BhcmFtZXRlcnMocmVxdWVzdCkgPyB0aGlzLmNsb25lUmVxdWVzdFdpdGhvdXRQYXJhbWV0ZXJzKHJlcXVlc3QpIDogcmVxdWVzdDtcblxuICAgIHJldHVybiBuZXh0LmhhbmRsZShyZXF1ZXN0KS5waXBlKFxuICAgICAgdGFwKFxuICAgICAgICAocmVzcG9uc2U6IEh0dHBFdmVudDxhbnk+KSA9PiB7XG4gICAgICAgICAgaWYgKHJlc3BvbnNlIGluc3RhbmNlb2YgSHR0cFJlc3BvbnNlKSB7XG4gICAgICAgICAgICB0aGlzLnByb2Nlc3NSZXNwb25zZShyZXNwb25zZSwgY2xvbmVSZXF1ZXN0KTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sXG4gICAgICAgIChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+IHtcbiAgICAgICAgICB0aGlzLnByb2Nlc3NFcnJvclJlc3BvbnNlKGVycm9yLCBjbG9uZVJlcXVlc3QpO1xuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByb2Nlc3NSZXNwb25zZShyZXNwb25zZTogSHR0cFJlc3BvbnNlPGFueT4sIHJlcXVlc3Q6IEh0dHBSZXF1ZXN0PGFueT4pIHtcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XG5cbiAgICBpZiAoIWhhc05vTWVzc2FnZVBhcmFtICYmIHJlc3BvbnNlLmJvZHkgJiYgcmVzcG9uc2UuYm9keS5fbWVzc2FnZXMpIHtcbiAgICAgIGNvbnN0IG1lc3NhZ2VzID0gcmVzcG9uc2UuYm9keS5fbWVzc2FnZXM7XG5cbiAgICAgIGlmIChtZXNzYWdlcyBpbnN0YW5jZW9mIEFycmF5KSB7XG4gICAgICAgIG1lc3NhZ2VzLmZvckVhY2goKG1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSA9PiB7XG4gICAgICAgICAgdGhpcy5zaG93Tm90aWZpY2F0aW9uKG1lc3NhZ2UpO1xuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbihtZXNzYWdlcyk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJvY2Vzc0Vycm9yUmVzcG9uc2UocmVzcG9uc2U6IEh0dHBFcnJvclJlc3BvbnNlLCByZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgY29uc3QgZXJyb3JSZXNwb25zZSA9XG4gICAgICByZXNwb25zZS5zdGF0dXMgIT09IDBcbiAgICAgICAgPyByZXNwb25zZS5lcnJvclxuICAgICAgICA6IHsgY29kZTogMCwgbWVzc2FnZTogJ1NlcnZpZG9yIG7Do28gZXN0w6EgcmVzcG9uZGVuZG8uJywgZGV0YWlsZWRNZXNzYWdlOiByZXNwb25zZS5tZXNzYWdlIH07XG5cbiAgICBjb25zdCBoYXNOb0Vycm9yUGFyYW0gPSB0aGlzLmhhc05vRXJyb3JQYXJhbShyZXF1ZXN0KTtcbiAgICBjb25zdCBoYXNOb01lc3NhZ2VQYXJhbSA9IHRoaXMuaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdCk7XG5cbiAgICBpZiAoZXJyb3JSZXNwb25zZSAmJiBlcnJvclJlc3BvbnNlLm1lc3NhZ2UgJiYgIWhhc05vRXJyb3JQYXJhbSAmJiAhaGFzTm9NZXNzYWdlUGFyYW0pIHtcbiAgICAgIHRoaXMuc2hvd05vdGlmaWNhdGlvbih7IC4uLmVycm9yUmVzcG9uc2UsIHR5cGU6ICdlcnJvcicgfSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBjbG9uZVJlcXVlc3RXaXRob3V0UGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogSHR0cFJlcXVlc3Q8YW55PiB7XG4gICAgY29uc3QgaGVhZGVycyA9IHJlcXVlc3QuaGVhZGVycy5kZWxldGUoTk9fRVJST1JfSEVBREVSX1BBUkFNKS5kZWxldGUoTk9fTUVTU0FHRV9IRUFERVJfUEFSQU0pO1xuXG4gICAgcmV0dXJuIHJlcXVlc3QuY2xvbmUoeyBoZWFkZXJzIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBjcmVhdGVNb2RhbChyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XG4gICAgY29uc3QgZGV0YWlscyA9IHJlc3BvbnNlTWVzc2FnZS5kZXRhaWxzID8gW3Jlc3BvbnNlTWVzc2FnZSwgLi4ucmVzcG9uc2VNZXNzYWdlLmRldGFpbHNdIDogW3Jlc3BvbnNlTWVzc2FnZV07XG5cbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudCA9IHRoaXMuY29tcG9uZW50SW5qZWN0b3IuY3JlYXRlQ29tcG9uZW50SW5BcHBsaWNhdGlvbihcbiAgICAgIFBvSHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50XG4gICAgKTtcbiAgICB0aGlzLmh0dHBJbnRlcmNlcHRvckRldGFpbENvbXBvbmVudC5pbnN0YW5jZS5kZXRhaWwgPSBkZXRhaWxzO1xuICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50Lmluc3RhbmNlLmNsb3NlZC5zdWJzY3JpYmUoKCkgPT4gdGhpcy5kZXN0cm95TW9kYWwoKSk7XG4gICAgdGhpcy5odHRwSW50ZXJjZXB0b3JEZXRhaWxDb21wb25lbnQuaW5zdGFuY2Uub3BlbigpO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95TW9kYWwoKSB7XG4gICAgaWYgKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KSB7XG4gICAgICB0aGlzLmNvbXBvbmVudEluamVjdG9yLmRlc3Ryb3lDb21wb25lbnRJbkFwcGxpY2F0aW9uKHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KTtcbiAgICAgIHRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50ID0gdW5kZWZpbmVkO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgaGFzTWVzc2FnZShyZXNwb25zZU1lc3NhZ2U6IFBvSHR0cEludGVyY2VwdG9yRGV0YWlsKSB7XG4gICAgY29uc3QgaGFzTWVzc2FnZVByb3BlcnRpZXMgPSByZXNwb25zZU1lc3NhZ2UubWVzc2FnZTtcblxuICAgIHJldHVybiByZXNwb25zZU1lc3NhZ2UgJiYgaGFzTWVzc2FnZVByb3BlcnRpZXM7XG4gIH1cblxuICBwcml2YXRlIGhhc05vRXJyb3JQYXJhbShyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KTogYm9vbGVhbiB7XG4gICAgY29uc3Qgbm9FcnJvclBhcmFtID0gcmVxdWVzdCAmJiByZXF1ZXN0LmhlYWRlcnMuZ2V0KE5PX0VSUk9SX0hFQURFUl9QQVJBTSk7XG5cbiAgICByZXR1cm4gbm9FcnJvclBhcmFtICYmIG5vRXJyb3JQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIHByaXZhdGUgaGFzTm9NZXNzYWdlUGFyYW0ocmVxdWVzdDogSHR0cFJlcXVlc3Q8YW55Pik6IGJvb2xlYW4ge1xuICAgIGNvbnN0IG5vTWVzc2FnZVBhcmFtID0gcmVxdWVzdCAmJiByZXF1ZXN0LmhlYWRlcnMuZ2V0KE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcblxuICAgIHJldHVybiBub01lc3NhZ2VQYXJhbSAmJiBub01lc3NhZ2VQYXJhbS50b1N0cmluZygpLnRvTG9jYWxlTG93ZXJDYXNlKCkgPT09ICd0cnVlJztcbiAgfVxuXG4gIHByaXZhdGUgaGFzUGFyYW1ldGVycyhyZXF1ZXN0OiBIdHRwUmVxdWVzdDxhbnk+KSB7XG4gICAgcmV0dXJuIHJlcXVlc3QuaGVhZGVycy5oYXMoTk9fRVJST1JfSEVBREVSX1BBUkFNKSB8fCByZXF1ZXN0LmhlYWRlcnMuaGFzKE5PX01FU1NBR0VfSEVBREVSX1BBUkFNKTtcbiAgfVxuXG4gIHByaXZhdGUgc2hvd05vdGlmaWNhdGlvbihyZXNwb25zZTogYW55KSB7XG4gICAgaWYgKCF0aGlzLmhhc01lc3NhZ2UocmVzcG9uc2UpKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgdHlwZU5vdGlmaWNhdGlvbiA9IHRoaXMubm90aWZpY2F0aW9uVHlwZXMuaW5jbHVkZXMocmVzcG9uc2UudHlwZSkgPyByZXNwb25zZS50eXBlIDogJ2luZm9ybWF0aW9uJztcblxuICAgIGNvbnN0IG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVOb3RpZmljYXRpb25BY3Rpb24ocmVzcG9uc2UpO1xuXG4gICAgdGhpcy5ub3RpZmljYXRpb25bdHlwZU5vdGlmaWNhdGlvbl0oe1xuICAgICAgbWVzc2FnZTogcmVzcG9uc2UubWVzc2FnZSxcbiAgICAgIGFjdGlvbkxhYmVsOiBub3RpZmljYXRpb25BY3Rpb24ubGFiZWwsXG4gICAgICBhY3Rpb246IG5vdGlmaWNhdGlvbkFjdGlvbi5hY3Rpb25cbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVEZXRhaWxNb2RhbChyZXNwb25zZU1lc3NhZ2U6IGFueSkge1xuICAgIHJldHVybiAoKSA9PiB7XG4gICAgICBpZiAoIXRoaXMuaHR0cEludGVyY2VwdG9yRGV0YWlsQ29tcG9uZW50KSB7XG4gICAgICAgIHRoaXMuY3JlYXRlTW9kYWwocmVzcG9uc2VNZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG5cbiAgcHJpdmF0ZSBnZW5lcmF0ZU5vdGlmaWNhdGlvbkFjdGlvbihyZXNwb25zZU1lc3NhZ2U6IGFueSkge1xuICAgIGxldCBub3RpZmljYXRpb25BY3Rpb247XG4gICAgbGV0IG5vdGlmaWNhdGlvbkxhYmVsO1xuXG4gICAgaWYgKHJlc3BvbnNlTWVzc2FnZS5oZWxwVXJsICYmICEocmVzcG9uc2VNZXNzYWdlLmRldGFpbGVkTWVzc2FnZSB8fCByZXNwb25zZU1lc3NhZ2UuZGV0YWlscykpIHtcbiAgICAgIG5vdGlmaWNhdGlvbkxhYmVsID0gJ0FqdWRhJztcbiAgICAgIG5vdGlmaWNhdGlvbkFjdGlvbiA9IHRoaXMuZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24ocmVzcG9uc2VNZXNzYWdlLmhlbHBVcmwpO1xuICAgIH0gZWxzZSBpZiAocmVzcG9uc2VNZXNzYWdlLmRldGFpbGVkTWVzc2FnZSB8fCByZXNwb25zZU1lc3NhZ2UuZGV0YWlscykge1xuICAgICAgbm90aWZpY2F0aW9uTGFiZWwgPSAnRGV0YWxoZXMnO1xuICAgICAgbm90aWZpY2F0aW9uQWN0aW9uID0gdGhpcy5nZW5lcmF0ZURldGFpbE1vZGFsKHJlc3BvbnNlTWVzc2FnZSk7XG4gICAgfVxuICAgIHJldHVybiB7IGxhYmVsOiBub3RpZmljYXRpb25MYWJlbCwgYWN0aW9uOiBub3RpZmljYXRpb25BY3Rpb24gfTtcbiAgfVxuXG4gIHByaXZhdGUgZ2VuZXJhdGVVcmxIZWxwRnVuY3Rpb24oaGVscFVybDogc3RyaW5nKSB7XG4gICAgcmV0dXJuICgpID0+IHtcbiAgICAgIHdpbmRvdy5vcGVuKGhlbHBVcmwsICdfYmxhbmsnKTtcbiAgICB9O1xuICB9XG59XG4iXX0=